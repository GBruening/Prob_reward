---
title: "Prob_RWD_exp"
author: "Garrick Bruening"
output:
  bookdown::html_document2:
    toc: true
  bookdown::pdf_document2: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(ggthemes)
library(lmtest)
library(tidyr)
library(dplyr)
library(multcomp)
library(lme4)
library(nlstools)
library(knitr)
library("RColorBrewer")
library(wesanderson)
library(extrafont)
library(cowplot)
library(latex2exp)
library('R.matlab')
library(boot)
library(viridis)
library(english)

gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

#+====================== Load Fonts ================
# font_import()
loadfonts(device='win')

theme_set(theme_classic(base_family = "Times")+
            theme(text = element_text(color='black'),
                  axis.text.x = element_text(color='black'),
                  axis.text.y = element_text(color='black'),
                  axis.ticks  = element_line(color='black'),
                  axis.line = element_line(color='black',linetype='solid'),
                  plot.title = element_text(hjust = 0.5)))

# # Set these lines to the base directory of the experiment.
# main_folder = 'C:/Users/drapu/Documents/GitHub/Prob_reward'
main_folder = 'D:/Google Drive/Yan Experiment/code'
setwd(main_folder)

exp_name = '4t_180trial_4block'
# setwd(exp_name)
raw_data = read.csv(paste('vigor_conf_',exp_name,'.csv',sep=''))

raw_data$vigor = 1/(raw_data$react_time+raw_data$move_dur)
raw_data$total_dur = raw_data$react_time+raw_data$move_dur
raw_data$PeakVinout = raw_data$peak_vel - raw_data$peak_vel_moveback

#====================== Filter and add Probs ================
rm_fail_data = raw_data[raw_data$rewarded != -1,]
famil_data = filter(rm_fail_data,trial<=16)
prefilt_data = filter(rm_fail_data,trial<=(16+36))

non_famil_data = rm_fail_data[rm_fail_data$trial >= 17,]

trials = c()
counter = 1
subj = 1
for (k in 1:length(non_famil_data$trial)){
  if (non_famil_data[k,]$subj!=subj){
    counter = 1
    subj = non_famil_data[k,]$subj
  }
  trials = c(trials,counter)
  if (non_famil_data[k,'diff_prob']>0){
    non_famil_data[k,'diff_prob'] = non_famil_data[k,'diff_prob']-.01
  }
  counter = counter + 1
}
non_famil_data$trial_in_block= (trials-1)%%180+1

blocks = c()
probs = c()
counter = 1
subj = 1
block = 1

block_prob = matrix(c(1,.66,.33,0,.33,0,1,.66,0,1,.66,.33,.66,.33,0,1),
                    nrow = 4,
                    byrow = TRUE)

for (k in 1:length(non_famil_data$trial)){
  if (non_famil_data[k,]$subj!=subj){
    subj = non_famil_data[k,]$subj
    block = 1
  }
  blocks = c(blocks,block)
  probs = c(probs,block_prob[block,non_famil_data[k,]$target])
  if (non_famil_data[k,]$trial_in_block == 180){
    block = block + 1
  }
}
non_famil_data$probs = round(probs,2)
non_famil_data$block = blocks
non_famil_data = filter(non_famil_data, r_prob == probs)

# ==================== Renaming =================
dan_names = c('Subject',
              'Trial',
              'Block',
              'Prior_RWD',
              'Target',
              'Probability',
              'Vigor',
              'Duration',
              'TotalDur',
              'PeakV',
              'ReturnPeakV',
              'RT',
              'RWD',
              'Error_Dist',
              'Error_Ang',
              'Ret_Error',
              'Max_Ex',
              'Trial_in_Block',
              'Target_num',
              'NRWD_Run',
              'RPE')

gary_names = c('subj',
               'trial',
               'block',
               'one_back_rate',
               'target',
               'probs',
               'vigor',
               'move_dur',
               'total_dur',
               'peak_vel',
               'peak_vel_moveback',
               'react_time',
               'rewarded',
               'error_dist',
               'error_angle',
               'move_back_error',
               'maxex',
               'trial_in_block',
               'target_num',
               't_since_reward',
               'diff_prob')

k = 0
for (dan_name in dan_names){
  k = k+1
  names(non_famil_data)[names(non_famil_data) == gary_names[k]] <- dan_name
}
names(non_famil_data)[names(non_famil_data) == 'react_vel'] <- 'RT_vel'

#====================== Create Data Frame Variable Names ================
testable_vars_abs = c('Vigor',
                      'TotalDur',
                      'Duration',
                      'PeakV',
                      'ReturnPeakV',
                      'RT',
                      'RT_vel',
                      'Error_Dist',
                      'Error_Ang',
                      'Ret_Error',
                      'Max_Ex',
                      'PeakVinout')

testable_labels_abs = c('Vigor (???)',
                        'Total Duration (s)',
                        'Movement Duration (s)',
                        'Peak Velocity (m/s)',
                        'Peak Velocity Moveback (m/s)',
                        'Reaction time (s)',
                        'Reaction Velocity (m/s)',
                        'Error Distance (m)',
                        'Error Angle (deg)',
                        'Return Error (m)',
                        'Maximum Excursion (m)',
                        'Peak Velocity (Out - in) (m/s)')

testable_vars_norm = c('NormVigor',
                       'NormTotalDur',
                       'NormDuration',
                       'NormPeakV',
                       'NormReturnPeakV',
                       'NormRT',
                       'NormRT_vel',
                       'NormError_Dist',
                       'NormError_Ang',
                       'NormRet_Error',
                       'NormMax_Ex',
                       'NormPeakVinout')

testable_labels_norm = c('Vigor Norm (???)',
                         'Total Duration Norm (s)',
                         'Movement Duration Norm (s)',
                         'Peak Velocity Norm (m/s)',
                         'Peak Velocity Moveback Norm (m/s)',
                         'Reaction time Norm (s)',
                         'Reaction Velocity Norm (m/s)',
                         'Error Distance Norm (m)',
                         'Error Angle Norm (deg)',
                         'Return Error Norm (m)',
                         'Maximum Excursion Norm (m)',
                        'Peak Velocity (Out - in) Norm (m/s)')

testable_vars_diff = c('DeltaVigor',
                       'DeltaTotalDur',
                       'DeltaDuration',
                       'DeltaPeakV',
                       'DeltaReturnPeakV',
                       'DeltaRT',
                       'DeltaRT_vel',
                       'DeltaError_Dist',
                       'DeltaError_Ang',
                       'DeltaRet_Error',
                       'DeltaMax_Ex',
                       'DeltaPeakVinout')

testable_labels_diff = c('Vigor Delta (???)',
                         'Total Duration Delta (s)',
                         'Movement Duration Delta (s)',
                         'Peak Velocity Delta (m/s)',
                         'Peak Velocity Moveback Delta (m/s)',
                         'Reaction time Delta (s)',
                         'Reaction Velocity Delta (m/s)',
                         'Error Distance Delta (m)',
                         'Error Angle Delta (deg)',
                         'Return Error Delta (m)',
                         'Maximum Excursion Delta (m)',
                        'Peak Velocity (Out - in) Delta (m/s)')

# CHECK RADIAL VELOCITY?
#====================== Add Normalization ================
# Add Normalization to Not Filtered data.

add_norm_diff_func <- function(data, item){
  data[,paste('Norm',item,sep='')] = 0
  data[,paste('Delta',item,sep='')] = 0
  item_norm = paste('Norm',item,sep='')
  item_diff = paste('Delta',item,sep='')
  
  for (Subject_num in unique(data$Subject)){
    mean_0 = mean(data[data$r_prob==0 & data$Subject == Subject_num,item])
    
    data[data$Subject == Subject_num, item_norm] <- data[data$Subject == Subject_num, item]/mean_0
    data[data$Subject == Subject_num, item_diff] <- data[data$Subject == Subject_num, item]-mean_0
  }
  return(data)
}

for (item in testable_vars_abs){
  non_famil_data <- add_norm_diff_func(non_famil_data,item)
}

# Init some lists
ano_res <- list()
ano14 <- list()
lme_test <- list()
lme_test_t14 <- list()

# ============ Add Prior Trial Differences ========
prior_trial_vars = c('Probability',
                     'PeakV',
                     'NormPeakV',
                     'DeltaPeakV',
                     'RT',
                     'Max_Ex',
                     'Duration',
                     'TotalDur',
                     'Vigor',
                     'ReturnPeakV',
                     'PeakVinout')
for (k in 1:length(non_famil_data$Subject)){
  for (item in prior_trial_vars){
    if (non_famil_data[k,'Trial_in_Block'] == 1){
      non_famil_data[k,paste('DiffPrior_',item,sep='')] = 0
    } else {
      non_famil_data[k,paste('DiffPrior_',item,sep='')] = round(as.numeric(non_famil_data[k,item]-non_famil_data[k-1,item]),2)
    }
  }
}
non_famil_data[non_famil_data$DiffPrior_Prob == -0.67, 'DiffPrior_Probability'] = non_famil_data[non_famil_data$DiffPrior_Prob == -0.67, 'DiffPrior_Probability']+0.01
non_famil_data[non_famil_data$DiffPrior_Prob == -0.34, 'DiffPrior_Probability'] = non_famil_data[non_famil_data$DiffPrior_Prob == -0.34, 'DiffPrior_Probability']+0.01
non_famil_data[non_famil_data$DiffPrior_Prob == 0.67, 'DiffPrior_Probability'] = non_famil_data[non_famil_data$DiffPrior_Prob == 0.67, 'DiffPrior_Probability']-0.01
non_famil_data[non_famil_data$DiffPrior_Prob == 0.34, 'DiffPrior_Probability'] = non_famil_data[non_famil_data$DiffPrior_Prob == 0.34, 'DiffPrior_Probability']-0.01


prior_RPE = c()
for (k in 1:length(non_famil_data$Subject)){
  if (non_famil_data[k,'Trial_in_Block'] == 1){
    non_famil_data[k,'prior_RPE'] = 0
  } else {
    non_famil_data[k,'prior_RPE'] = round(as.numeric(non_famil_data[k-1,'RPE']),2)
  }
}

add_n_back <- function(data,n_back){
  data[1,paste(as.english(n_back),'_back_rate',sep='')] = 0
  data[1,paste(as.english(n_back),'_back_rate_tar',sep='')] = 0
  for (k in 1:length(data[,'Subject'])){
    subject = data[k,'Subject']
    block = data[k,'Block']
    cur_tar = data[k,'Target']
    cur_trial = data[k,'Trial_in_Block']
    
    rate = 0
    tar_rate = 0
    nb = 0
    last_back = cur_trial-n_back
    
    if (last_back <= 0){
      last_back = 1
    }
    if(cur_trial == 1){
      rate = 0
      tar_rate = 0
    } else {
      for (j in (cur_trial-1):last_back){
        nb = nb + 1
        rate = rate + (.5^(nb))*data[data[,'Subject'] == subject & data[,'Block'] == block & data[,'Trial_in_Block'] == j,'RWD']
        
        if (data[j,'Target'] == cur_tar){
          tar_rate = tar_rate + (.5^(nb))*data[j,'RWD']
        } else{
          tar_rate = tar_rate + (.25^(nb))*data[j,'RWD']
        }
      }
    }
    data[k,paste(as.english(n_back),'_back_rate',sep='')] = rate
    data[k,paste(as.english(n_back),'_back_rate_tar',sep='')] = tar_rate
  }
  return(data)
}

for (n_back in c(1)){#},3,5,10)){
  non_famil_data <- add_n_back(non_famil_data,n_back)
}
non_famil_data$one_back_rate <- non_famil_data$one_back_rate*2
non_famil_data$Prior_RWD <- non_famil_data$one_back_rate

#====================== Plotting Function ================
Prob_plotting <- function(data,
                          prob_method = 'Probability',
                          plot_var,
                          var_lab,
                          plot_type = 'nv',
                          Prior_RWD = 'Prior_RWD',
                          title_lab = 'Null',
                          titles = 'Null',
                          rpe_split = 'Probability'){

  plotting_data = data[,c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability',prob_method,plot_var)]
  colnames(plotting_data) = c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability','probability_metric', 'plot_var')
  
  if (prob_method == 'prior_RPE' || prob_method == 'RPE'){
    if (prob_method == 'prior_RPE'){
    lme_test <- cftest(lmer(plot_var ~ probability_metric*Prior_RWD + (1|Subject), data = plotting_data))
    lme_test_t14 <- cftest(lmer(plot_var ~ probability_metric*Prior_RWD + (1|Subject), 
                                data = rbind(filter(plotting_data,probability_metric==1),
                                             filter(plotting_data,probability_metric==0))))
    
    lme_test_Prior1 <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), 
                                   data = filter(plotting_data,Prior_RWD==1)))
    lme_test_Prior0 <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), 
                                   data = filter(plotting_data,Prior_RWD==0)))
      
    } else {
      lme_test <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), data = plotting_data))
      lme_test_t14 <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), 
                                  data = rbind(filter(plotting_data,probability_metric==1),
                                               filter(plotting_data,probability_metric==0))))
      
      lme_test_Prior1 <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), 
                                     data = filter(plotting_data,RWD==1)))
      lme_test_Prior0 <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), 
                                     data = filter(plotting_data,RWD==0)))
    }
    
    if (rpe_split == 'Probability'){
      #============= No Facet Abs
      a1 = aggregate(plot_var ~ probability_metric + Prior_RWD + Probability + Subject, plotting_data,mean)
      a  = aggregate(plot_var ~ probability_metric + Prior_RWD + Probability,a1,mean)
      b  = aggregate(plot_var ~ probability_metric + Prior_RWD + Probability,a1,sd)/sqrt(max(a1$Subject))#/sqrt(length(plotting_data[,1]))
      c  = cbind(a,b$plot_var)
      colnames(c) = c('probability_metric','Prior_RWD','Probability','plot_var','plot_var_se')
      
      g<-ggplot(data = c,
                aes(x = probability_metric,
                    y = plot_var,
                    color = factor(Probability),
                    group = factor(Probability)))+
        geom_point(data = filter(c,Prior_RWD == 0),
                   aes(x = probability_metric,
                       y = plot_var,
                       group = factor(Probability),
                       color = factor(Probability),
                       shape = factor(Prior_RWD)),
                   size = 5,
                   position = position_dodge(width = .2))+
        geom_line(data = filter(c,Prior_RWD == 0),
                  aes(x = probability_metric,
                      y = plot_var,
                      group = factor(Probability),
                      color = factor(Probability)),
                  size = 1,
                  position = position_dodge(width = .2))+
        geom_errorbar(data=filter(c,Prior_RWD == 0),
                      aes(x = probability_metric,
                          ymin = plot_var-plot_var_se,
                          ymax = plot_var+plot_var_se,
                          group = factor(Probability),
                          color = factor(Probability)),
                      size = 1,
                      width = .2,
                      position = position_dodge(width = .2))+
        geom_point(data = filter(c,Prior_RWD == 1),
                   aes(x = probability_metric,
                       y = plot_var,
                       group = factor(Probability),
                       color = factor(Probability),
                      shape = factor(Prior_RWD)),
                   size = 5,
                   position = position_dodge(width = .2))+
        geom_line(data = filter(c,Prior_RWD == 1),
                  aes(x = probability_metric,
                      y = plot_var,
                      group = factor(Probability),
                      color = factor(Probability)),
                  size = 1,
                  position = position_dodge(width = .2))+
        geom_errorbar(data = filter(c,Prior_RWD == 1),
                      aes(x = probability_metric,
                          ymin = plot_var-plot_var_se,
                          ymax = plot_var+plot_var_se,
                          group = factor(Probability),
                          color = factor(Probability)),
                      size = 1,
                      width = .2,
                      position = position_dodge(width = .2))+
        scale_shape_manual(values = c(16,15), labels = c('0','1'))+
        labs(x = 'Reward Prediction Error (RPE)',
             y = var_lab,
             color = 'Current Target\nProbability',
             shape = 'Prior\nReward')+
        geom_hline(yintercept = mean(filter(plotting_data,probability_metric == 0)$plot_var),linetype='dashed',size=.5)
      
      
        ret_list <- list('lm' = lme_test,
                         'plot' = g)
        if (exists('lme_test_t14')){
          ret_list[['lm14']] = lme_test_t14
        }
        if (exists('ano14')){
          ret_list[['ano14']] = ano14
        }
        if (exists('lme_test_Prior1')){
          ret_list[['lme_test_Prior1']] = lme_test_Prior1
        }
        if (exists('lme_test_Prior0')){
          ret_list[['lme_test_Prior0']] = lme_test_Prior0
        }
        return(ret_list)
    } else if (rpe_split == 'Prior_RWD') {
      #============= No Facet Abs
      a1 = aggregate(plot_var ~ probability_metric + Prior_RWD  + Subject, plotting_data,mean)
      a  = aggregate(plot_var ~ probability_metric + Prior_RWD ,a1,mean)
      b  = aggregate(plot_var ~ probability_metric + Prior_RWD ,a1,sd)/sqrt(max(a1$Subject))#/sqrt(length(plotting_data[,1]))
      c  = cbind(a,b$plot_var)
      colnames(c) = c('probability_metric','Prior_RWD','plot_var','plot_var_se')
      
      g<-ggplot(data = c,
                aes(x = probability_metric,
                    y = plot_var))+
        geom_point(data = c,
                   aes(x = probability_metric,
                       y = plot_var,
                       color = factor(Prior_RWD),
                       group = factor(Prior_RWD)),
                   size = 5,
                   position = position_dodge(width = .2))+
        geom_line(data = c,
                  aes(x = probability_metric,
                      y = plot_var,
                       color = factor(Prior_RWD),
                       group = factor(Prior_RWD)),
                  size = 1,
                  position = position_dodge(width = .2))+
        geom_errorbar(data=c,
                      aes(x = probability_metric,
                          ymin = plot_var-plot_var_se,
                          ymax = plot_var+plot_var_se,
                       color = factor(Prior_RWD),
                       group = factor(Prior_RWD)),
                      size = 1,
                      width = .2,
                      position = position_dodge(width = .2))+
        scale_shape_manual(values = c(16,15), labels = c('0','1'))+
        labs(x = 'Reward Prediction Error (RPE)',
             y = var_lab,
             color = 'Current Target\nProbability',
             shape = 'Prior\nReward')+
        geom_hline(yintercept = mean(filter(plotting_data,probability_metric == 0)$plot_var),linetype='dashed',size=.5)
      
      
        ret_list <- list('lm' = lme_test,
                         'plot' = g)
        if (exists('lme_test_t14')){
          ret_list[['lm14']] = lme_test_t14
        }
        if (exists('ano14')){
          ret_list[['ano14']] = ano14
        }
        if (exists('lme_test_Prior1')){
          ret_list[['lme_test_Prior1']] = lme_test_Prior1
        }
        if (exists('lme_test_Prior0')){
          ret_list[['lme_test_Prior0']] = lme_test_Prior0
        }
        return(ret_list)
    } else {
      #============= No Facet Abs
      a1 = aggregate(plot_var ~ probability_metric + Subject, plotting_data,mean)
      a  = aggregate(plot_var ~ probability_metric,a1,mean)
      b  = aggregate(plot_var ~ probability_metric,a1,sd)/sqrt(max(a1$Subject))#/sqrt(length(plotting_data[,1]))
      c  = cbind(a,b$plot_var)
      colnames(c) = c('probability_metric','plot_var','plot_var_se')
      
      g<-ggplot(data = c,
                aes(x = probability_metric,
                    y = plot_var))+
        geom_point(data = c,
                   aes(x = probability_metric,
                       y = plot_var),
                   size = 5,
                   position = position_dodge(width = .2))+
        geom_line(data = c,
                  aes(x = probability_metric,
                      y = plot_var),
                  size = 1,
                  position = position_dodge(width = .2))+
        geom_errorbar(data=c,
                      aes(x = probability_metric,
                          ymin = plot_var-plot_var_se,
                          ymax = plot_var+plot_var_se),
                      size = 1,
                      width = .2,
                      position = position_dodge(width = .2))+
        scale_shape_manual(values = c(16,15), labels = c('0','1'))+
        labs(x = 'Reward Prediction Error (RPE)',
             y = var_lab)+
        geom_hline(yintercept = mean(filter(plotting_data,probability_metric == 0)$plot_var),linetype='dashed',size=.5)
      
      
        ret_list <- list('lm' = lme_test,
                         'plot' = g)
        if (exists('lme_test_t14')){
          ret_list[['lm14']] = lme_test_t14
        }
        if (exists('ano14')){
          ret_list[['ano14']] = ano14
        }
        if (exists('lme_test_Prior1')){
          ret_list[['lme_test_Prior1']] = lme_test_Prior1
        }
        if (exists('lme_test_Prior0')){
          ret_list[['lme_test_Prior0']] = lme_test_Prior0
        }
        return(ret_list)
    }
  }
  
  # if (prob_method == 'RPE'){
  #   
  #   lme_test <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), data = plotting_data))
  #   lme_test_t14 <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), 
  #                               data = rbind(filter(plotting_data,probability_metric==1),
  #                                            filter(plotting_data,probability_metric==0))))
  #   
  #   lme_test_Prior1 <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), 
  #                                  data = filter(plotting_data,RWD==1)))
  #   lme_test_Prior0 <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), 
  #                                  data = filter(plotting_data,RWD==0)))
  #   
  #   #============= No Facet Abs
  #   a1 = aggregate(plot_var ~ probability_metric + RWD + Probability + Subject, plotting_data,mean)
  #   a  = aggregate(plot_var ~ probability_metric + RWD + Probability,a1,mean)
  #   b  = aggregate(plot_var ~ probability_metric + RWD + Probability,a1,sd)/sqrt(max(a1$Subject))#/sqrt(length(plotting_data[,1]))
  #   c  = cbind(a,b$plot_var)
  #   colnames(c) = c('probability_metric','RWD','Probability','plot_var','plot_var_se')
  #   
  #   g<-ggplot(data = c,
  #             aes(x = probability_metric,
  #                 y = plot_var,
  #                 color = factor(Probability),
  #                 group = factor(Probability)))+
  #     geom_point(data = filter(c,RWD == 0),
  #                aes(x = probability_metric,
  #                    y = plot_var,
  #                    group = factor(Probability),
  #                    color = factor(Probability),
  #                    shape = factor(RWD)),
  #                size = 5,
  #                position = position_dodge(width = .2))+
  #     geom_line(data = filter(c,RWD == 0),
  #               aes(x = probability_metric,
  #                   y = plot_var,
  #                   group = factor(Probability),
  #                   color = factor(Probability)),
  #               size = 1,
  #               position = position_dodge(width = .2))+
  #     geom_errorbar(data=filter(c,RWD == 0),
  #                   aes(x = probability_metric,
  #                       ymin = plot_var-plot_var_se,
  #                       ymax = plot_var+plot_var_se,
  #                       group = factor(Probability),
  #                       color = factor(Probability)),
  #                   size = 1,
  #                   width = .2,
  #                   position = position_dodge(width = .2))+
  #     geom_point(data = filter(c,RWD == 1),
  #                aes(x = probability_metric,
  #                    y = plot_var,
  #                    group = factor(Probability),
  #                    color = factor(Probability),
  #                    shape = factor(RWD)),
  #                size = 5,
  #                position = position_dodge(width = .2))+
  #     geom_line(data = filter(c,RWD == 1),
  #               aes(x = probability_metric,
  #                   y = plot_var,
  #                   group = factor(Probability),
  #                   color = factor(Probability)),
  #               size = 1,
  #               position = position_dodge(width = .2))+
  #     geom_errorbar(data = filter(c,RWD == 1),
  #                   aes(x = probability_metric,
  #                       ymin = plot_var-plot_var_se,
  #                       ymax = plot_var+plot_var_se,
  #                       group = factor(Probability),
  #                       color = factor(Probability)),
  #                   size = 1,
  #                   width = .2,
  #                   position = position_dodge(width = .2))+
  #     scale_shape_manual(values = c(16,15), labels = c('0','1'))+
  #     labs(x = 'Reward Prediction Error (RPE)',
  #          y = var_lab,
  #          color = 'Current Target\nProbability',
  #          shape = 'Prior\nReward')
  #   
  #   
  #   ret_list <- list('lm' = lme_test,
  #                    'plot' = g)
  #   if (exists('lme_test_t14')){
  #     ret_list[['lm14']] = lme_test_t14
  #   }
  #   if (exists('ano14')){
  #     ret_list[['ano14']] = ano14
  #   }
  #   if (exists('lme_test_Prior1')){
  #     ret_list[['lme_test_Prior1']] = lme_test_Prior1
  #   }
  #   if (exists('lme_test_Prior0')){
  #     ret_list[['lme_test_Prior0']] = lme_test_Prior0
  #   }
  #   return(ret_list)
  # }
  
  if (Prior_RWD == 'Prior_RWD'){
    
    lme_test <- cftest(lmer(plot_var ~ probability_metric*Prior_RWD + (1|Subject), data = plotting_data))
    lme_test_t14 <- cftest(lmer(plot_var ~ probability_metric*Prior_RWD + (1|Subject), 
                                data = rbind(filter(plotting_data,probability_metric==1),
                                             filter(plotting_data,probability_metric==0))))
    
    #============= No Facet Abs
    a1 = aggregate(plot_var ~ probability_metric + Prior_RWD + Subject, plotting_data,mean)
    a  = aggregate(plot_var ~ probability_metric + Prior_RWD ,a1,mean)
    b  = aggregate(plot_var ~ probability_metric + Prior_RWD ,a1,sd)/sqrt(max(a1$Subject))#/sqrt(length(plotting_data[,1]))
    c  = cbind(a,b$plot_var)
    colnames(c) = c('probability_metric','Prior_RWD','plot_var','plot_var_se')
    
    if (plot_type == 'bar'){
      
      df_subj = aggregate(plot_var ~ Prior_RWD + Subject, plotting_data, mean)
      df2_mean = aggregate(plot_var ~ Prior_RWD, df_subj, mean)
      df2_sd   = aggregate(plot_var ~ Prior_RWD, df_subj, sd)/sqrt(max(df_subj$Subject))
      df2 = cbind(df2_mean,df2_sd$plot_var)
      colnames(df2) <- c('Prior_RWD','plot_var','plot_var_se')
      
      lme_test = cftest(lmer(plot_var ~ Prior_RWD + (1|Subject), df_subj))
      ano14 = anova(lm(plot_var ~ Prior_RWD+(1|Subject), df_subj))
      t_test = t.test(df_subj[df_subj$Prior_RWD == 0,'plot_var'], df_subj[df_subj$Prior_RWD == 1,'plot_var'], paired = TRUE)
      t_test0 = t.test(df_subj[df_subj$Prior_RWD == 0,'plot_var'])
      t_test1 = t.test(df_subj[df_subj$Prior_RWD == 1,'plot_var'])
      
      g <- ggplot()+
        geom_bar(data = df2,
                 aes(x = Prior_RWD,
                     y = plot_var,
                     fill = factor(Prior_RWD)),
                 position = 'dodge',
                 stat = 'identity')+
        geom_errorbar(data = df2,
                      aes(x = Prior_RWD,
                          ymin = plot_var-plot_var_se,
                          ymax = plot_var+plot_var_se),
                      width = 0.5,
                      size = 2)+
        geom_line(data = df_subj,
                  aes(x = Prior_RWD,
                      y = plot_var,
                      group = Subject))+
        labs(x = 'Prior Reward',
             y = var_lab,
             fill = 'Prior\nReward',
             title = paste('LMER P-Values.\nPrior RWD: ',
                           formatC(lme_test$test$pvalues[2],format="e",digits = 3),
                           '\nSlope: ',
                           formatC(lme_test$test$coefficients[2],format="e",digits = 3)))
      ret_list <- list('lm' = lme_test,'plot' = g, 't_test' = t_test, 'ano14' = ano14, 't_test0' = t_test0, 't_test1' = t_test1)
      return(ret_list)
      
    } else {
      
      lme_test <- cftest(lmer(plot_var ~ probability_metric*Prior_RWD + (1|Subject), data = plotting_data))
      lme_test_t14 <- cftest(lmer(plot_var ~ probability_metric*Prior_RWD + (1|Subject), 
                                  data = rbind(filter(plotting_data,probability_metric==1),
                                               filter(plotting_data,probability_metric==0))))
      
      lme_test_Prior1 <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), 
                                     data = filter(plotting_data,Prior_RWD==1)))
      lme_test_Prior0 <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), 
                                     data = filter(plotting_data,Prior_RWD==0)))
      
      #============= No Facet Abs
      a1 = aggregate(plot_var ~ probability_metric + Prior_RWD + Subject ,plotting_data,mean)
      a  = aggregate(plot_var ~ probability_metric + Prior_RWD ,a1,mean)
      b  = aggregate(plot_var ~ probability_metric + Prior_RWD ,a1,sd)/sqrt(max(a1$Subject))#/sqrt(length(plotting_data[,1]))
      c  = cbind(a,b$plot_var)
      colnames(c) = c('probability_metric','Prior_RWD','plot_var','plot_var_se')
      
      g<-ggplot(data = c,
                aes(x = factor(probability_metric),
                    y = plot_var,
                    color = factor(Prior_RWD),
                    group = factor(Prior_RWD)))+
        geom_point(data = c,
                   aes(x = factor(probability_metric),
                       y = plot_var,
                       color = factor(Prior_RWD),
                       group = factor(Prior_RWD)),
                   size = 5,
                   position = position_dodge(width = .5))+
        geom_line(data=c,
                  aes(x = factor(probability_metric),
                      y = plot_var,
                      color = factor(Prior_RWD),
                      group = factor(Prior_RWD)),
                  size = 1,
                  position = position_dodge(width = .5))+
        geom_errorbar(data=c,
                      aes(x = factor(probability_metric),
                          ymin = plot_var-plot_var_se,
                          ymax = plot_var+plot_var_se,
                          color = factor(Prior_RWD)),
                      size = 1,
                      width = 1,
                      position = position_dodge(width = .5))+
        # geom_hline(yintercept = mean(filter(plotting_data,probability_metric == 0)$plot_var),linetype='dashed',size=.5)+
        labs(x = 'Probability of Reward',
             y = var_lab,
             title = paste('LMER P-Values.\nProb Metric: ',
                           formatC(lme_test$test$pvalues[2],format="e",digits = 3),
                           ',\nPrior Rwd: ',
                           formatC(lme_test$test$pvalues[3],format="e",digits = 3),
                           ',\nInteraction: ',
                           formatC(lme_test$test$pvalues[4],format="e",digits = 3),
                           # , Slope: ',
                           # formatC(lme_test$test$coefficients[2],format="e",digits = 3),
                           # '\nOnly target 1/4: ',
                           # round(lme_test_t14$test$pvalues[2],digits = 4),
                           sep=''),
             color = 'Prior\nReward')#+theme(legend.position = 'none')
      if (prob_method == 'DiffPrior_Probability'){
        g <- g+labs(x = 'Probability difference from previous trial of reward')
      }
    }
  } else {
    plotting_data = data[,c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','NRWD_Run','Probability',prob_method,plot_var)]
    colnames(plotting_data) = c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','NRWD_Run','Probability','probability_metric', 'plot_var')
    
    
    lme_test = cftest(lmer(plot_var ~ probability_metric + (1|Subject), data = plotting_data))
    lme_test_t14 = cftest(lmer(plot_var ~ probability_metric + (1|Subject),
                                data = rbind(filter(plotting_data,Probability==1),
                                             filter(plotting_data,Probability==0))))
    
    plotting_data2 = aggregate(plot_var ~ Subject + Probability,plotting_data,mean)
    ano_res = anova(lm(plot_var ~ Probability + (1|Subject), data = plotting_data2))
    tukey_test = TukeyHSD(aov(plot_var ~ factor(Probability) + (1|Subject), data = plotting_data2))
    
    t_test_data = filter(plotting_data2, 
                         Probability == 0 | Probability == 1)
    ano14 = anova(lm(plot_var ~ Probability + (1|Subject),
                            data = t_test_data))
    
    ano14aov = summary(aov(plot_var ~ factor(Probability) + (1|Subject),
                            data = t_test_data))
    t_test = t.test(t_test_data[t_test_data$Probability == 0,'plot_var'],
                    t_test_data[t_test_data$Probability == 1,'plot_var'],
                    paired = TRUE)
    
    if (plot_type == 'violin'){
      #====================== Violin Plot ================
      # Violin Plots
      a = aggregate(plot_var ~ probability_metric ,plotting_data,mean)
      b = aggregate(plot_var ~ probability_metric ,plotting_data,sd)#/sqrt(length(plotting_data[,1]))
      c = cbind(a,b$plot_var)
      colnames(c) = c('probability_metric','plot_var','plot_var_sd')
      
      g <- ggplot(data=plotting_data,
                  aes(x = factor(probability_metric),
                      y = plot_var))+
        geom_violin(aes(fill = factor(probability_metric)))+
        geom_point(data=aggregate(plot_var~probability_metric,plotting_data,mean),
                   aes(x = factor(probability_metric),
                       y = plot_var),
                   size = 5)+
        geom_line(data=aggregate(plot_var~probability_metric,plotting_data,mean),
                  aes(x = factor(probability_metric),
                      y = plot_var),
                  group = 1,
                  size = 1)+
        geom_errorbar(data=c,
                      aes(x = factor(probability_metric),
                          ymin = plot_var-plot_var_sd,
                          ymax = plot_var+plot_var_sd),
                      size = 1,
                      width = 0)+
        geom_hline(yintercept = mean(filter(plotting_data,probability_metric == 0)$plot_var),linetype='dashed',size=.5)+
        labs(x = 'Probability of Reward',
             y = var_lab)+
        theme(legend.position = 'none')
      if (titles == 'TRUE'){
        g <- g+ labs(title = paste('LMER P-Value: ',
                           formatC(lme_test$test$pvalues[2],format="e",digits = 3),
                           ', Slope: ',
                           formatC(lme_test$test$coefficients[2],format="e",digits = 3),
                           '\nOnly Target 1/4: ',
                           round(lme_test_t14$test$pvalues[2],digits = 4),
                           sep=''))
      }
    } else if (plot_type == 'nv') {
      
      # Non-Violin Plot
      a1 = aggregate(plot_var ~ probability_metric + Subject,plotting_data,mean)
      a  = aggregate(plot_var ~ probability_metric ,a1,mean)
      b  = aggregate(plot_var ~ probability_metric ,a1,sd)/sqrt(max(a1$Subject))#/sqrt(length(plotting_data[,1]))
      c  = cbind(a,b$plot_var)
      colnames(c) = c('probability_metric','plot_var','plot_var_se')
      
      g <- ggplot(data=plotting_data,
                   aes(x = factor(probability_metric),
                       y = plot_var))+
        geom_point(data=aggregate(plot_var~probability_metric,plotting_data,mean),
                   aes(x = factor(probability_metric),
                       y = plot_var),
                   size = 5)+
        geom_line(data=aggregate(plot_var~probability_metric,plotting_data,mean),
                  aes(x = factor(probability_metric),
                      y = plot_var),
                  group = 1,
                  size = 1)+
        geom_errorbar(data=c,
                      aes(x = factor(probability_metric),
                          ymin = plot_var-plot_var_se,
                          ymax = plot_var+plot_var_se),
                      size = 1,
                      width = 0)+
        geom_hline(yintercept = mean(filter(plotting_data,probability_metric == 0)$plot_var),linetype='dashed',size=.5)+
        labs(x = 'Probability of Reward',
             y = var_lab)+
        theme(legend.position = 'none')
      if (titles == 'TRUE'){
        g <- g+ labs(title = paste('LMER P-Value: ',
                           formatC(lme_test$test$pvalues[2],format="e",digits = 3),
                           ', Slope: ',
                           formatC(lme_test$test$coefficients[2],format="e",digits = 3),
                           '\nOnly Target 1/4: ',
                           round(lme_test_t14$test$pvalues[2],digits = 4),
                           sep=''))
      }
      if (title_lab != 'Null'){
        g <- g+labs(title = title_lab)
      }
    }
  }
  if (prob_method == 'diff_prob'){
    g <- g+labs(x = 'Probability difference (P(t)-P(t-1))')
  }
  
  ret_list <- list('lm' = lme_test,
                   'plot' = g)
  if (exists('lme_test_t14')){
    ret_list[['lm14']] = lme_test_t14
  }
  if (exists('ano14')){
    ret_list[['ano14']] = ano14
  }
  if (exists('t_test')){
    ret_list[['t_test']] = t_test
  }
  if (exists('t_test0')){
    ret_list[['t_test0']] = t_test0
  }
  if (exists('t_test1')){
    ret_list[['t_test1']] = t_test1
  }
  if (exists('lme_test_Prior1')){
    ret_list[['lme_test_Prior1']] = lme_test_Prior1
  }
  if (exists('lme_test_Prior0')){
    ret_list[['lme_test_Prior0']] = lme_test_Prior0
  }
  if (exists('tukey_test')){
    ret_list[['tukey_test']] = tukey_test
  }
  
  return(ret_list)
}

trial_plotting <- function(data,
                           plot_var,
                           var_lab,
                           variable,
                           title_lab = 'Null',
                           titles = 'Null'){
  
  
  plotting_data = data[,c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability',plot_var)]
  colnames(plotting_data) = c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability', 'plot_var')
  
  lm = cftest(lmer(plot_var ~ Trial + (1|Subject),data = plotting_data))
  
  trial_p_val <- lm$test$pvalues[2]
  trial_slope <- lm$coef[2]
  if (trial_p_val<0.05){
    yesno = 'WAS'
    if (trial_slope>0){
      slope = ' INCREASED'
    } else {
      slope = ' DECREASED'
    }
  } else {
    yesno = 'WAS NOT'
    slope = 'DID NOT CHANGE'
  }
  trial_slope = formatC(trial_slope, digits = 3, format='e')
  trial_p_val = formatC(trial_p_val, digits = 3, format='e')
  trial_str = paste('Over the course of the experiment, ',variable,slope,' with each subsequent trial. This was tested using an LMER of the form: ',variable,' = B*Trial + (1|Subject). We found B = ',trial_slope,' and a p-value = ',trial_p_val,', and an intercept of ',formatC(lm$coef[1], digits = 3, format='e'),sep='')
  
  g <- ggplot()+
    geom_point(data = plotting_data,
               aes(x = Trial,
                   y = plot_var,
                   color = factor(Subject)),
               alpha = 0.2,
               shape = 16)+
    geom_smooth(data = plotting_data,
               aes(x = Trial,
                   y = plot_var,
                   color = factor(Subject)))+
    labs(x = 'Trial',
         y = var_lab,
         color = 'Subject')
  
  
  
  ret_list = list('plot' = g, 'lm' = lm, 'trial_str' = trial_str)
  
}

pvalue_table_func <- function(data, plot_var, prob_metric, Prior_RWD, targets = 'all'){
  
  if (Prior_RWD != 'Prior_RWD'){
    plotting_data = data[,c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','NRWD_Run','Probability',prob_metric,plot_var)]
    colnames(plotting_data) = c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','NRWD_Run','Probability','probability_metric', 'plot_var')
    
    lme_test = cftest(lmer(plot_var ~ probability_metric + (1|Subject), data = plotting_data))
    lme_test_t14 = cftest(lmer(plot_var ~ probability_metric + (1|Subject),
                                data = rbind(filter(plotting_data,Probability==1),
                                             filter(plotting_data,Probability==0))))
    
    anova_test = anova(lm(plot_var ~ probability_metric + (1|Subject), 
                          data = aggregate(plot_var~probability_metric + Subject, 
                                           data = rbind(filter(plotting_data, Probability==1),
                                                        filter(plotting_data, Probability==0)),
                                           mean)))
    
    lm_table <- rbind(c(formatC(lme_test$test$pvalues[2],format="e",digits = 3),
                        paste(formatC(lme_test$test$coefficients[2],format="e",digits = 3),'±',formatC(lme_test$test$sigma[2],format="e",digits = 3)),
                        formatC(lme_test$test$coefficients[1],format="e",digits = 3)),
                      c(formatC(lme_test_t14$test$pvalues[2],format="e",digits = 3),
                        paste(formatC(lme_test_t14$test$coefficients[2],format="e",digits = 3),'±',formatC(lme_test_t14$test$sigma[2],format="e",digits = 3)),
                        formatC(lme_test_t14$test$coefficients[1],format="e",digits = 3)),
                      c(formatC(anova_test$`Pr(>F)`[1],format='e',digits = 3),
                        paste('F val: ',formatC(anova_test$`F value`[1],format='e',digits = 3),sep=''),
                        ''))
    rownames(lm_table) <- c('All Target LMER','Target 1/4 LMER','Target 1/4 ANOVA')
    colnames(lm_table) <- c('P-Value','Slope','Intercept')
    return(lm_table)
    
  } else {
    
    plotting_data = data[,c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability',prob_metric,plot_var)]
    colnames(plotting_data) = c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability','probability_metric', 'plot_var')
    
    lme_test <- cftest(lmer(plot_var ~ probability_metric*Prior_RWD + (1|Subject), data = plotting_data))
    lme_test_t14 <- cftest(lmer(plot_var ~ probability_metric*Prior_RWD + (1|Subject), 
                                data = rbind(filter(plotting_data,probability_metric==1),
                                             filter(plotting_data,probability_metric==0))))
    
    anova_test = anova(lm(plot_var ~ probability_metric + (1|Subject), 
                          data = aggregate(plot_var~probability_metric + Subject, 
                                           data = rbind(filter(plotting_data, Probability==1),
                                                        filter(plotting_data, Probability==0)),
                                           mean)))
    
      
    lme_test_Prior0 <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), 
                                   data = filter(plotting_data,Prior_RWD==0)))
    lme_test_Prior1 <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), 
                                   data = filter(plotting_data,Prior_RWD==1)))
    
    lm_table <- rbind(c(formatC(lme_test$test$pvalues[1],format="e",digits = 3),
                        paste(formatC(lme_test$test$coefficients[1],format="e",digits = 3),'±',formatC(lme_test$test$sigma[1],format="e",digits = 3))),
                      c(formatC(lme_test$test$pvalues[2],format="e",digits = 3),
                        paste(formatC(lme_test$test$coefficients[2],format="e",digits = 3),'±',formatC(lme_test$test$sigma[2],format="e",digits = 3))),
                      c(formatC(lme_test$test$pvalues[3],format="e",digits = 3),
                        paste(formatC(lme_test$test$coefficients[3],format="e",digits = 3),'±',formatC(lme_test$test$sigma[3],format="e",digits = 3))),
                      c(formatC(lme_test$test$pvalues[4],format="e",digits = 3),
                        paste(formatC(lme_test$test$coefficients[4],format="e",digits = 3),'±',formatC(lme_test$test$sigma[4],format="e",digits = 3))),
                      c('',''),
                      c(formatC(lme_test_Prior1$test$pvalues[2],format="e",digits = 3),
                        paste(formatC(lme_test_Prior1$test$coefficients[2],format="e",digits = 3),'±',formatC(lme_test_Prior1$test$sigma[2],format="e",digits = 3))),
                      c(formatC(lme_test_Prior0$test$pvalues[2],format="e",digits = 3),
                        paste(formatC(lme_test_Prior0$test$coefficients[2],format="e",digits = 3),'±',formatC(lme_test_Prior0$test$sigma[2],format="e",digits = 3))))
    rownames(lm_table) <- c('Intercept','Prob Metric','Prior RWD','Interaction','','Lm Prior == 1 Prob Effect','LM Prior == 0 Prob Effect')
    colnames(lm_table) <- c('P-Value','Slope')
    
    lm14_table <- rbind(c(formatC(lme_test_t14$test$pvalues[1],format="e",digits = 3),
                          paste(formatC(lme_test_t14$test$coefficients[1],format="e",digits = 3),'±',formatC(lme_test_t14$test$sigma[1],format="e",digits = 3))),
                        c(formatC(lme_test_t14$test$pvalues[2],format="e",digits = 3),
                          paste(formatC(lme_test_t14$test$coefficients[2],format="e",digits = 3),'±',formatC(lme_test_t14$test$sigma[2],format="e",digits = 3))),
                        c(formatC(lme_test_t14$test$pvalues[3],format="e",digits = 3),
                          paste(formatC(lme_test_t14$test$coefficients[3],format="e",digits = 3),'±',formatC(lme_test_t14$test$sigma[3],format="e",digits = 3))),
                        c(formatC(lme_test_t14$test$pvalues[4],format="e",digits = 3),
                          paste(formatC(lme_test_t14$test$coefficients[4],format="e",digits = 3),'±',formatC(lme_test_t14$test$sigma[4],format="e",digits = 3))))
    rownames(lm14_table) <- c('Intercept','Prob Metric','Prior RWD','Interaction')
    colnames(lm14_table) <- c('P-Value','Slope')
    
    
    if (targets == 'all'){
      return(lm_table)
    } else {
      return(lm14_table)
    }
  }
}

ttest_table_func <- function(data, plot_var, prob_metric, Prior_RWD, targets = 'all'){
  
  plotting_data = data[,c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability',prob_metric,plot_var)]
  colnames(plotting_data) = c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability','probability_metric', 'plot_var')
  
  lme_test = cftest(lmer(plot_var ~ probability_metric + (1|Subject), data = plotting_data))
  lme_test_t14 = cftest(lmer(plot_var ~ probability_metric + (1|Subject),
                              data = rbind(filter(plotting_data,Probability==1),
                                           filter(plotting_data,Probability==0))))
  
  
  anova_test = anova(lm(plot_var ~ probability_metric + (1|Subject), 
                        data = aggregate(plot_var~probability_metric + Subject, 
                                         data = rbind(filter(plotting_data, Probability==1),
                                                      filter(plotting_data, Probability==0)),
                                         mean)))
  
  df_subj = aggregate(plot_var ~ Prior_RWD + Subject, plotting_data, mean)
  df2_mean = aggregate(plot_var ~ Prior_RWD, df_subj, mean)
  df2_sd   = aggregate(plot_var ~ Prior_RWD, df_subj, sd)/sqrt(max(df_subj$Subject))
  df2 = cbind(df2_mean,df2_sd$plot_var)
  colnames(df2) <- c('Prior_RWD','plot_var','plot_var_se')
  
  lme_test = cftest(lmer(plot_var ~ Prior_RWD + (1|Subject), df_subj))
  ano14 = anova(lm(plot_var ~ Prior_RWD+(1|Subject), df_subj))
  t_test = t.test(df_subj[df_subj$Prior_RWD == 0,'plot_var'], df_subj[df_subj$Prior_RWD == 1,'plot_var'], paired = TRUE)
  t_test0 = t.test(df_subj[df_subj$Prior_RWD == 0,'plot_var'])
  t_test1 = t.test(df_subj[df_subj$Prior_RWD == 1,'plot_var'])
  
  lm_table <- rbind(c(formatC(t_test$p.value,format="e",digits = 3)),
                    c(formatC(t_test1$p.value,format="e",digits = 3)),
                    c(formatC(t_test0$p.value,format="e",digits = 3)))
  rownames(lm_table) <- c('T-test','T-Test Prior==1','T-Test Prior==0')
  colnames(lm_table) <- c('P-Value')
  return(lm_table)
}

tukey_test_table <- function(tukey_test){
  ptab = matrix(,ncol=3,nrow=3)
  ptab[1,1] = tukey_test$`factor(Probability)`[1,4]
  ptab[1,2] = tukey_test$`factor(Probability)`[2,4]
  ptab[1,3] = tukey_test$`factor(Probability)`[3,4]
  ptab[2,2] = tukey_test$`factor(Probability)`[4,4]
  ptab[2,3] = tukey_test$`factor(Probability)`[5,4]
  ptab[3,3] = tukey_test$`factor(Probability)`[6,4]
  rownames(ptab) = c('0','1/3','2/3')
  colnames(ptab) = c('1/3','2/3','1')
  return(ptab)
}

ttest_post_table <- function(data,
                             prob_metric = 'Probability',
                             plot_var, 
                             plot_var_lab, 
                             correction = 'holm'){
  plotting_data = data[,c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability',prob_metric,plot_var)]
  colnames(plotting_data) = c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability','prob_metric','plot_var')
  
  if (prob_metric == 'Probability'){
    data = aggregate(plot_var ~ Probability + Subject, plotting_data, mean)
    
    ptab = matrix(,ncol=3,nrow=3)
    ptab[1,1] = t.test(plot_var ~ Probability, data = filter(data, Probability == 0 | Probability == 0.33), paired = TRUE)$p.value
    ptab[1,2] = t.test(plot_var ~ Probability, data = filter(data, Probability == 0 | Probability == 0.66), paired = TRUE)$p.value
    ptab[1,3] = t.test(plot_var ~ Probability, data = filter(data, Probability == 0 | Probability == 1), paired = TRUE)$p.value
    ptab[2,2] = t.test(plot_var ~ Probability, data = filter(data, Probability == 0.33 | Probability == 0.66), paired = TRUE)$p.value
    ptab[2,3] = t.test(plot_var ~ Probability, data = filter(data, Probability == 0.33 | Probability == 1), paired = TRUE)$p.value
    ptab[3,3] = t.test(plot_var ~ Probability, data = filter(data, Probability == 0.66 | Probability == 1), paired = TRUE)$p.value
    
    if (correction == 'holm'){
      ptab = p.adjust(ptab, method = 'holm')
      cap = paste('Paired t-test post hoc comparisons with Holm-Bonferonni correction for ',plot_var_lab,'.',sep = '')
    } else {
      cap = paste('Paired t-test, no correction, for ',plot_var_lab,'.',sep = '')
    }
    ptab2 = formatC(ptab, format = 'g', digits = 3)
    ptab2 = unlist(ptab2)
    
    k=1
    for (item in ptab){
      if (!is.na(item) & item<0.05){
        ptab2[k] = paste('*',ptab2[k],sep='')
      }
      k = k + 1
    }
    
    ptab2 = matrix(ptab2, nrow = 3)
    rownames(ptab2) = c('0','1/3','2/3')
    colnames(ptab2) = c('1/3','2/3','1')
    
    return(kable(ptab2,caption = cap))
  } else if (prob_metric == 'RPE' || prob_metric == 'prior_RPE') {
    data = aggregate(plot_var ~ prob_metric + Subject, plotting_data, mean)
    
    ptab = matrix(,ncol=4,nrow=4)
    ptab[1,1] = t.test(plot_var ~ prob_metric, data = filter(data, prob_metric == -0.66 | prob_metric == -0.33), paired = TRUE)$p.value
    ptab[1,2] = t.test(plot_var ~ prob_metric, data = filter(data, prob_metric == -0.66 | prob_metric == 0), paired = TRUE)$p.value
    ptab[1,3] = t.test(plot_var ~ prob_metric, data = filter(data, prob_metric == -0.66 | prob_metric == 0.33), paired = TRUE)$p.value
    ptab[1,4] = t.test(plot_var ~ prob_metric, data = filter(data, prob_metric == -0.66 | prob_metric == 0.66), paired = TRUE)$p.value
    
    ptab[2,2] = t.test(plot_var ~ prob_metric, data = filter(data, prob_metric == -0.33 | prob_metric == 0), paired = TRUE)$p.value
    ptab[2,3] = t.test(plot_var ~ prob_metric, data = filter(data, prob_metric == -0.33 | prob_metric == 0.33), paired = TRUE)$p.value
    ptab[2,4] = t.test(plot_var ~ prob_metric, data = filter(data, prob_metric == -0.33 | prob_metric == 0.66), paired = TRUE)$p.value
    
    ptab[3,3] = t.test(plot_var ~ prob_metric, data = filter(data, prob_metric == 0 | prob_metric == 0.33), paired = TRUE)$p.value
    ptab[3,4] = t.test(plot_var ~ prob_metric, data = filter(data, prob_metric == 0 | prob_metric == 0.66), paired = TRUE)$p.value
    
    ptab[4,4] = t.test(plot_var ~ prob_metric, data = filter(data, prob_metric == 0.33 | prob_metric == 0.66), paired = TRUE)$p.value
    
    if (correction == 'holm'){
      ptab = p.adjust(ptab, method = 'holm')
      cap = paste('Paired t-test post hoc comparisons with Holm-Bonferonni correction for ',plot_var_lab,'.',sep = '')
    } else {
      cap = paste('Paired t-test, no correction, for ',plot_var_lab,'.',sep = '')
    }
    ptab2 = formatC(ptab, format = 'g', digits = 3)
    ptab2 = unlist(ptab2)
    
    k=1
    for (item in ptab){
      if (!is.na(item) & item<0.05){
        ptab2[k] = paste('*',ptab2[k],sep='')
      }
      k = k + 1
    }
    
    ptab2 = matrix(ptab2, nrow = 4)
    rownames(ptab2) = c('-2/3','-1/3','0','1/3')
    colnames(ptab2) = c('-1/3','0','1/3','2/3')
    
    
    return(kable(ptab2,caption = cap))
    
  }
}

summary_table_func <- function(data, 
                               prob_metric, 
                               plot_var, 
                               plot_var_lab,
                               trial_or_subj = 'trial'){

  plotting_data = data[,c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability',prob_metric,plot_var)]
  colnames(plotting_data) = c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability','probability_metric', 'plot_var')
  
  if (trial_or_subj == 'subj'){
    
    a = aggregate(plot_var ~ Subject + probability_metric,plotting_data, mean)
    b = aggregate(plot_var ~ Subject + probability_metric,plotting_data, sd)
    
    c = aggregate(plot_var ~ probability_metric, a, mean)
    d = aggregate(plot_var ~ probability_metric, a, sd)
    
    c = cbind(c,c$plot_var)
    colnames(c) = c('probability_metric','mean','sd')
    c$se = c$sd/sqrt(length(filter(a,probability_metric == min(a$probability_metric))$Subject))
    c$lb = c$mean - 1.96*c$se
    c$ub = c$mean + 1.96*c$se
    
    prob_metrics = sort(unique(plotting_data$probability_metric))
    out_mat = matrix(,nrow = length(prob_metrics), ncol = 1)
    col = 1
    for (prob in prob_metrics){
      row_data = filter(c, probability_metric == prob)
      probability = row_data$probability_metric
      row = match(probability,prob_metrics)
      
      cell = paste(formatC(row_data$mean,format='g',digits = 3),
                   ' ± ',
                   formatC(row_data$se,format='g',digits = 3),
                   ' (',
                   formatC(row_data$lb,format='g',digits = 3),
                   ', ',
                   formatC(row_data$ub,format='g',digits = 3),
                   ')',sep='')
      out_mat[row,col] = cell
    }
    rownames(out_mat) = prob_metrics
    colnames(out_mat) = 'Mean ± SE (lb, ub)'
    out_mat = kable(out_mat,
                    caption = paste('Summary data table for ',plot_var_lab,'. Each row is a probability metric. This is compute subject average for each probability, then average the average. Data is shown as mean ± standard error (lower bound, upper bound) for the 95% confidence interval of that mean.',sep=''))
    
  } else {
    
    a = aggregate(plot_var ~ Subject + probability_metric,plotting_data, mean)
    b = aggregate(plot_var ~ Subject + probability_metric,plotting_data, sd)
    
    c = cbind(a,b$plot_var)
    colnames(c) = c('Subject','probability_metric','mean','sd')
    c$se = c$sd/sqrt(length(filter(data,Subject == 1 & probability_metric == min(a$probability_metric))$Subject))
    c$lb = c$mean - 1.96*c$se
    c$ub = c$mean + 1.96*c$se
    
    prob_metrics = sort(unique(plotting_data$probability_metric))
    out_mat = matrix(,nrow = length(unique(c$Subject)),ncol = length(prob_metrics))
    for (subj in unique(plotting_data$Subject)){
      for (prob in prob_metrics){
        row_data = filter(c, Probability == prob & Subject == subj)
        row = subj + 1
        probability = row_data$Probability
        col = match(probability,prob_metrics)
        
        cell = paste(formatC(row_data$mean,format='g',digits = 3),
                     ' ± ',
                     formatC(row_data$se,format='g',digits = 3),
                     ' (',
                     formatC(row_data$lb,format='g',digits = 3),
                     ', ',
                     formatC(row_data$ub,format='g',digits = 3),
                     ')',sep='')
        out_mat[row,col] = cell
      }
    }
    rownames(out_mat) = sort(unique(plotting_data$Subject))
    colnames(out_mat) = prob_metrics
    
    out_mat = kable(out_mat,
                    caption = paste('Summary data table for ',plot_var_lab,'. Column is each probability metric, row is individual subject. Data is shown as mean ± standard error (lower bound, upper bound) for the 95% confidence interval of that mean.',sep=''))
  }
  
  return(out_mat)
}

filt_data <- non_famil_data
plots <- list()


prob_str_gen <- function(p_val, slope, variable){
  if (p_val<0.05){
    yesno = 'WAS'
  } else {
    yesno = 'WAS NOT'
  }
  p_val = formatC(p_val,format='e',digits =3)
  slope = formatC(slope,format='e',digits =3)
  str = paste(variable,' ',yesno,' significantly affected by probability of reward (p = ',p_val,', slope = ',slope,'). This was tested with an LMER with main outcome of probability and random effect of subject.',sep='')
  return(str)
}

t14_str_gen <- function(ttest_pval, aov_pval, variable){
  if (ttest_pval<0.05){
    yesno = 'WAS'
  } else {
    yesno = 'WAS NOT'
  }
  ttest_pval = formatC(ttest_pval,format='e',digits =3)
  str_ttest = paste('In a paired t test of subject averages, there ',yesno,' a significant difference between 0% and 100% reward conditions for ',variable,' (p = ',ttest_pval,'). .',sep='')
  
  if (aov_pval<0.05){
    yesno = 'WAS'
  } else {
    yesno = 'WAS NOT'
  }
  aov_pval = formatC(aov_pval,format='e',digits =3)
  str_aov = paste('In a ANOVA test of subject averages, there ',yesno,' a significant difference between 0% and 100% reward conditions for ',variable,' (p = ',aov_pval,'). .',sep='')
  return(paste(str_ttest,'\n',str_aov,sep='\n'))
}

priorbar_str_gen <- function(ttest_pval, aov_pval, variable){
  if (ttest_pval<0.05){
    yesno = 'WAS'
  } else {
    yesno = 'WAS NOT'
  }
  ttest_pval = formatC(ttest_pval,format='e',digits =3)
  str_ttest = paste('Using a paried t test, across subjects, the ',variable,' in trials following rewarded trials ',yesno,' statistically different than trials following nonrewarded tirlas (p = ',ttest_pval,')',sep='')
  # str_ttest = paste('In a paired t test of subject averages, there ',yesno,' a significant difference between 0% and 100% reward conditions for ',variable,' (p = ',ttest_pval,'). .',sep='')
  
  if (aov_pval<0.05){
    yesno = 'WAS'
  } else {
    yesno = 'WAS NOT'
  }
  aov_pval = formatC(aov_pval,format='e',digits =3)
  str_aov = paste('Using an ANOVA test, across subjects, the ',variable,' in trials following rewarded trials ',yesno,' statistically different than trials following nonrewarded tirlas (p = ',aov_pval,')',sep='')
  return(paste(str_ttest,'\n',str_aov,sep='\n'))
}

prior_str_gen <- function(lm_pval_prob, lm_pval_prior, lm_pval_int, lme_pval_Prior0, lme_pval_Prior1, variable){
  if (lm_pval_prob<0.05){
    yesno_prob = 'WAS'
  } else {
    yesno_prob = 'WAS NOT'
  }
  if (lm_pval_prior<0.05){
    yesno_prior = 'WAS'
  } else {
    yesno_prior = 'WAS NOT'
  }
  if (lm_pval_int<0.05){
    yesno_int = 'DID'
  } else {
    yesno_int = 'DID NOT'
  }
  
  lm_pval_prob = formatC(lm_pval_prob,format='e',digits =3)
  lm_pval_prior = formatC(lm_pval_prior,format='e',digits =3)
  lm_pval_int = formatC(lm_pval_int,format='e',digits =3)
  str_lm = paste('In an interacation LMER of probability of reward and prior reward with subject as a random intercept effect, ',variable,' ',yesno_prob,' affected by probability of reward (p = ',lm_pval_prob,') and ',yesno_prior,' affected by prior reward (p = ',lm_pval_prior,'). An interaction of the two factors ',yesno_int,' affect ',variable,' (p = ',lm_pval_int,')',sep='')
  
  if (lme_pval_Prior0<0.05){
    yesno_prior0 = 'finding a significant slope'
  } else {
    yesno_prior0 = 'finding NO significant slope'
  }
  lme_pval_Prior0 = formatC(lme_pval_Prior0,format='e',digits =3)
  if (lme_pval_Prior1<0.05){
    yesno_prior1 = 'finding a significant slope'
  } else {
    yesno_prior1 = 'finding NO significant slope'
  }
  lme_pval_Prior1 = formatC(lme_pval_Prior1,format='e',digits =3)
  lme_pval_Prior0 = formatC(lme_pval_Prior0,format='e',digits =3)
  str_lm_split = paste('Dividing the data set into two groups (trials following reward and trials not following reward) resulted in ',yesno_prior1,' of probability (p = ',lme_pval_Prior1,') in trials that follow reward, but ',yesno_prior0,' (p = ',lme_pval_Prior0,') in trials that do not follow reward.',sep='')
  
  return(paste(str_lm,'\n',str_lm_split,sep='\n'))
}

priordiff_str_gen <- function(lm_pval_prob, lm_pval_prior, lm_pval_int, lme_pval_Prior0, lme_pval_Prior1, variable){
  if (lm_pval_prob<0.05){
    yesno_prob = 'WAS'
  } else {
    yesno_prob = 'WAS NOT'
  }
  if (lm_pval_prior<0.05){
    yesno_prior = 'WAS'
  } else {
    yesno_prior = 'WAS NOT'
  }
  if (lm_pval_int<0.05){
    yesno_int = 'DID'
  } else {
    yesno_int = 'DID NOT'
  }
  
  lm_pval_prob = formatC(lm_pval_prob,format='e',digits =3)
  lm_pval_prior = formatC(lm_pval_prior,format='e',digits =3)
  lm_pval_int = formatC(lm_pval_int,format='e',digits =3)
  str_lm = paste('In an interacation LMER of probability of reward and prior reward with subject as a random intercept effect, ',variable,' ',yesno_prob,' affected by probability of reward (p = ',lm_pval_prob,') and ',yesno_prior,' affected by prior reward (p = ',lm_pval_prior,'). An interaction of the two factors ',yesno_int,' affect ',variable,' (p = ',lm_pval_int,')',sep='')
  
  if (lme_pval_Prior0<0.05){
    yesno_prior0 = 'finding a significant slope'
  } else {
    yesno_prior0 = 'finding NO significant slope'
  }
  lme_pval_Prior0 = formatC(lme_pval_Prior0,format='e',digits =3)
  if (lme_pval_Prior1<0.05){
    yesno_prior1 = 'finding a significant slope'
  } else {
    yesno_prior1 = 'finding NO significant slope'
  }
  lme_pval_Prior1 = formatC(lme_pval_Prior1,format='e',digits =3)
  lme_pval_Prior0 = formatC(lme_pval_Prior0,format='e',digits =3)
  str_lm_split = paste('Dividing the data set into two groups (trials following reward and trials not following reward) resulted in ',yesno_prior1,' of probability (p = ',lme_pval_Prior1,') in trials that follow reward, but ',yesno_prior0,' (p = ',lme_pval_Prior0,') in trials that do not follow reward.',sep='')
  
  return(paste(str_lm,'\n',str_lm_split,sep='\n'))
}

priordiff_ttest_str_gen <- function(ttest, ttest1, ttest0, variable){
  if (ttest<0.05){
    yesno_ttest = 'WAS'
  } else {
    yesno_ttest = 'WAS NOT'
  }
  if (ttest1<0.05){
    yesno_ttest1 = 'WAS'
  } else {
    yesno_ttest1 = 'WAS NOT'
  }
  if (ttest0<0.05){
    yesno_ttest0 = 'DID'
  } else {
    yesno_ttest0 = 'DID NOT'
  }
  
  ttest = formatC(ttest,format='e',digits =3)
  ttest1 = formatC(ttest1,format='e',digits =3)
  ttest0 = formatC(ttest0,format='e',digits =3)
  
  str = paste('To further examine this effect of prior reward on ',variable,', the change in ',variable,' was determined from trial to trial. In the above graph Delta ',variable,' is the difference in ',variable,' of the current trial minus the previous trial (PV_(trial=n)-PV_(trial=n-1)). There ',yesno_ttest,' a statistical difference between trials following and not following reward (paired t-test of subject averages, p = ',ttest,'). ',variable,' ',yesno_ttest1,' significantly different following reward (t-test of subject averages vs a mean of 0, p = ',ttest1,') and ',variable,' ',yesno_ttest0,' significantly different following trials where they were not rewarded (t-test of subject averages vs a mean of 0, p = ',ttest0,').',sep='')
  
  return(str)
}

priordiffprob_str_gen <- function(lm_prob_prior, lm_prior1, lm_prior0, variable, prob_metric){
  
  lm_pval_prob = lm_prob_prior$test$pvalues[2]
  lm_pval_prior = lm_prob_prior$test$pvalues[3]
  lm_pval_int = lm_prob_prior$test$pvalues[4]
  
  lm_slope_prob = lm_prob_prior$coef[2]
  lm_slope_prior = lm_prob_prior$coef[3]
  lm_slope_int = lm_prob_prior$coef[4]
  
  if (lm_pval_prob<0.05){
    yesno_prob = 'WAS'
  } else {
    yesno_prob = 'WAS NOT'
  }
  if (lm_slope_prob > 0){
    slope_prob = 'INCREASE'
  } else {
    slope_prob = 'DECREASE'
  }
  
  
  if (lm_pval_prior<0.05){
    yesno_prior = 'DID'
  } else {
    yesno_prior = 'DID NOT'
  }
  if (lm_slope_prior > 0){
    slope_prior = 'INCREASE'
  } else {
    slope_prior = 'DECREASE'
  }
  
  
  if (lm_pval_int<0.05){
    yesno_int = 'WAS'
  } else {
    yesno_int = 'WAS NOT'
  }
  if (lm_slope_int > 0){
    slope_int = 'INCREASE'
  } else {
    slope_int = 'DECREASE'
  }
  
  lm_pval_prob = formatC(lm_pval_prob,format='e',digits =3)
  lm_pval_prior = formatC(lm_pval_prior,format='e',digits =3)
  lm_pval_int = formatC(lm_pval_int,format='e',digits =3)
  
  str_lm = paste('We then investigate the effect of the difference in probability from the previous trial to the current trial on ',variable,'. First we find that prior reward ',yesno_prior,' have an effect on ',variable,' change from previous trial (p = ',lm_pval_prior,'). This indicates that prior reward made subjects ',slope_prior,' their ',variable,'. An interaction between prior reward and probability difference ',yesno_int,' significant. We then split this linear model into two, one with prior reward and one with no prior reward.')
  
  lme_pval_prior0 = lm_prior0$test$pvalues[2]
  lme_pval_prior1 = lm_prior1$test$pvalues[2]
  
  lm_slope_prior0 = lm_prior0$coef[2]
  lm_slope_prior1 = lm_prior1$coef[2]
  
  if (lme_pval_prior0<0.05){
    yesno_prior0 = 'finding a significant slope'
  } else {
    yesno_prior0 = 'finding NO significant slope'
  }
  if (lm_slope_prior0 > 0){
    slope_prob = 'INCREASE'
  } else {
    slope_prob = 'DECREASE'
  }
  
  if (lme_pval_prior1<0.05){
    yesno_prior1 = 'finding a significant slope'
  } else {
    yesno_prior1 = 'finding NO significant slope'
  }
  if (lm_slope_prior1 > 0){
    slope_prob = 'INCREASE'
  } else {
    slope_prob = 'DECREASE'
  }
  
  lme_pval_prior1 = formatC(lme_pval_prior1,format='e',digits =3)
  lme_pval_prior0 = formatC(lme_pval_prior0,format='e',digits =3)
  lm_slope_prior1 = formatC(lm_slope_prior1,format='e',digits =3)
  lm_slope_prior0 = formatC(lm_slope_prior0,format='e',digits =3)
  
  str_lm_split = paste('Dividing the data set into two groups (trials following reward and trials not following reward) resulted in ',yesno_prior1,' of probability (p = ',lme_pval_prior1,', slope = ',lm_slope_prior1,') in trials that follow reward, and ',yesno_prior0,' (p = ',lme_pval_prior0,', slope = ',lm_slope_prior0,') in trials that do not follow reward.',sep='')
  
  return(paste(str_lm,'\n',str_lm_split,sep='\n'))
}

priorRPE_str_gen <- function(lm_pval_prob, lm_pval_prior, lm_pval_int, lme_pval_Prior0, lme_pval_Prior1, variable){
  if (lm_pval_prob<0.05){
    yesno_prob = 'WAS'
  } else {
    yesno_prob = 'WAS NOT'
  }
  if (lm_pval_prior<0.05){
    yesno_prior = 'WAS'
  } else {
    yesno_prior = 'WAS NOT'
  }
  if (lm_pval_int<0.05){
    yesno_int = 'DID'
  } else {
    yesno_int = 'DID NOT'
  }
  
  lm_pval_prob = formatC(lm_pval_prob,format='e',digits =3)
  lm_pval_prior = formatC(lm_pval_prior,format='e',digits =3)
  lm_pval_int = formatC(lm_pval_int,format='e',digits =3)
  str_lm = paste('In an interacation LMER of RPE and prior reward with subject as a random intercept effect, ',variable,' ',yesno_prob,' affected by RPE (p = ',lm_pval_prob,') and ',yesno_prior,' affected by prior reward (p = ',lm_pval_prior,'). An interaction of the two factors ',yesno_int,' affect ',variable,' (p = ',lm_pval_int,')',sep='')
  
  if (lme_pval_Prior0<0.05){
    yesno_prior0 = 'finding a significant slope'
  } else {
    yesno_prior0 = 'finding NO significant slope'
  }
  lme_pval_Prior0 = formatC(lme_pval_Prior0,format='e',digits =3)
  if (lme_pval_Prior1<0.05){
    yesno_prior1 = 'finding a significant slope'
  } else {
    yesno_prior1 = 'finding NO significant slope'
  }
  lme_pval_Prior1 = formatC(lme_pval_Prior1,format='e',digits =3)
  lme_pval_Prior0 = formatC(lme_pval_Prior0,format='e',digits =3)
  str_lm_split = paste('Dividing the data set into two groups (trials following reward and trials not following reward) resulted in ',yesno_prior1,' of RPE (p = ',lme_pval_Prior1,') in trials that follow reward, but ',yesno_prior0,' (p = ',lme_pval_Prior0,') in trials that do not follow reward.',sep='')
  
  return(paste(str_lm,'\n',str_lm_split,sep='\n'))
}

RPE_str_gen <- function(lm_pval_prob, variable){
  if (lm_pval_prob<0.05){
    yesno_prob = 'WAS'
  } else {
    yesno_prob = 'WAS NOT'
  }
  
  lm_pval_prob = formatC(lm_pval_prob,format='e',digits =3)
  str_lm = paste('In an LMER of RPE with subject as a random intercept effect, ',variable,' ',yesno_prob,' affected by RPE (p = ',lm_pval_prob,').',sep='')
  
  
  return(paste(str_lm,sep=''))
}

```


```{r, echo = FALSE, warning = FALSE, message = FALSE}
testable_vars        = c('PeakV',
                         'RT',
                         'Max_Ex',
                         'Duration',
                         'TotalDur',
                         'Vigor')
testable_vars_labels = c('Peak Velocity (m/s)',
                         'Reaction Time (s)',
                         'Maximum Excursion (m)',
                         'Movement Duration (s)',
                         'Total Duration (s)',
                         'Vigor (1/s)')

for (k in 1:length(testable_vars)){
  plots[[testable_vars[k]]][['abs']] <- Prob_plotting(data= filt_data,
                                                      prob_method = 'Probability',
                                                      plot_var = testable_vars[k],
                                                      var_lab = testable_vars_labels[k],
                                                      plot_type = 'nv',
                                                      title_lab = 'ABS',
                                                      Prior_RWD = '0')
  
  plots[[testable_vars[k]]][['Prior_RWD']] <- Prob_plotting(data= filt_data,
                                                            prob_method = 'Probability',
                                                            plot_var = testable_vars[k],
                                                            var_lab = testable_vars_labels[k],
                                                            plot_type = 'nv',
                                                            title_lab = 'ABS',
                                                            Prior_RWD = 'Prior_RWD')
  
  plots[[testable_vars[k]]][['RPE_split_prob']] <- Prob_plotting(filt_data,
                                           prob_method = 'prior_RPE',
                                           plot_var = paste('DiffPrior_',testable_vars[k],sep=''),
                                           var_lab = paste('Diff Prior ', testable_vars_labels[k], sep = ''),
                                           plot_type = 'NULL',
                                           Prior_RWD = 'NULL', 
                                           title_lab = 'Reward Prediction Error (RPE)',
                                           rpe_split = 'Probability')
  
  plots[[testable_vars[k]]][['RPE_split_prior']] <- Prob_plotting(filt_data,
                                           prob_method = 'prior_RPE',
                                           plot_var = paste('DiffPrior_',testable_vars[k],sep=''),
                                           var_lab = paste('Diff Prior ', testable_vars_labels[k], sep = ''),
                                           plot_type = 'NULL',
                                           Prior_RWD = 'NULL', 
                                           title_lab = 'Reward Prediction Error (RPE)',
                                           rpe_split = 'Prior_RWD')
  
  
  plots[[testable_vars[k]]][['RPE_no_split']] <- Prob_plotting(filt_data,
                                           prob_method = 'prior_RPE',
                                           plot_var = paste('DiffPrior_',testable_vars[k],sep=''),
                                           var_lab = paste('Diff Prior ', testable_vars_labels[k], sep = ''),
                                           plot_type = 'NULL',
                                           Prior_RWD = 'NULL', 
                                           title_lab = 'Reward Prediction Error (RPE)',
                                           rpe_split = 'none')
  
  plots[[testable_vars[k]]][['RPE']][['plot']] <- plots[[testable_vars[k]]][['RPE']][['plot']]+
    labs(x = 'Reward Prediction Error on previous trial (RPE)')
}
```

# Summary Bar Charts
## Effect of Probability
The plot below shows the linear model p-values for just the effect of probability of reward on the metric on the x-axis.

The equation below shows the linear model used:
$$ Outcome \sim Probability + (1|Subject) $$
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 4, fig.width = 9}

# Make a summary Bar chart for just effect of Probability ============================
p_val_labs = testable_vars
p_vals  = c()
for (item in testable_vars){
  p_vals  = c(p_vals, plots[[item]][['abs']]$lm$test$pvalues[2])
}

p_val_df = data.frame('variable' = p_val_labs, 'p_val' = p_vals, 'var_num' = 1:6)

pval_plot <- ggplot()+
  geom_bar(data=p_val_df,
           aes(x=factor(var_num),
               y=p_val),
           stat = 'identity')+
  scale_x_discrete(breaks = c(1:6), labels = testable_vars)+
  labs(x = 'Tested Variable',
       y = 'LMER P-Value')+
  geom_hline(yintercept =  0.05,
             color = 'red',
             size = 2)+
  theme(axis.text.x = element_text(angle = 30, hjust = 1))+
  scale_y_continuous(expand = c(0,0))

for (row in 1:(nrow(p_val_df))){
  if (p_val_df[row,'p_val']<.05){
    y_val = p_val_df[row,'p_val']+0.02
    x_pos = row
    eval(parse(text = paste('pval_plot <- pval_plot + 
                       geom_text(aes(x = ',x_pos,', y = ',y_val,'),
                       label = \'*\',
                       size = 10,
                       color = \'black\')',sep='')))
  }
}

pval_plot
```

## Prior Reward
The plot below shows a summary of linear model p-values for when we split the metric by prior reward. This is also split into individual linear models with just trials that were prior rewarded, and trials that were not prior rewarded.

The equation below shows the linear model used:
$$ Outcome \sim Probability + PriorRWD+Probability*Prior RWD + (1|Subject) $$
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 9, fig.width = 12}

# Make a summary Bar chart for effect of Probability and prior reward ============================
p_vals_prob  = c()
p_vals_prior = c()
p_vals_int   = c()
for (item in testable_vars){
  p_vals_prob  = c(p_vals_prob, plots[[item]][['Prior_RWD']]$lm$test$pvalues[2])
  p_vals_prior = c(p_vals_prior,plots[[item]][['Prior_RWD']]$lm$test$pvalues[3])
  p_vals_int   = c(p_vals_int,  plots[[item]][['Prior_RWD']]$lm$test$pvalues[4])
}

prior_sum_df = data.frame('var_num' = rep(1:6,3),
                          'variable' = rep(testable_vars,3), 
                          'p_val_metric' = c(rep('1',6), # Probability
                                             rep('2',6), # Prior
                                             rep('3',6)), # Interaction
                          'p_val' = c(p_vals_prob,p_vals_prior,p_vals_int))

pval_plot_prior <- ggplot()+
  geom_bar(data=prior_sum_df,
           aes(x = factor(var_num),
               y = p_val,
               fill = factor(p_val_metric)),
           stat = 'identity',
           position = 'dodge')+
  scale_x_discrete(breaks = c(1:6), labels = testable_vars)+
  labs(x = 'Tested Variable',
       y = 'LMER P-Value',
       fill = 'P Value\nMetric')+
  theme(axis.text.x = element_text(angle = 30, hjust = 1))+
  scale_y_continuous(expand = c(0,0))+
  geom_hline(yintercept =  0.05,
             color = 'black',
             size = 2)+
  scale_fill_discrete(labels = c('Probability','Prior RWD','Interaction'))

for (row in 1:(nrow(prior_sum_df))){
  if (prior_sum_df[row,'p_val']<.05){
    y_val = prior_sum_df[row,'p_val']+0.02
    x_pos = match(prior_sum_df[row,'variable'],testable_vars)
    if (prior_sum_df[row,'p_val_metric'] == 1){
      x_pos = x_pos - 0.3
    } else if (prior_sum_df[row,'p_val_metric'] == 3){
      x_pos = x_pos + 0.3
    }
    
    eval(parse(text = paste('pval_plot_prior <- pval_plot_prior + 
                       geom_text(aes(x = ',x_pos,', y = ',y_val,'),
                       label = \'*\',
                       size = 10,
                       color = \'black\')',sep='')))
  }
}


p_vals_prior1 = c()
p_vals_prior0 = c()
for (item in testable_vars){
  p_vals_prior1  = c(p_vals_prior1, plots[[item]][['Prior_RWD']]$lme_test_Prior1$test$pvalues[2])
  p_vals_prior0  = c(p_vals_prior0, plots[[item]][['Prior_RWD']]$lme_test_Prior0$test$pvalues[2])
}

prior_split_sum_df = data.frame('var_num' = rep(1:6,2),
                          'variable' = rep(testable_vars,2), 
                          'p_val_metric' = c(rep('1',6), # Was Prior Rewarded
                                             rep('2',6)), # No Prior Reward
                          'p_val' = c(p_vals_prior1,p_vals_prior0))

pval_plot_prior_split <- ggplot()+
  geom_bar(data=prior_split_sum_df,
           aes(x = factor(var_num),
               y = p_val,
               fill = factor(p_val_metric)),
           stat = 'identity',
           position = 'dodge')+
  scale_x_discrete(breaks = c(1:6), labels = testable_vars)+
  labs(x = 'Tested Variable',
       y = 'LMER P-Value',
       fill = 'Previous Trial\nRewarded')+
  theme(axis.text.x = element_text(angle = 30, hjust = 1))+
  scale_y_continuous(expand = c(0,0))+
  geom_hline(yintercept =  0.05,
             color = 'black',
             size = 2)+
  scale_fill_brewer(palette = "Dark2", labels = c('Prior RWD','No Prior RWD'))

for (row in 1:(nrow(prior_split_sum_df))){
  if (prior_split_sum_df[row,'p_val']<.05){
    y_val = prior_split_sum_df[row,'p_val']+0.02
    x_pos = match(prior_split_sum_df[row,'variable'],testable_vars)
    if (prior_sum_df[row,'p_val_metric'] == 1){
      x_pos = x_pos - 0.2
    } else if (prior_split_sum_df[row,'p_val_metric'] == 3){
      x_pos = x_pos + 0.2
    }
    
    eval(parse(text = paste('pval_plot_prior_split <- pval_plot_prior_split + 
                       geom_text(aes(x = ',x_pos,', y = ',y_val,'),
                       label = \'*\',
                       size = 10,
                       color = \'black\')',sep='')))
  }
}

plot_grid(pval_plot_prior,pval_plot_prior_split,
          nrow = 2,
          align = 'vh')
```

## Reward Prediction Error (RPE)
The next plot shows a summary of linear model p-values the prediction of reward prediction error (RPE) when we split the metric by prior reward. This is also split into individual linear models with just trials that were prior rewarded, and trials that were not prior rewarded.

The equation below shows the linear model used:
$$ Outcome \sim RPE + PriorRWD+RPE*Prior RWD + (1|Subject) $$
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 9, fig.width = 12}

# Make a summary Bar chart for effect of RPE and prior reward ============================
p_vals_prob  = c()
p_vals_prior = c()
p_vals_int   = c()
for (item in testable_vars){
  p_vals_prob  = c(p_vals_prob, plots[[item]][['RPE']]$lm$test$pvalues[2])
  p_vals_prior = c(p_vals_prior,plots[[item]][['RPE']]$lm$test$pvalues[3])
  p_vals_int   = c(p_vals_int,  plots[[item]][['RPE']]$lm$test$pvalues[4])
}

RPE_sum_df = data.frame('var_num' = rep(1:6,3),
                        'variable' = rep(testable_vars,3), 
                        'p_val_metric' = c(rep('1',6), # RPE
                                           rep('2',6), # Prior
                                           rep('3',6)), # Interaction
                        'p_val' = c(p_vals_prob,p_vals_prior,p_vals_int))

pval_plot_RPE <- ggplot()+
  geom_bar(data=RPE_sum_df,
           aes(x = factor(var_num),
               y = p_val,
               fill = factor(p_val_metric)),
           stat = 'identity',
           position = 'dodge')+
  scale_x_discrete(breaks = c(1:6), labels = testable_vars)+
  labs(x = 'Tested Variable',
       y = 'LMER P-Value',
       fill = 'P Value\nMetric')+
  theme(axis.text.x = element_text(angle = 30, hjust = 1))+
  scale_y_continuous(expand = c(0,0))+
  geom_hline(yintercept =  0.05,
             color = 'black',
             size = 2)+
  scale_fill_discrete(labels = c('RPE','Prior RWD','Interaction'))

for (row in 1:(nrow(RPE_sum_df))){
  if (RPE_sum_df[row,'p_val']<.05){
    y_val = RPE_sum_df[row,'p_val']+0.02
    x_pos = match(RPE_sum_df[row,'variable'],testable_vars)
    if (RPE_sum_df[row,'p_val_metric'] == 1){
      x_pos = x_pos - 0.3
    } else if (RPE_sum_df[row,'p_val_metric'] == 3){
      x_pos = x_pos + 0.3
    }
    
    eval(parse(text = paste('pval_plot_RPE <- pval_plot_RPE + 
                       geom_text(aes(x = ',x_pos,', y = ',y_val,'),
                       label = \'*\',
                       size = 10,
                       color = \'black\')',sep='')))
  }
}


p_vals_prior1 = c()
p_vals_prior0 = c()
for (item in testable_vars){
  p_vals_prior1  = c(p_vals_prior1, plots[[item]][['RPE']]$lme_test_Prior1$test$pvalues[2])
  p_vals_prior0  = c(p_vals_prior0, plots[[item]][['RPE']]$lme_test_Prior0$test$pvalues[2])
}

RPE_split_sum_df = data.frame('var_num' = rep(1:6,2),
                              'variable' = rep(testable_vars,2), 
                              'p_val_metric' = c(rep('1',6), # Was Prior Rewarded
                                                 rep('2',6)), # No Prior Reward
                              'p_val' = c(p_vals_prior1,p_vals_prior0))

pval_plot_RPE_split <- ggplot()+
  geom_bar(data=RPE_split_sum_df,
           aes(x = factor(var_num),
               y = p_val,
               fill = factor(p_val_metric)),
           stat = 'identity',
           position = 'dodge')+
  scale_x_discrete(breaks = c(1:6), labels = testable_vars)+
  labs(x = 'Tested Variable',
       y = 'RPE LMER P-Value',
       fill = 'Previous Trial\nRewarded')+
  theme(axis.text.x = element_text(angle = 30, hjust = 1))+
  scale_y_continuous(expand = c(0,0))+
  geom_hline(yintercept =  0.05,
             color = 'black',
             size = 2)+
  scale_fill_brewer(palette = "Dark2", labels = c('Prior RWD','No Prior RWD'))

for (row in 1:(nrow(RPE_split_sum_df))){
  if (RPE_split_sum_df[row,'p_val']<.05){
    y_val = RPE_split_sum_df[row,'p_val']+0.02
    x_pos = match(RPE_split_sum_df[row,'variable'],testable_vars)
    if (prior_sum_df[row,'p_val_metric'] == 1){
      x_pos = x_pos - 0.2
    } else if (RPE_split_sum_df[row,'p_val_metric'] == 3){
      x_pos = x_pos + 0.2
    }
    
    eval(parse(text = paste('pval_plot_RPE_split <- pval_plot_RPE_split + 
                       geom_text(aes(x = ',x_pos,', y = ',y_val,'),
                       label = \'*\',
                       size = 10,
                       color = \'black\')',sep='')))
  }
}

plot_grid(pval_plot_RPE,pval_plot_RPE_split,
          nrow = 2,
          align = 'vh')
```

# Peak Velocity
## Effect of Probability
```{r, echo = FALSE, warning = FALSE, message = FALSE}
chunk_var = 'PeakV'
chunk_var_lab = 'Peak Velocity'

plots[[chunk_var]][['Delta']] <- Prob_plotting(data= filt_data,
                                               prob_method = 'Probability',
                                               plot_var = paste('Delta',chunk_var,sep=''),
                                               var_lab = paste(chunk_var_lab,' DELTA (m/s)',sep=''),
                                               plot_type = 'nv',
                                               title_lab = 'DELTA',
                                               Prior_RWD = '0')

cur_plot = plots[[chunk_var]][['abs']]
```

`r prob_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$coef[2],chunk_var_lab)`

The equation below shows the linear model used:
$$ Outcome \sim Probability + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, fig.height = 5, fig.width = 10}
kable(pvalue_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'no'),
      caption = paste(chunk_var_lab,' P-Values for effect of Probability',sep=''))

plot_grid(plots[[chunk_var]][['abs']][['plot']],plots[[chunk_var]][['Delta']][['plot']],
          ncol=2)

```

We also compute an paired t-test with holm-bonferonni correction to determine if there are differences between individual conditions. The table below shows the results of the Tukey test (table \@ref(tab:peakvttestposttab)).

```{r peakvttestposttab, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = chunk_var,
                 plot_var_lab = chunk_var_lab,
                 prob_metric = 'Probability',
                 correction = 'hom')

```

These are the uncorrected paired t-test values
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = chunk_var,
                 plot_var_lab = chunk_var_lab,
                 prob_metric = 'Probability',
                 correction = 'none')
```

#### Summary Tables
```{r, echo = FALSE, warning = FALSE, message = FALSE}
summary_table_func(filt_data, 
                   prob_metric = 'Probability', 
                   plot_var = chunk_var, 
                   plot_var_lab = chunk_var_lab,
                   trial_or_subj = 'subj')
```


#### Comparison of 0% and 100% Reward

`r t14_str_gen(cur_plot$t_test$p.value,cur_plot$ano14[['Pr(>F)']][1],chunk_var_lab)`

## Effect of Trial

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Trial']] = trial_plotting(filt_data,chunk_var,chunk_var_lab,chunk_var_lab)

```

`r plots[[chunk_var]][['Trial']][['trial_str']]`

The linear model used to predict effect of trial is shown below:
$$ Outcome \sim B*Trial + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[chunk_var]][['Trial']][['plot']]

```

## Peak Velocity Following Reward

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Prior_RWD_bar']] <- Prob_plotting(data= filt_data,
                                                  prob_method = 'Probability',
                                                  plot_var = chunk_var,
                                                  var_lab = paste(chunk_var_lab,' (m/s)',sep=''),
                                                  plot_type = 'bar',
                                                  title_lab = 'ABS',
                                                  Prior_RWD = 'Prior_RWD')


cur_plot <- plots[[chunk_var]][['Prior_RWD_bar']]
```

`r priorbar_str_gen(cur_plot$t_test$p.value,cur_plot$ano14[['Pr(>F)']][1],chunk_var_lab)`

```{r, echo = FALSE, warning = FALSE}
kable(ttest_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var_lab,' P-Values for effect of Probability',sep=''))

plots[[chunk_var]][['Prior_RWD_bar']][['plot']]

```

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Prior_RWD']] <- Prob_plotting(data= filt_data,
                                                 prob_method = 'Probability',
                                                 plot_var = chunk_var,
                                                 var_lab = paste(chunk_var_lab,' (m/s)',sep=''),
                                                 plot_type = 'nv',
                                                 title_lab = 'ABS',
                                                 Prior_RWD = 'Prior_RWD')

plots[[paste('Delta',chunk_var,sep='')]][['Prior_RWD']] <- Prob_plotting(data= filt_data,
                                                 prob_method = 'Probability',
                                                 plot_var = paste('Delta',chunk_var,sep=''),
                                                 var_lab = paste('Delta ',chunk_var_lab,' (m/s)',sep=''),
                                                 plot_type = 'nv',
                                                 title_lab = 'ABS',
                                                 Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[chunk_var]][['Prior_RWD']]
```

`r prior_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$test$pvalues[3],cur_plot$lm$test$pvalues[4],cur_plot$lme_test_Prior0$test$pvalues[2],cur_plot$lme_test_Prior1$test$pvalues[2],chunk_var_lab)`

The linear model used to predict the effect of probability and prior reward is:

$$ Outcome \sim Probability + Prior Reward + Probability*Prior Reward + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, fig.height = 5, fig.width = 10}

kable(pvalue_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = 'Peak Velocity P-Values for effect of Probability')

plot_grid(plots[[chunk_var]][['Prior_RWD']][['plot']]+theme(legend.position = 'none'),
          plots[[paste('Delta',chunk_var,sep='')]][['Prior_RWD']][['plot']]+theme(legend.position = 'none'),
          get_legend(plots[[chunk_var]][['Prior_RWD']][['plot']]),
          rel_widths = c(1,1,.2),
          ncol = 3)

```

### Change in Peak Velocity from previous trial due to Reward
```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']] <- Prob_plotting(data= filt_data,
                                                     prob_method = 'Probability',
                                                     plot_var = paste('DiffPrior_',chunk_var,sep=''),
                                                     var_lab = 'Peak Velocity Diff Prior (m/s)',
                                                     plot_type = 'bar',
                                                     title_lab = 'Diff',
                                                     Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']]

kable(ttest_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var,' Diff Prior P-Values for effect of Probability',sep=''))

```


`r priordiff_ttest_str_gen(cur_plot$t_test$p.value,cur_plot$t_test1$p.value,cur_plot$t_test0$p.value,chunk_var_lab)`

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']][['plot']]

```


### Interaction of Prior Reward and Change in Probability of Reward
```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']] <- Prob_plotting(data = filter(filt_data,Trial_in_Block>1),
                                                     prob_method = 'DiffPrior_Probability',
                                                     plot_var = paste('DiffPrior_',chunk_var,sep=''),
                                                     var_lab = 'Peak Velocity Diff Prior (m/s)',
                                                     plot_type = 'nv',
                                                     title_lab = 'Diff',
                                                     Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']]

kable(pvalue_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'DiffPrior_Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var,' Diff Prior P-Values for effect of Diff Probability',sep=''))

```
`r priordiffprob_str_gen(cur_plot$lm, cur_plot$lme_test_Prior1, cur_plot$lme_test_Prior0, chunk_var_lab, 'probability difference')`

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']][['plot']]

```

## RPE

```{r, echo = FALSE, warning = FALSE, message = FALSE}

cur_plot <- plots[[chunk_var]][['RPE_split_prob']]

```

The linear model used to predict the effect of RPE and prior reward is:

$$ Outcome \sim Probability + Prior Reward + Probability*Prior Reward + (1|Subject) $$

`r priorRPE_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$test$pvalues[3],cur_plot$lm$test$pvalues[4],cur_plot$lme_test_Prior0$test$pvalues[2],cur_plot$lme_test_Prior1$test$pvalues[2],chunk_var_lab)`


```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8}

kable(pvalue_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'prior_RPE',
                        Prior_RWD = 'Prior_RWD'),
      caption = 'Peak Velocity P-Values for effect of RPE')

kable(pvalue_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'prior_RPE',
                        Prior_RWD = 'NULL'),
      caption = 'Peak Velocity P-Values for effect of RPE')

cur_plot$plot

```

#### T-Tests
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = paste('DiffPrior_',chunk_var,sep=''),
                 plot_var_lab = paste(chunk_var_lab,' Diff Prior (m/s)',sep=''),
                 prob_metric = 'prior_RPE',
                 correction = 'holm')

```

These are the uncorrected paired t-test values
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = paste('DiffPrior_',chunk_var,sep=''),
                 plot_var_lab = paste(chunk_var_lab,' Diff Prior (m/s)',sep=''),
                 prob_metric = 'prior_RPE',
                 correction = 'none')
```

#### Summary Table RPE
```{r, echo = FALSE, warning = FALSE, message = FALSE}
summary_table_func(filt_data, 
                   prob_metric = 'prior_RPE', 
                   plot_var = paste('DiffPrior_',chunk_var,sep=''),
                   plot_var_lab = paste('Diff Prior ',chunk_var_lab,sep=''),
                   trial_or_subj = 'subj')

```

# Return PeakV
## Effect of Probability
```{r, echo = FALSE, warning = FALSE}
chunk_var = 'PeakVinout'
chunk_var_lab = 'PeakV - Return Peak Velocity'


plots[[chunk_var]][['abs']] <- Prob_plotting(data= filt_data,
                                                    prob_method = 'Probability',
                                                    plot_var = chunk_var,
                                                    var_lab = chunk_var_lab,
                                                    plot_type = 'nv',
                                                    title_lab = 'ABS',
                                                    Prior_RWD = '0')

plots[[chunk_var]][['RPE']] <- Prob_plotting(filt_data,
                                         prob_method = 'RPE',
                                         plot_var = paste(chunk_var,sep=''),
                                         var_lab = paste(chunk_var_lab, sep = ''),
                                         plot_type = 'NULL',
                                         Prior_RWD = 'NULL', 
                                         title_lab = 'Reward Prediction Error (RPE)')

plots[[chunk_var]][['RPE']][['plot']] <- plots[[chunk_var]][['RPE']][['plot']]+
  labs(x = 'Reward Prediction Error on CURRENT trial (RPE)')


plots[[chunk_var]][['Delta']] <- Prob_plotting(data= filt_data,
                                               prob_method = 'Probability',
                                               plot_var = paste('Delta',chunk_var,sep=''),
                                               var_lab = paste(chunk_var_lab,' DELTA (1/s)',sep=''),
                                               plot_type = 'nv',
                                               title_lab = 'DELTA',
                                               Prior_RWD = '0')

cur_plot = plots[[chunk_var]][['abs']]
```

`r prob_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$coef[2],chunk_var_lab)`

The equation below shows the linear model used:
$$ Outcome \sim Probability + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, fig.height = 5, fig.width = 10}
kable(pvalue_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'no'),
      caption = paste(chunk_var_lab,' P-Values for effect of Probability',sep=''))

plot_grid(plots[[chunk_var]][['abs']][['plot']],plots[[chunk_var]][['Delta']][['plot']],
          ncol=2)

```

We also compute an paired t-test with holm-bonferonni correction to determine if there are differences between individual conditions. The table below shows the results of the Tukey test (table \@ref(tab:returnpeakvposttab)).

```{r returnpeakvposttab, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = chunk_var,
                 plot_var_lab = chunk_var_lab,
                 prob_metric = 'Probability',
                 correction = 'hom')

```

These are the uncorrected paired t-test values
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = chunk_var,
                 plot_var_lab = chunk_var_lab,
                 prob_metric = 'Probability',
                 correction = 'none')
```


#### Summary Tables
```{r, echo = FALSE, warning = FALSE, message = FALSE}
summary_table_func(filt_data, 
                   prob_metric = 'Probability', 
                   plot_var = chunk_var, 
                   plot_var_lab = chunk_var_lab,
                   trial_or_subj = 'subj')
```

#### Comparison of 0% and 100% Reward

`r t14_str_gen(cur_plot$t_test$p.value,cur_plot$ano14[['Pr(>F)']][1],chunk_var_lab)`

## Effect of Trial

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Trial']] = trial_plotting(filt_data,chunk_var,paste(chunk_var_lab,' (1/s)',sep=''),chunk_var_lab)

```

`r plots[[chunk_var]][['Trial']][['trial_str']]`

The linear model used to predict effect of trial is shown below:
$$ Outcome \sim B*Trial + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[chunk_var]][['Trial']][['plot']]

```

## RPE

```{r, echo = FALSE, warning = FALSE, message = FALSE}

cur_plot <- plots[[chunk_var]][['RPE_split_prob']]

```

The linear model used to predict the effect of RPE is:

$$ Outcome \sim Probability + (1|Subject) $$
`r RPE_str_gen(cur_plot$lm$test$pvalues[2], 'PeakV-ReturnPeakV')`

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8}

kable(pvalue_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'RPE',
                        Prior_RWD = 'no'),
      caption = paste(chunk_var_lab,' P-Values for effect of RPE',sep=''))

cur_plot$plot 

```

#### T-Tests
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = chunk_var,
                 plot_var_lab = chunk_var_lab,
                 prob_metric = 'prior_RPE',
                 correction = 'holm')

```

These are the uncorrected paired t-test values
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = chunk_var,
                 plot_var_lab = chunk_var_lab,
                 prob_metric = 'prior_RPE',
                 correction = 'none')

```

#### Summary Table RPE
```{r, echo = FALSE, warning = FALSE, message = FALSE}
summary_table_func(filt_data, 
                   prob_metric = 'RPE', 
                   plot_var = chunk_var,
                   plot_var_lab = paste('Diff Prior ',chunk_var_lab,sep=''),
                   trial_or_subj = 'subj')

```

# Reaction Time
## Effect of Probability
```{r, echo = FALSE, warning = FALSE}
chunk_var = 'RT'
chunk_var_lab = 'Reaction Time'

plots[[chunk_var]][['Delta']] <- Prob_plotting(data= filt_data,
                                               prob_method = 'Probability',
                                               plot_var = paste('Delta',chunk_var,sep=''),
                                               var_lab = paste(chunk_var_lab,' DELTA (s)',sep=''),
                                               plot_type = 'nv',
                                               title_lab = 'DELTA',
                                               Prior_RWD = '0')

cur_plot = plots[[chunk_var]][['abs']]
```

`r prob_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$coef[2],chunk_var_lab)`

The equation below shows the linear model used:
$$ Outcome \sim Probability + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, fig.height = 5, fig.width = 10}
kable(pvalue_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'no'),
      caption = paste(chunk_var_lab,' P-Values for effect of Probability',sep=''))

plot_grid(plots[[chunk_var]][['abs']][['plot']],plots[[chunk_var]][['Delta']][['plot']],
          ncol=2)

```
```{r echo = FALSE}
# ggplot()+geom_violin(data = filter(filt_data,RT<.5 & RT > .1),aes(x=Probability,y=RT,group = Probability))+geom_line(data=aggregate(RT ~ Probability + Subject,filt_data,mean),aes(x = Probability, y = RT, group = factor(Subject)))+geom_point(data=aggregate(RT ~ Probability,filt_data,mean),aes(x=Probability,y=RT),size = 5)
```

We also compute an paired t-test with holm-bonferonni correction to determine if there are differences between individual conditions. The table below shows the results of the Tukey test (table \@ref(tab:rtttestposttab)).

```{r rtttestposttab, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = chunk_var,
                 plot_var_lab = chunk_var_lab,
                 prob_metric = 'Probability',
                 correction = 'hom')

```

These are the uncorrected paired t-test values
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = chunk_var,
                 plot_var_lab = chunk_var_lab,
                 prob_metric = 'Probability',
                 correction = 'none')
```


#### Summary Tables
```{r, echo = FALSE, warning = FALSE, message = FALSE}
summary_table_func(filt_data, 
                   prob_metric = 'Probability', 
                   plot_var = chunk_var, 
                   plot_var_lab = chunk_var_lab,
                   trial_or_subj = 'subj')
```

#### Comparison of 0% and 100% Reward

`r t14_str_gen(cur_plot$t_test$p.value,cur_plot$ano14[['Pr(>F)']][1],chunk_var_lab)`

## Effect of Trial

```{r, echo = FALSE, warning = FALSE}
Q = quantile(filt_data[[chunk_var]], probs=c(.25, .75), na.rm = FALSE)
iqr = IQR(filt_data[[chunk_var]])
high = Q[2]+1.5*iqr
low  = Q[1]-1.5*iqr

plots[[chunk_var]][['Trial']] = trial_plotting(filter(filt_data,RT < high & RT > low),chunk_var,paste(chunk_var_lab,' (s)',sep=''),chunk_var_lab)

```

`r plots[[chunk_var]][['Trial']][['trial_str']]`

The linear model used to predict effect of trial is shown below:
$$ Outcome \sim B*Trial + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[chunk_var]][['Trial']][['plot']]

```

## Reaction Time Following Reward

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Prior_RWD_bar']] <- Prob_plotting(data= filt_data,
                                                  prob_method = 'Probability',
                                                  plot_var = chunk_var,
                                                  var_lab = paste(chunk_var_lab,' (s)',sep=''),
                                                  plot_type = 'bar',
                                                  title_lab = 'ABS',
                                                  Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[chunk_var]][['Prior_RWD_bar']]
```

`r priorbar_str_gen(cur_plot$t_test$p.value,cur_plot$ano14[['Pr(>F)']][1],chunk_var_lab)`

```{r, echo = FALSE, warning = FALSE}
kable(ttest_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var_lab,' P-Values for effect of Probability',sep=''))

plots[[chunk_var]][['Prior_RWD_bar']][['plot']]

```

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Prior_RWD']] <- Prob_plotting(data= filt_data,
                                                 prob_method = 'Probability',
                                                 plot_var = chunk_var,
                                                 var_lab = paste(chunk_var_lab,' (s)',sep=''),
                                                 plot_type = 'nv',
                                                 title_lab = 'ABS',
                                                 Prior_RWD = 'Prior_RWD')

plots[[paste('Delta',chunk_var,sep='')]][['Prior_RWD']] <- Prob_plotting(data= filt_data,
                                                 prob_method = 'Probability',
                                                 plot_var = paste('Delta',chunk_var,sep=''),
                                                 var_lab = paste('Delta ',chunk_var_lab,' (s)',sep=''),
                                                 plot_type = 'nv',
                                                 title_lab = 'ABS',
                                                 Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[chunk_var]][['Prior_RWD']]
```

`r prior_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$test$pvalues[3],cur_plot$lm$test$pvalues[4],cur_plot$lme_test_Prior0$test$pvalues[2],cur_plot$lme_test_Prior1$test$pvalues[2],chunk_var_lab)`

The linear model used to predict the effect of probability and prior reward is:

$$ Outcome \sim Probability + Prior Reward + Probability*Prior Reward + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, fig.height = 5, fig.width = 10}

kable(pvalue_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = 'Peak Velocity P-Values for effect of Probability')

plot_grid(plots[[chunk_var]][['Prior_RWD']][['plot']]+theme(legend.position = 'none'),
          plots[[paste('Delta',chunk_var,sep='')]][['Prior_RWD']][['plot']]+theme(legend.position = 'none'),
          get_legend(plots[[chunk_var]][['Prior_RWD']][['plot']]),
          rel_widths = c(1,1,.2),
          ncol = 3)

```

### Change in Peak Velocity from previous trial due to Reward
```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']] <- Prob_plotting(data= filt_data,
                                                     prob_method = 'Probability',
                                                     plot_var = paste('DiffPrior_',chunk_var,sep=''),
                                                     var_lab = paste(chunk_var_lab,' Diff Prior (s)',sep=''),
                                                     plot_type = 'bar',
                                                     title_lab = 'Diff',
                                                     Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']]

kable(ttest_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var,' Diff Prior P-Values for effect of Probability',sep=''))

```


`r priordiff_ttest_str_gen(cur_plot$t_test$p.value,cur_plot$t_test1$p.value,cur_plot$t_test0$p.value,chunk_var_lab)`

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']][['plot']]

```


### Interaction of Prior Reward and Change in Probability of Reward
```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']] <- Prob_plotting(data = filter(filt_data,Trial_in_Block>1),
                                                     prob_method = 'DiffPrior_Probability',
                                                     plot_var = paste('DiffPrior_',chunk_var,sep=''),
                                                     var_lab = paste(chunk_var_lab,' Diff Prior (s)',sep=''),
                                                     plot_type = 'nv',
                                                     title_lab = 'Diff',
                                                     Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']]

kable(pvalue_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'DiffPrior_Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var,' Diff Prior P-Values for effect of Diff Probability',sep=''))

```
`r priordiffprob_str_gen(cur_plot$lm, cur_plot$lme_test_Prior1, cur_plot$lme_test_Prior0, chunk_var_lab, 'probability difference')`

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']][['plot']]

```

## RPE

```{r, echo = FALSE, warning = FALSE, message = FALSE}

cur_plot <- plots[[chunk_var]][['RPE_split_prob']]

```

The linear model used to predict the effect of RPE and prior reward is:

$$ Outcome \sim Probability + Prior Reward + Probability*Prior Reward + (1|Subject) $$

`r priorRPE_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$test$pvalues[3],cur_plot$lm$test$pvalues[4],cur_plot$lme_test_Prior0$test$pvalues[2],cur_plot$lme_test_Prior1$test$pvalues[2],chunk_var_lab)`


```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8}

kable(pvalue_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'prior_RPE',
                        Prior_RWD = 'Prior_RWD'),
      caption = 'Reaction Time P-Values for effect of RPE')

kable(pvalue_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'prior_RPE',
                        Prior_RWD = 'NULL'),
      caption = 'Reaction Time P-Values for effect of RPE')

cur_plot$plot

```

#### T-Tests
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = paste('DiffPrior_',chunk_var,sep=''),
                 plot_var_lab = paste(chunk_var_lab,' Diff Prior (m/s)',sep=''),
                 prob_metric = 'prior_RPE',
                 correction = 'holm')

```

These are the uncorrected paired t-test values
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = paste('DiffPrior_',chunk_var,sep=''),
                 plot_var_lab = paste(chunk_var_lab,' Diff Prior (m/s)',sep=''),
                 prob_metric = 'prior_RPE',
                 correction = 'none')
```

#### Summary Table RPE
```{r, echo = FALSE, warning = FALSE, message = FALSE}
summary_table_func(filt_data, 
                   prob_metric = 'prior_RPE', 
                   plot_var = paste('DiffPrior_',chunk_var,sep=''),
                   plot_var_lab = paste('Diff Prior ',chunk_var_lab,sep=''),
                   trial_or_subj = 'subj')

```

# Maximum Excursion
## Effect of Probability
```{r, echo = FALSE, warning = FALSE}
chunk_var = 'Max_Ex'
chunk_var_lab = 'Maximum Excursion'

plots[[chunk_var]][['Delta']] <- Prob_plotting(data= filt_data,
                                               prob_method = 'Probability',
                                               plot_var = paste('Delta',chunk_var,sep=''),
                                               var_lab = paste(chunk_var_lab,' DELTA (m)',sep=''),
                                               plot_type = 'nv',
                                               title_lab = 'DELTA',
                                               Prior_RWD = '0')

cur_plot = plots[[chunk_var]][['abs']]
```

`r prob_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$coef[2],chunk_var_lab)`

The equation below shows the linear model used:
$$ Outcome \sim Probability + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, fig.height = 5, fig.width = 10}
kable(pvalue_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'no'),
      caption = paste(chunk_var_lab,' P-Values for effect of Probability',sep=''))

plot_grid(plots[[chunk_var]][['abs']][['plot']],plots[[chunk_var]][['Delta']][['plot']],
          ncol=2)

```

We also compute an paired t-test with holm-bonferonni correction to determine if there are differences between individual conditions. The table below shows the results of the Tukey test (table \@ref(tab:maxexttestposttab)).

```{r maxesttestposttab, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = chunk_var,
                 plot_var_lab = chunk_var_lab,
                 prob_metric = 'Probability',
                 correction = 'hom')

```

These are the uncorrected paired t-test values
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = chunk_var,
                 plot_var_lab = chunk_var_lab,
                 prob_metric = 'Probability',
                 correction = 'none')
```


#### Summary Tables
```{r, echo = FALSE, warning = FALSE, message = FALSE}
summary_table_func(filt_data, 
                   prob_metric = 'Probability', 
                   plot_var = chunk_var, 
                   plot_var_lab = chunk_var_lab,
                   trial_or_subj = 'subj')
```

#### Comparison of 0% and 100% Reward

`r t14_str_gen(cur_plot$t_test$p.value,cur_plot$ano14[['Pr(>F)']][1],chunk_var_lab)`

## Effect of Trial

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Trial']] = trial_plotting(filt_data,chunk_var,paste(chunk_var_lab,' (m)',sep=''),chunk_var_lab)

```

`r plots[[chunk_var]][['Trial']][['trial_str']]`

The linear model used to predict effect of trial is shown below:
$$ Outcome \sim B*Trial + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[chunk_var]][['Trial']][['plot']]

```

## Maximum Excursion Following Reward

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Prior_RWD_bar']] <- Prob_plotting(data= filt_data,
                                                  prob_method = 'Probability',
                                                  plot_var = chunk_var,
                                                  var_lab = paste(chunk_var_lab,' (m)',sep=''),
                                                  plot_type = 'bar',
                                                  title_lab = 'ABS',
                                                  Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[chunk_var]][['Prior_RWD_bar']]
```

`r priorbar_str_gen(cur_plot$t_test$p.value,cur_plot$ano14[['Pr(>F)']][1],chunk_var_lab)`

```{r, echo = FALSE, warning = FALSE}
kable(ttest_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var_lab,' P-Values for effect of Probability',sep=''))

plots[[chunk_var]][['Prior_RWD_bar']][['plot']]

```

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Prior_RWD']] <- Prob_plotting(data= filt_data,
                                                 prob_method = 'Probability',
                                                 plot_var = chunk_var,
                                                 var_lab = paste(chunk_var_lab,' (m)',sep=''),
                                                 plot_type = 'nv',
                                                 title_lab = 'ABS',
                                                 Prior_RWD = 'Prior_RWD')

plots[[paste('Delta',chunk_var,sep='')]][['Prior_RWD']] <- Prob_plotting(data= filt_data,
                                                 prob_method = 'Probability',
                                                 plot_var = paste('Delta',chunk_var,sep=''),
                                                 var_lab = paste('Delta ',chunk_var_lab,' (m)',sep=''),
                                                 plot_type = 'nv',
                                                 title_lab = 'ABS',
                                                 Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[chunk_var]][['Prior_RWD']]
```

`r prior_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$test$pvalues[3],cur_plot$lm$test$pvalues[4],cur_plot$lme_test_Prior0$test$pvalues[2],cur_plot$lme_test_Prior1$test$pvalues[2],chunk_var_lab)`

The linear model used to predict the effect of probability and prior reward is:

$$ Outcome \sim Probability + Prior Reward + Probability*Prior Reward + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, fig.height = 5, fig.width = 10}

kable(pvalue_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = 'Peak Velocity P-Values for effect of Probability')

plot_grid(plots[[chunk_var]][['Prior_RWD']][['plot']]+theme(legend.position = 'none'),
          plots[[paste('Delta',chunk_var,sep='')]][['Prior_RWD']][['plot']]+theme(legend.position = 'none'),
          get_legend(plots[[chunk_var]][['Prior_RWD']][['plot']]),
          rel_widths = c(1,1,.2),
          ncol = 3)

```

### Change in Peak Velocity from previous trial due to Reward
```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']] <- Prob_plotting(data= filt_data,
                                                     prob_method = 'Probability',
                                                     plot_var = paste('DiffPrior_',chunk_var,sep=''),
                                                     var_lab = paste(chunk_var_lab,' Diff Prior (m)',sep=''),
                                                     plot_type = 'bar',
                                                     title_lab = 'Diff',
                                                     Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']]

kable(ttest_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var,' Diff Prior P-Values for effect of Probability',sep=''))

```


`r priordiff_ttest_str_gen(cur_plot$t_test$p.value,cur_plot$t_test1$p.value,cur_plot$t_test0$p.value,chunk_var_lab)`

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']][['plot']]

```


### Interaction of Prior Reward and Change in Probability of Reward
```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']] <- Prob_plotting(data = filter(filt_data,Trial_in_Block>1),
                                                     prob_method = 'DiffPrior_Probability',
                                                     plot_var = paste('DiffPrior_',chunk_var,sep=''),
                                                     var_lab = paste(chunk_var_lab,' Diff Prior (m)',sep=''),
                                                     plot_type = 'nv',
                                                     title_lab = 'Diff',
                                                     Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']]

kable(pvalue_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'DiffPrior_Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var,' Diff Prior P-Values for effect of Diff Probability',sep=''))

```
`r priordiffprob_str_gen(cur_plot$lm, cur_plot$lme_test_Prior1, cur_plot$lme_test_Prior0, chunk_var_lab, 'probability difference')`

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']][['plot']]

```

## RPE

```{r, echo = FALSE, warning = FALSE, message = FALSE}

cur_plot <- plots[[chunk_var]][['RPE_split_prob']]

```

The linear model used to predict the effect of RPE and prior reward is:

$$ Outcome \sim Probability + Prior Reward + Probability*Prior Reward + (1|Subject) $$

`r priorRPE_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$test$pvalues[3],cur_plot$lm$test$pvalues[4],cur_plot$lme_test_Prior0$test$pvalues[2],cur_plot$lme_test_Prior1$test$pvalues[2],chunk_var_lab)`


```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8}

kable(pvalue_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'prior_RPE',
                        Prior_RWD = 'Prior_RWD'),
      caption = 'Maximum Excursion P-Values for effect of RPE')

cur_plot$plot

```

#### T-Tests
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = paste('DiffPrior_',chunk_var,sep=''),
                 plot_var_lab = paste(chunk_var_lab,' Diff Prior (m/s)',sep=''),
                 prob_metric = 'prior_RPE',
                 correction = 'holm')

```

These are the uncorrected paired t-test values
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = paste('DiffPrior_',chunk_var,sep=''),
                 plot_var_lab = paste(chunk_var_lab,' Diff Prior (m/s)',sep=''),
                 prob_metric = 'prior_RPE',
                 correction = 'none')
```

#### Summary Table RPE
```{r, echo = FALSE, warning = FALSE, message = FALSE}
summary_table_func(filt_data, 
                   prob_metric = 'prior_RPE', 
                   plot_var = paste('DiffPrior_',chunk_var,sep=''),
                   plot_var_lab = paste('Diff Prior ',chunk_var_lab,sep=''),
                   trial_or_subj = 'subj')

```

# Movement Time
## Effect of Probability
```{r, echo = FALSE, warning = FALSE}
chunk_var = 'Duration'
chunk_var_lab = 'Movement Duration'

plots[[chunk_var]][['Delta']] <- Prob_plotting(data= filt_data,
                                               prob_method = 'Probability',
                                               plot_var = paste('Delta',chunk_var,sep=''),
                                               var_lab = paste(chunk_var_lab,' DELTA (s)',sep=''),
                                               plot_type = 'nv',
                                               title_lab = 'DELTA',
                                               Prior_RWD = '0')

cur_plot = plots[[chunk_var]][['abs']]
```

`r prob_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$coef[2],chunk_var_lab)`

The equation below shows the linear model used:
$$ Outcome \sim Probability + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, fig.height = 5, fig.width = 10}
kable(pvalue_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'no'),
      caption = paste(chunk_var_lab,' P-Values for effect of Probability',sep=''))

plot_grid(plots[[chunk_var]][['abs']][['plot']],plots[[chunk_var]][['Delta']][['plot']],
          ncol=2)

```

We also compute an paired t-test with holm-bonferonni correction to determine if there are differences between individual conditions. The table below shows the results of the Tukey test (table \@ref(tab:durationttestposttab)).

```{r durationttestposttab, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = chunk_var,
                 plot_var_lab = chunk_var_lab,
                 prob_metric = 'Probability',
                 correction = 'hom')

```

These are the uncorrected paired t-test values
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = chunk_var,
                 plot_var_lab = chunk_var_lab,
                 prob_metric = 'Probability',
                 correction = 'none')
```


#### Summary Tables
```{r, echo = FALSE, warning = FALSE, message = FALSE}
summary_table_func(filt_data, 
                   prob_metric = 'Probability', 
                   plot_var = chunk_var, 
                   plot_var_lab = chunk_var_lab,
                   trial_or_subj = 'subj')
```

#### Comparison of 0% and 100% Reward

`r t14_str_gen(cur_plot$t_test$p.value,cur_plot$ano14[['Pr(>F)']][1],chunk_var_lab)`

## Effect of Trial

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Trial']] = trial_plotting(filt_data,chunk_var,paste(chunk_var_lab,' (s)',sep=''),chunk_var_lab)

```

`r plots[[chunk_var]][['Trial']][['trial_str']]`

The linear model used to predict effect of trial is shown below:
$$ Outcome \sim B*Trial + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[chunk_var]][['Trial']][['plot']]

```

## Movement Duration Following Reward

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Prior_RWD_bar']] <- Prob_plotting(data= filt_data,
                                                  prob_method = 'Probability',
                                                  plot_var = chunk_var,
                                                  var_lab = paste(chunk_var_lab,' (s)',sep=''),
                                                  plot_type = 'bar',
                                                  title_lab = 'ABS',
                                                  Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[chunk_var]][['Prior_RWD_bar']]
```

`r priorbar_str_gen(cur_plot$t_test$p.value,cur_plot$ano14[['Pr(>F)']][1],chunk_var_lab)`

```{r, echo = FALSE, warning = FALSE}
kable(ttest_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var_lab,' P-Values for effect of Probability',sep=''))

plots[[chunk_var]][['Prior_RWD_bar']][['plot']]

```

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Prior_RWD']] <- Prob_plotting(data= filt_data,
                                                 prob_method = 'Probability',
                                                 plot_var = chunk_var,
                                                 var_lab = paste(chunk_var_lab,' (s)',sep=''),
                                                 plot_type = 'nv',
                                                 title_lab = 'ABS',
                                                 Prior_RWD = 'Prior_RWD')

plots[[paste('Delta',chunk_var,sep='')]][['Prior_RWD']] <- Prob_plotting(data= filt_data,
                                                 prob_method = 'Probability',
                                                 plot_var = paste('Delta',chunk_var,sep=''),
                                                 var_lab = paste('Delta ',chunk_var_lab,' (s)',sep=''),
                                                 plot_type = 'nv',
                                                 title_lab = 'ABS',
                                                 Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[chunk_var]][['Prior_RWD']]
```

`r prior_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$test$pvalues[3],cur_plot$lm$test$pvalues[4],cur_plot$lme_test_Prior0$test$pvalues[2],cur_plot$lme_test_Prior1$test$pvalues[2],chunk_var_lab)`

The linear model used to predict the effect of probability and prior reward is:

$$ Outcome \sim Probability + Prior Reward + Probability*Prior Reward + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, fig.height = 5, fig.width = 10}

kable(pvalue_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = 'Peak Velocity P-Values for effect of Probability')

plot_grid(plots[[chunk_var]][['Prior_RWD']][['plot']]+theme(legend.position = 'none'),
          plots[[paste('Delta',chunk_var,sep='')]][['Prior_RWD']][['plot']]+theme(legend.position = 'none'),
          get_legend(plots[[chunk_var]][['Prior_RWD']][['plot']]),
          rel_widths = c(1,1,.2),
          ncol = 3)

```

### Change in Peak Velocity from previous trial due to Reward
```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']] <- Prob_plotting(data= filt_data,
                                                     prob_method = 'Probability',
                                                     plot_var = paste('DiffPrior_',chunk_var,sep=''),
                                                     var_lab = paste(chunk_var_lab,' Diff Prior (s)',sep=''),
                                                     plot_type = 'bar',
                                                     title_lab = 'Diff',
                                                     Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']]

kable(ttest_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var,' Diff Prior P-Values for effect of Probability',sep=''))

```

`r priordiff_ttest_str_gen(cur_plot$t_test$p.value,cur_plot$t_test1$p.value,cur_plot$t_test0$p.value,chunk_var_lab)`

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']][['plot']]

```


### Interaction of Prior Reward and Change in Probability of Reward
```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']] <- Prob_plotting(data = filter(filt_data,Trial_in_Block>1),
                                                     prob_method = 'DiffPrior_Probability',
                                                     plot_var = paste('DiffPrior_',chunk_var,sep=''),
                                                     var_lab = paste(chunk_var_lab,' Diff Prior (s)',sep=''),
                                                     plot_type = 'nv',
                                                     title_lab = 'Diff',
                                                     Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']]

kable(pvalue_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'DiffPrior_Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var,' Diff Prior P-Values for effect of Diff Probability',sep=''))

```
`r priordiffprob_str_gen(cur_plot$lm, cur_plot$lme_test_Prior1, cur_plot$lme_test_Prior0, chunk_var_lab, 'probability difference')`

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']][['plot']]

```

## RPE

```{r, echo = FALSE, warning = FALSE, message = FALSE}

cur_plot <- plots[[chunk_var]][['RPE_split_prob']]

```

The linear model used to predict the effect of RPE and prior reward is:

$$ Outcome \sim Probability + Prior Reward + Probability*Prior Reward + (1|Subject) $$

`r priorRPE_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$test$pvalues[3],cur_plot$lm$test$pvalues[4],cur_plot$lme_test_Prior0$test$pvalues[2],cur_plot$lme_test_Prior1$test$pvalues[2],chunk_var_lab)`


```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8}

kable(pvalue_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'prior_RPE',
                        Prior_RWD = 'Prior_RWD'),
      caption = 'Movement Duration P-Values for effect of RPE')

cur_plot$plot

```

#### T-Tests
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = paste('DiffPrior_',chunk_var,sep=''),
                 plot_var_lab = paste(chunk_var_lab,' Diff Prior (m/s)',sep=''),
                 prob_metric = 'prior_RPE',
                 correction = 'holm')

```

These are the uncorrected paired t-test values
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = paste('DiffPrior_',chunk_var,sep=''),
                 plot_var_lab = paste(chunk_var_lab,' Diff Prior (m/s)',sep=''),
                 prob_metric = 'prior_RPE',
                 correction = 'none')
```

#### Summary Table RPE
```{r, echo = FALSE, warning = FALSE, message = FALSE}
summary_table_func(filt_data, 
                   prob_metric = 'prior_RPE', 
                   plot_var = paste('DiffPrior_',chunk_var,sep=''),
                   plot_var_lab = paste('Diff Prior ',chunk_var_lab,sep=''),
                   trial_or_subj = 'subj')

```

# Total Duration

Total time we define as reaction time plus movement time.

## Effect of Probability
```{r, echo = FALSE, warning = FALSE}
chunk_var = 'TotalDur'
chunk_var_lab = 'Total Duration'

plots[[chunk_var]][['Delta']] <- Prob_plotting(data= filt_data,
                                               prob_method = 'Probability',
                                               plot_var = paste('Delta',chunk_var,sep=''),
                                               var_lab = paste(chunk_var_lab,' DELTA (s)',sep=''),
                                               plot_type = 'nv',
                                               title_lab = 'DELTA',
                                               Prior_RWD = '0')

cur_plot = plots[[chunk_var]][['abs']]
```

`r prob_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$coef[2],chunk_var_lab)`

The equation below shows the linear model used:
$$ Outcome \sim Probability + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, fig.height = 5, fig.width = 10}
kable(pvalue_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'no'),
      caption = paste(chunk_var_lab,' P-Values for effect of Probability',sep=''))

plot_grid(plots[[chunk_var]][['abs']][['plot']],plots[[chunk_var]][['Delta']][['plot']],
          ncol=2)

```

We also compute an paired t-test with holm-bonferonni correction to determine if there are differences between individual conditions. The table below shows the results of the Tukey test (table \@ref(tab:totdurationttestposttab)).

```{r totdurationttestposttab, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = chunk_var,
                 plot_var_lab = chunk_var_lab,
                 prob_metric = 'Probability',
                 correction = 'hom')

```

These are the uncorrected paired t-test values
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = chunk_var,
                 plot_var_lab = chunk_var_lab,
                 prob_metric = 'Probability',
                 correction = 'none')
```


#### Summary Tables
```{r, echo = FALSE, warning = FALSE, message = FALSE}
summary_table_func(filt_data, 
                   prob_metric = 'Probability', 
                   plot_var = chunk_var, 
                   plot_var_lab = chunk_var_lab,
                   trial_or_subj = 'subj')
```

#### Comparison of 0% and 100% Reward

`r t14_str_gen(cur_plot$t_test$p.value,cur_plot$ano14[['Pr(>F)']][1],chunk_var_lab)`

## Effect of Trial

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Trial']] = trial_plotting(filt_data,chunk_var,paste(chunk_var_lab,' (s)',sep=''),chunk_var_lab)

```

`r plots[[chunk_var]][['Trial']][['trial_str']]`

The linear model used to predict effect of trial is shown below:
$$ Outcome \sim B*Trial + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[chunk_var]][['Trial']][['plot']]

```

## Total Time Following Reward

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Prior_RWD_bar']] <- Prob_plotting(data= filt_data,
                                                  prob_method = 'Probability',
                                                  plot_var = chunk_var,
                                                  var_lab = paste(chunk_var_lab,' (s)',sep=''),
                                                  plot_type = 'bar',
                                                  title_lab = 'ABS',
                                                  Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[chunk_var]][['Prior_RWD_bar']]
```

`r priorbar_str_gen(cur_plot$t_test$p.value,cur_plot$ano14[['Pr(>F)']][1],chunk_var_lab)`

```{r, echo = FALSE, warning = FALSE}
kable(ttest_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var_lab,' P-Values for effect of Probability',sep=''))

plots[[chunk_var]][['Prior_RWD_bar']][['plot']]

```

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Prior_RWD']] <- Prob_plotting(data= filt_data,
                                                 prob_method = 'Probability',
                                                 plot_var = chunk_var,
                                                 var_lab = paste(chunk_var_lab,' (s)',sep=''),
                                                 plot_type = 'nv',
                                                 title_lab = 'ABS',
                                                 Prior_RWD = 'Prior_RWD')

plots[[paste('Delta',chunk_var,sep='')]][['Prior_RWD']] <- Prob_plotting(data= filt_data,
                                                 prob_method = 'Probability',
                                                 plot_var = paste('Delta',chunk_var,sep=''),
                                                 var_lab = paste('Delta ',chunk_var_lab,' (s)',sep=''),
                                                 plot_type = 'nv',
                                                 title_lab = 'ABS',
                                                 Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[chunk_var]][['Prior_RWD']]
```

`r prior_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$test$pvalues[3],cur_plot$lm$test$pvalues[4],cur_plot$lme_test_Prior0$test$pvalues[2],cur_plot$lme_test_Prior1$test$pvalues[2],chunk_var_lab)`

The linear model used to predict the effect of probability and prior reward is:

$$ Outcome \sim Probability + Prior Reward + Probability*Prior Reward + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, fig.height = 5, fig.width = 10}

kable(pvalue_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = 'Peak Velocity P-Values for effect of Probability')

plot_grid(plots[[chunk_var]][['Prior_RWD']][['plot']]+theme(legend.position = 'none'),
          plots[[paste('Delta',chunk_var,sep='')]][['Prior_RWD']][['plot']]+theme(legend.position = 'none'),
          get_legend(plots[[chunk_var]][['Prior_RWD']][['plot']]),
          rel_widths = c(1,1,.2),
          ncol = 3)

```

### Change in Peak Velocity from previous trial due to Reward
```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']] <- Prob_plotting(data= filt_data,
                                                     prob_method = 'Probability',
                                                     plot_var = paste('DiffPrior_',chunk_var,sep=''),
                                                     var_lab = paste(chunk_var_lab,' Diff Prior (s)',sep=''),
                                                     plot_type = 'bar',
                                                     title_lab = 'Diff',
                                                     Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']]

kable(ttest_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var,' Diff Prior P-Values for effect of Probability',sep=''))

```


`r priordiff_ttest_str_gen(cur_plot$t_test$p.value,cur_plot$t_test1$p.value,cur_plot$t_test0$p.value,chunk_var_lab)`

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']][['plot']]

```


### Interaction of Prior Reward and Change in Probability of Reward
```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']] <- Prob_plotting(data = filter(filt_data,Trial_in_Block>1),
                                                     prob_method = 'DiffPrior_Probability',
                                                     plot_var = paste('DiffPrior_',chunk_var,sep=''),
                                                     var_lab = paste(chunk_var_lab,' Diff Prior (s)',sep=''),
                                                     plot_type = 'nv',
                                                     title_lab = 'Diff',
                                                     Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']]

kable(pvalue_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'DiffPrior_Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var,' Diff Prior P-Values for effect of Diff Probability',sep=''))

```
`r priordiffprob_str_gen(cur_plot$lm, cur_plot$lme_test_Prior1, cur_plot$lme_test_Prior0, chunk_var_lab, 'probability difference')`

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']][['plot']]

```

## RPE

```{r, echo = FALSE, warning = FALSE, message = FALSE}

cur_plot <- plots[[chunk_var]][['RPE_split_prob']]

```

The linear model used to predict the effect of RPE and prior reward is:

$$ Outcome \sim Probability + Prior Reward + Probability*Prior Reward + (1|Subject) $$

`r priorRPE_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$test$pvalues[3],cur_plot$lm$test$pvalues[4],cur_plot$lme_test_Prior0$test$pvalues[2],cur_plot$lme_test_Prior1$test$pvalues[2],chunk_var_lab)`


```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8}

kable(pvalue_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'prior_RPE',
                        Prior_RWD = 'Prior_RWD'),
      caption = 'Total Duration P-Values for effect of RPE')

cur_plot$plot

```

#### T-Tests
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = paste('DiffPrior_',chunk_var,sep=''),
                 plot_var_lab = paste(chunk_var_lab,' Diff Prior (m/s)',sep=''),
                 prob_metric = 'prior_RPE',
                 correction = 'holm')

```

These are the uncorrected paired t-test values
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = paste('DiffPrior_',chunk_var,sep=''),
                 plot_var_lab = paste(chunk_var_lab,' Diff Prior (m/s)',sep=''),
                 prob_metric = 'prior_RPE',
                 correction = 'none')
```

#### Summary Table RPE
```{r, echo = FALSE, warning = FALSE, message = FALSE}
summary_table_func(filt_data, 
                   prob_metric = 'prior_RPE', 
                   plot_var = paste('DiffPrior_',chunk_var,sep=''),
                   plot_var_lab = paste('Diff Prior ',chunk_var_lab,sep=''),
                   trial_or_subj = 'subj')

```

# Vigor

Vigor we define as (1/( Reaction Time + Movement Time)).

## Effect of Probability
```{r, echo = FALSE, warning = FALSE}
chunk_var = 'TotalDur'
chunk_var_lab = 'Total Duration'

plots[[chunk_var]][['Delta']] <- Prob_plotting(data= filt_data,
                                               prob_method = 'Probability',
                                               plot_var = paste('Delta',chunk_var,sep=''),
                                               var_lab = paste(chunk_var_lab,' DELTA (1/s)',sep=''),
                                               plot_type = 'nv',
                                               title_lab = 'DELTA',
                                               Prior_RWD = '0')

cur_plot = plots[[chunk_var]][['abs']]
```

`r prob_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$coef[2],chunk_var_lab)`

The equation below shows the linear model used:
$$ Outcome \sim Probability + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, fig.height = 5, fig.width = 10}
kable(pvalue_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'no'),
      caption = paste(chunk_var_lab,' P-Values for effect of Probability',sep=''))

plot_grid(plots[[chunk_var]][['abs']][['plot']],plots[[chunk_var]][['Delta']][['plot']],
          ncol=2)

```

We also compute an paired t-test with holm-bonferonni correction to determine if there are differences between individual conditions. The table below shows the results of the Tukey test (table \@ref(tab:vigorttestposttab)).

```{r vigorttestposttab, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = chunk_var,
                 plot_var_lab = chunk_var_lab,
                 prob_metric = 'Probability',
                 correction = 'hom')

```

These are the uncorrected paired t-test values
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = chunk_var,
                 plot_var_lab = chunk_var_lab,
                 prob_metric = 'Probability',
                 correction = 'none')
```

#### Summary Tables
```{r, echo = FALSE, warning = FALSE, message = FALSE}
summary_table_func(filt_data, 
                   prob_metric = 'Probability', 
                   plot_var = chunk_var, 
                   plot_var_lab = chunk_var_lab,
                   trial_or_subj = 'subj')
```

#### Comparison of 0% and 100% Reward

`r t14_str_gen(cur_plot$t_test$p.value,cur_plot$ano14[['Pr(>F)']][1],chunk_var_lab)`

## Effect of Trial

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Trial']] = trial_plotting(filt_data,chunk_var,paste(chunk_var_lab,' (1/s)',sep=''),chunk_var_lab)

```

`r plots[[chunk_var]][['Trial']][['trial_str']]`

The linear model used to predict effect of trial is shown below:
$$ Outcome \sim B*Trial + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[chunk_var]][['Trial']][['plot']]

```

## Vigor Following Reward

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Prior_RWD_bar']] <- Prob_plotting(data= filt_data,
                                                  prob_method = 'Probability',
                                                  plot_var = chunk_var,
                                                  var_lab = paste(chunk_var_lab,' (1/s)',sep=''),
                                                  plot_type = 'bar',
                                                  title_lab = 'ABS',
                                                  Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[chunk_var]][['Prior_RWD_bar']]
```

`r priorbar_str_gen(cur_plot$t_test$p.value,cur_plot$ano14[['Pr(>F)']][1],chunk_var_lab)`

```{r, echo = FALSE, warning = FALSE}
kable(ttest_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var_lab,' P-Values for effect of Probability',sep=''))

plots[[chunk_var]][['Prior_RWD_bar']][['plot']]

```

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Prior_RWD']] <- Prob_plotting(data= filt_data,
                                                 prob_method = 'Probability',
                                                 plot_var = chunk_var,
                                                 var_lab = paste(chunk_var_lab,' (1/s)',sep=''),
                                                 plot_type = 'nv',
                                                 title_lab = 'ABS',
                                                 Prior_RWD = 'Prior_RWD')

plots[[paste('Delta',chunk_var,sep='')]][['Prior_RWD']] <- Prob_plotting(data= filt_data,
                                                 prob_method = 'Probability',
                                                 plot_var = paste('Delta',chunk_var,sep=''),
                                                 var_lab = paste('Delta ',chunk_var_lab,' (1/s)',sep=''),
                                                 plot_type = 'nv',
                                                 title_lab = 'ABS',
                                                 Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[chunk_var]][['Prior_RWD']]
```

`r prior_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$test$pvalues[3],cur_plot$lm$test$pvalues[4],cur_plot$lme_test_Prior0$test$pvalues[2],cur_plot$lme_test_Prior1$test$pvalues[2],chunk_var_lab)`

The linear model used to predict the effect of probability and prior reward is:

$$ Outcome \sim Probability + Prior Reward + Probability*Prior Reward + (1|Subject) $$

```{r, echo = FALSE, warning = FALSE, fig.height = 5, fig.width = 10}

kable(pvalue_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = 'Peak Velocity P-Values for effect of Probability')

plot_grid(plots[[chunk_var]][['Prior_RWD']][['plot']]+theme(legend.position = 'none'),
          plots[[paste('Delta',chunk_var,sep='')]][['Prior_RWD']][['plot']]+theme(legend.position = 'none'),
          get_legend(plots[[chunk_var]][['Prior_RWD']][['plot']]),
          rel_widths = c(1,1,.2),
          ncol = 3)

```

### Change in Peak Velocity from previous trial due to Reward
```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']] <- Prob_plotting(data= filt_data,
                                                     prob_method = 'Probability',
                                                     plot_var = paste('DiffPrior_',chunk_var,sep=''),
                                                     var_lab = paste(chunk_var_lab,' Diff Prior (1/s)',sep=''),
                                                     plot_type = 'bar',
                                                     title_lab = 'Diff',
                                                     Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']]

kable(ttest_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var,' Diff Prior P-Values for effect of Probability',sep=''))

```


`r priordiff_ttest_str_gen(cur_plot$t_test$p.value,cur_plot$t_test1$p.value,cur_plot$t_test0$p.value,chunk_var_lab)`

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']][['plot']]

```


### Interaction of Prior Reward and Change in Probability of Reward
```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']] <- Prob_plotting(data = filter(filt_data,Trial_in_Block>1),
                                                     prob_method = 'DiffPrior_Probability',
                                                     plot_var = paste('DiffPrior_',chunk_var,sep=''),
                                                     var_lab = paste(chunk_var_lab,' Diff Prior (1/s)',sep=''),
                                                     plot_type = 'nv',
                                                     title_lab = 'Diff',
                                                     Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']]

kable(pvalue_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'DiffPrior_Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var,' Diff Prior P-Values for effect of Diff Probability',sep=''))

```
`r priordiffprob_str_gen(cur_plot$lm, cur_plot$lme_test_Prior1, cur_plot$lme_test_Prior0, chunk_var_lab, 'probability difference')`

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']][['plot']]

```

## RPE

```{r, echo = FALSE, warning = FALSE, message = FALSE}

cur_plot <- plots[[chunk_var]][['RPE_split_prob']]

```

The linear model used to predict the effect of RPE and prior reward is:

$$ Outcome \sim Probability + Prior Reward + Probability*Prior Reward + (1|Subject) $$

`r priorRPE_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$test$pvalues[3],cur_plot$lm$test$pvalues[4],cur_plot$lme_test_Prior0$test$pvalues[2],cur_plot$lme_test_Prior1$test$pvalues[2],chunk_var_lab)`


```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8}

kable(pvalue_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'prior_RPE',
                        Prior_RWD = 'Prior_RWD'),
      caption = 'Vigor P-Values for effect of RPE')

cur_plot$plot

```

#### T-Tests
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = paste('DiffPrior_',chunk_var,sep=''),
                 plot_var_lab = paste(chunk_var_lab,' Diff Prior (m/s)',sep=''),
                 prob_metric = 'prior_RPE',
                 correction = 'holm')

```

These are the uncorrected paired t-test values
```{r, echo = FALSE, warning = FALSE, message = FALSE}

ttest_post_table(data = filt_data,
                 plot_var = paste('DiffPrior_',chunk_var,sep=''),
                 plot_var_lab = paste(chunk_var_lab,' Diff Prior (m/s)',sep=''),
                 prob_metric = 'prior_RPE',
                 correction = 'none')
```

#### Summary Table RPE
```{r, echo = FALSE, warning = FALSE, message = FALSE}
summary_table_func(filt_data, 
                   prob_metric = 'prior_RPE', 
                   plot_var = paste('DiffPrior_',chunk_var,sep=''),
                   plot_var_lab = paste('Diff Prior ',chunk_var_lab,sep=''),
                   trial_or_subj = 'subj')

```
