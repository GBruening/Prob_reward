---
title: "Prob_RWD_exp"
author: "Garrick Bruening"
output:
  bookdown::html_document2:
    toc: true
  bookdown::pdf_document2: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(ggthemes)
library(lmtest)
library(tidyr)
library(dplyr)
library(multcomp)
library(lme4)
library(nlstools)
library(knitr)
library("RColorBrewer")
library(wesanderson)
library(extrafont)
library(cowplot)
library(latex2exp)
library('R.matlab')
library(boot)
library(viridis)
library(english)

#====================== Load Fonts ================
# font_import()
loadfonts(device='win')

theme_set(theme_classic(base_family = "Times")+
            theme(text = element_text(color='black'),
                  axis.text.x = element_text(color='black'),
                  axis.text.y = element_text(color='black'),
                  axis.ticks  = element_line(color='black'),
                  axis.line = element_line(color='black',linetype='solid'),
                  plot.title = element_text(hjust = 0.5)))

# # Set these lines to the base directory of the experiment.
# setwd('d:/Users/Gary/Google Drive/Yan Experiment')
# setwd('F:/Google Drive/Yan Experiment')
main_folder = 'D:/Google Drive/Yan Experiment'
setwd(main_folder)

exp_name = '4t_180trial_4block'
setwd(exp_name)
raw_data = read.csv(paste('vigor_conf_',exp_name,'.csv',sep=''))

raw_data$vigor = 1/(raw_data$react_time+raw_data$move_dur)
raw_data$total_dur = raw_data$react_time+raw_data$move_dur

#====================== Filter and add Probs ================
rm_fail_data = raw_data[raw_data$rewarded != -1,]
famil_data = filter(rm_fail_data,trial<=16)
prefilt_data = filter(rm_fail_data,trial<=(16+36))

non_famil_data = rm_fail_data[rm_fail_data$trial >= 17,]

trials = c()
counter = 1
subj = 1
for (k in 1:length(non_famil_data$trial)){
  if (non_famil_data[k,]$subj!=subj){
    counter = 1
    subj = non_famil_data[k,]$subj
  }
  trials = c(trials,counter)
  if (non_famil_data[k,'diff_prob']>0){
    non_famil_data[k,'diff_prob'] = non_famil_data[k,'diff_prob']-.01
  }
  counter = counter + 1
}
non_famil_data$trial_in_block= (trials-1)%%180+1

blocks = c()
probs = c()
counter = 1
subj = 1
block = 1

block_prob = matrix(c(1,.66,.33,0,.33,0,1,.66,0,1,.66,.33,.66,.33,0,1),
                    nrow = 4,
                    byrow = TRUE)

for (k in 1:length(non_famil_data$trial)){
  if (non_famil_data[k,]$subj!=subj){
    subj = non_famil_data[k,]$subj
    block = 1
  }
  blocks = c(blocks,block)
  probs = c(probs,block_prob[block,non_famil_data[k,]$target])
  if (non_famil_data[k,]$trial_in_block == 180){
    block = block + 1
  }
}
non_famil_data$probs = round(probs,2)
non_famil_data$block = blocks

# ==================== Renaming =================
dan_names = c('Subject',
              'Trial',
              'Block',
              'Prior_RWD',
              'Target',
              'Probability',
              'Vigor',
              'Duration',
              'TotalDur',
              'PeakV',
              'ReturnPeakV',
              'RT',
              'RWD',
              'Error_Dist',
              'Error_Ang',
              'Ret_Error',
              'Max_Ex',
              'Trial_in_Block',
              'Target_num',
              'NRWD_Run',
              'DiffCur_Prob')

gary_names = c('subj',
               'trial',
               'block',
               'one_back_rate',
               'target',
               'probs',
               'vigor',
               'move_dur',
               'total_dur',
               'peak_vel',
               'peak_vel_moveback',
               'react_time',
               'rewarded',
               'error_dist',
               'error_angle',
               'move_back_error',
               'maxex',
               'trial_in_block',
               'target_num',
               't_since_reward',
               'diff_prob')

k = 0
for (dan_name in dan_names){
  k = k+1
  names(non_famil_data)[names(non_famil_data) == gary_names[k]] <- dan_name
}
names(non_famil_data)[names(non_famil_data) == 'react_vel'] <- 'RT_vel'

#====================== Create Data Frame Variable Names ================
testable_vars_abs = c('Vigor',
                      'TotalDur',
                      'Duration',
                      'PeakV',
                      'ReturnPeakV',
                      'RT',
                      'RT_vel',
                      'Error_Dist',
                      'Error_Ang',
                      'Ret_Error',
                      'Max_Ex')

testable_labels_abs = c('Vigor (???)',
                        'Total Duration (s)',
                        'Movement Duration (s)',
                        'Peak Velocity (m/s)',
                        'Peak Velocity Moveback (m/s)',
                        'Reaction time (s)',
                        'Reaction Velocity (m/s)',
                        'Error Distance (m)',
                        'Error Angle (deg)',
                        'Return Error (m)',
                        'Maximum Excursion (m)')

testable_vars_norm = c('NormVigor',
                       'NormTotalDur',
                       'NormDuration',
                       'NormPeakV',
                       'NormReturnPeakV',
                       'NormRT',
                       'NormRT_vel',
                       'NormError_Dist',
                       'NormError_Ang',
                       'NormRet_Error',
                       'NormMax_Ex')

testable_labels_norm = c('Vigor Norm (???)',
                         'Total Duration Norm (s)',
                         'Movement Duration Norm (s)',
                         'Peak Velocity Norm (m/s)',
                         'Peak Velocity Moveback Norm (m/s)',
                         'Reaction time Norm (s)',
                         'Reaction Velocity Norm (m/s)',
                         'Error Distance Norm (m)',
                         'Error Angle Norm (deg)',
                         'Return Error Norm (m)',
                         'Maximum Excursion Norm (m)')

testable_vars_diff = c('DeltaVigor',
                       'DeltaTotalDur',
                       'DeltaDuration',
                       'DeltaPeakV',
                       'DeltaReturnPeakV',
                       'DeltaRT',
                       'DeltaRT_vel',
                       'DeltaError_Dist',
                       'DeltaError_Ang',
                       'DeltaRet_Error',
                       'DeltaMax_Ex')

testable_labels_diff = c('Vigor Delta (???)',
                         'Total Duration Delta (s)',
                         'Movement Duration Delta (s)',
                         'Peak Velocity Delta (m/s)',
                         'Peak Velocity Moveback Delta (m/s)',
                         'Reaction time Delta (s)',
                         'Reaction Velocity Delta (m/s)',
                         'Error Distance Delta (m)',
                         'Error Angle Delta (deg)',
                         'Return Error Delta (m)',
                         'Maximum Excursion Delta (m)')

# CHECK RADIAL VELOCITY?
#====================== Add Normalization ================
# Add Normalization to Not Filtered data.

add_norm_diff_func <- function(data, item){
  data[,paste('Norm',item,sep='')] = 0
  data[,paste('Delta',item,sep='')] = 0
  item_norm = paste('Norm',item,sep='')
  item_diff = paste('Delta',item,sep='')
  
  for (Subject_num in unique(data$Subject)){
    mean_0 = mean(data[data$r_prob==0 & data$Subject == Subject_num,item])
    
    data[data$Subject == Subject_num, item_norm] <- data[data$Subject == Subject_num, item]/mean_0
    data[data$Subject == Subject_num, item_diff] <- data[data$Subject == Subject_num, item]-mean_0
    # for (tar in unique(data$Target)){
    #   mean_0 = mean(data[data$r_prob==0 & data$Subject == Subject_num & data$Target == tar,item])
    #   
    #   data[data$Subject == Subject_num & data$Target == tar,item_norm] <- data[data$Subject == Subject_num & data$Target == tar,item]/mean_0
    #   data[data$Subject == Subject_num & data$Target == tar,item_diff] <- data[data$Subject == Subject_num & data$Target == tar,item]-mean_0
    # }
  }
  return(data)
}

for (item in testable_vars_abs){
  non_famil_data <- add_norm_diff_func(non_famil_data,item)
}

# Init some lists
ano_res <- list()
ano14 <- list()
lme_test <- list()
lme_test_t14 <- list()

# ============ Add Prior Trial Differences ========
prior_trial_vars = c('Probability',
                     'PeakV',
                     'NormPeakV',
                     'DeltaPeakV',
                     'RT')
for (k in 1:length(non_famil_data$Subject)){
  for (item in prior_trial_vars){
    if (non_famil_data[k,'Trial_in_Block'] == 1){
      non_famil_data[k,paste('DiffPrior_',item,sep='')] = 0
    } else {
      non_famil_data[k,paste('DiffPrior_',item,sep='')] = round(as.numeric(non_famil_data[k,item]-non_famil_data[k-1,item]),2)
    }
  }
}
non_famil_data[non_famil_data$DiffPrior_Prob == -0.67, 'DiffPrior_Probability'] = non_famil_data[non_famil_data$DiffPrior_Prob == -0.67, 'DiffPrior_Probability']+0.01
non_famil_data[non_famil_data$DiffPrior_Prob == -0.34, 'DiffPrior_Probability'] = non_famil_data[non_famil_data$DiffPrior_Prob == -0.34, 'DiffPrior_Probability']+0.01
non_famil_data[non_famil_data$DiffPrior_Prob == 0.67, 'DiffPrior_Probability'] = non_famil_data[non_famil_data$DiffPrior_Prob == 0.67, 'DiffPrior_Probability']-0.01
non_famil_data[non_famil_data$DiffPrior_Prob == 0.34, 'DiffPrior_Probability'] = non_famil_data[non_famil_data$DiffPrior_Prob == 0.34, 'DiffPrior_Probability']-0.01

add_n_back <- function(data,n_back){
  data[1,paste(as.english(n_back),'_back_rate',sep='')] = 0
  data[1,paste(as.english(n_back),'_back_rate_tar',sep='')] = 0
  for (k in 1:length(data[,'Subject'])){
    subject = data[k,'Subject']
    block = data[k,'Block']
    cur_tar = data[k,'Target']
    cur_trial = data[k,'Trial_in_Block']
    
    rate = 0
    tar_rate = 0
    nb = 0
    last_back = cur_trial-n_back
    
    if (last_back <= 0){
      last_back = 1
    }
    if(cur_trial == 1){
      rate = 0
      tar_rate = 0
    } else {
      for (j in (cur_trial-1):last_back){
        nb = nb + 1
        rate = rate + (.5^(nb))*data[data[,'Subject'] == subject & data[,'Block'] == block & data[,'Trial_in_Block'] == j,'RWD']
        
        if (data[j,'Target'] == cur_tar){
          tar_rate = tar_rate + (.5^(nb))*data[j,'RWD']
        } else{
          tar_rate = tar_rate + (.25^(nb))*data[j,'RWD']
        }
      }
    }
    data[k,paste(as.english(n_back),'_back_rate',sep='')] = rate
    data[k,paste(as.english(n_back),'_back_rate_tar',sep='')] = tar_rate
  }
  return(data)
}

for (n_back in c(1)){#},3,5,10)){
  non_famil_data <- add_n_back(non_famil_data,n_back)
}
non_famil_data$one_back_rate <- non_famil_data$one_back_rate*2
non_famil_data$Prior_RWD <- non_famil_data$one_back_rate

# 'RWD_Run', #
# 'NRWD_Run', #
# 'Prior_Target', #
# 'Prior_Prob', #
# 'Ave_2_RWD', # Number of rewards not average
# 'Ave_3_RWD', # Change to num 2 reward
# 'Ave_4_RWD', #
# 'Ave_5_RWD', #
# 'Ave_10_RWD', #
# 'Ave_2_Prob', # Average of 
# 'Ave_3_Prob', #
# 'Ave_4_Prob', #
# 'Ave_5_Prob', #
# 'Ave_10_Prob', #

#====================== Plotting Function ================
Prob_plotting <- function(data,
                          prob_method = 'Probability',
                          # norm_meth = 'abs',
                          plot_var,
                          var_lab,
                          plot_type = 'nv',
                          Prior_RWD = 'Prior_RWD',
                          title_lab = 'Null',
                          titles = 'Null'){

  
  plotting_data = data[,c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability',prob_method,plot_var)]
  colnames(plotting_data) = c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability','probability_metric', 'plot_var')
  
  if (Prior_RWD == 'Prior_RWD'){
    
    lme_test <- cftest(lmer(plot_var ~ probability_metric*Prior_RWD + (1|Subject), data = plotting_data))
    lme_test_t14 <- cftest(lmer(plot_var ~ probability_metric*Prior_RWD + (1|Subject), 
                                data = rbind(filter(plotting_data,probability_metric==1),
                                             filter(plotting_data,probability_metric==0))))
    
    #============= No Facet Abs
    a1 = aggregate(plot_var ~ probability_metric + Prior_RWD + Subject, plotting_data,mean)
    a  = aggregate(plot_var ~ probability_metric + Prior_RWD ,a1,mean)
    b  = aggregate(plot_var ~ probability_metric + Prior_RWD ,a1,sd)/sqrt(max(a1$Subject))#/sqrt(length(plotting_data[,1]))
    c  = cbind(a,b$plot_var)
    colnames(c) = c('probability_metric','Prior_RWD','plot_var','plot_var_se')
    
    if (plot_type == 'bar'){
      
      df_subj = aggregate(plot_var ~ Prior_RWD + Subject, plotting_data, mean)
      df2_mean = aggregate(plot_var ~ Prior_RWD, df_subj, mean)
      df2_sd   = aggregate(plot_var ~ Prior_RWD, df_subj, sd)/sqrt(max(df_subj$Subject))
      df2 = cbind(df2_mean,df2_sd$plot_var)
      colnames(df2) <- c('Prior_RWD','plot_var','plot_var_se')
      
      lme_test = cftest(lmer(plot_var ~ Prior_RWD + (1|Subject), df_subj))
      ano14 = anova(lm(plot_var ~ Prior_RWD+(1|Subject), df_subj))
      t_test = t.test(df_subj[df_subj$Prior_RWD == 0,'plot_var'], df_subj[df_subj$Prior_RWD == 1,'plot_var'], paired = TRUE)
      t_test0 = t.test(df_subj[df_subj$Prior_RWD == 0,'plot_var'])
      t_test1 = t.test(df_subj[df_subj$Prior_RWD == 1,'plot_var'])
      
      g <- ggplot()+
        geom_bar(data = df2,
                 aes(x = Prior_RWD,
                     y = plot_var,
                     fill = factor(Prior_RWD)),
                 position = 'dodge',
                 stat = 'identity')+
        geom_errorbar(data = df2,
                      aes(x = Prior_RWD,
                          ymin = plot_var-plot_var_se,
                          ymax = plot_var+plot_var_se),
                      width = 0.5,
                      size = 2)+
        geom_line(data = df_subj,
                  aes(x = Prior_RWD,
                      y = plot_var,
                      group = Subject))+
        labs(x = 'Prior Reward',
             y = var_lab,
             fill = 'Prior\nReward',
             title = paste('LMER P-Values.\nPrior RWD: ',
                           formatC(lme_test$test$pvalues[2],format="e",digits = 3),
                           '\nSlope: ',
                           formatC(lme_test$test$coefficients[2],format="e",digits = 3)))
      ret_list <- list('lm' = lme_test,'plot' = g, 't_test' = t_test, 'ano14' = ano14, 't_test0' = t_test0, 't_test1' = t_test1)
      return(ret_list)
      
    } else {
      
      lme_test <- cftest(lmer(plot_var ~ probability_metric*Prior_RWD + (1|Subject), data = plotting_data))
      lme_test_t14 <- cftest(lmer(plot_var ~ probability_metric*Prior_RWD + (1|Subject), 
                                  data = rbind(filter(plotting_data,probability_metric==1),
                                               filter(plotting_data,probability_metric==0))))
      
      lme_test_Prior1 <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), 
                                     data = filter(plotting_data,Prior_RWD==1)))
      lme_test_Prior0 <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), 
                                     data = filter(plotting_data,Prior_RWD==0)))
      
      #============= No Facet Abs
      a1 = aggregate(plot_var ~ probability_metric + Prior_RWD + Subject ,plotting_data,mean)
      a  = aggregate(plot_var ~ probability_metric + Prior_RWD ,a1,mean)
      b  = aggregate(plot_var ~ probability_metric + Prior_RWD ,a1,sd)/sqrt(max(a1$Subject))#/sqrt(length(plotting_data[,1]))
      c  = cbind(a,b$plot_var)
      colnames(c) = c('probability_metric','Prior_RWD','plot_var','plot_var_se')
      
      g<-ggplot(data = c,
                aes(x = factor(probability_metric),
                    y = plot_var,
                    color = factor(Prior_RWD),
                    group = factor(Prior_RWD)))+
        geom_point(data = c,
                   aes(x = factor(probability_metric),
                       y = plot_var,
                       color = factor(Prior_RWD),
                       group = factor(Prior_RWD)),
                   size = 5,
                   position = position_dodge(width = .5))+
        geom_line(data=c,
                  aes(x = factor(probability_metric),
                      y = plot_var,
                      color = factor(Prior_RWD),
                      group = factor(Prior_RWD)),
                  size = 1,
                  position = position_dodge(width = .5))+
        geom_errorbar(data=c,
                      aes(x = factor(probability_metric),
                          ymin = plot_var-plot_var_se,
                          ymax = plot_var+plot_var_se,
                          color = factor(Prior_RWD)),
                      size = 1,
                      width = 1,
                      position = position_dodge(width = .5))+
        # geom_hline(yintercept = mean(filter(plotting_data,probability_metric == 0)$plot_var),linetype='dashed',size=.5)+
        labs(x = 'Probability of Reward',
             y = var_lab,
             title = paste('LMER P-Values.\nProb Metric: ',
                           formatC(lme_test$test$pvalues[2],format="e",digits = 3),
                           ',\nPrior Rwd: ',
                           formatC(lme_test$test$pvalues[3],format="e",digits = 3),
                           ',\nInteraction: ',
                           formatC(lme_test$test$pvalues[4],format="e",digits = 3),
                           # , Slope: ',
                           # formatC(lme_test$test$coefficients[2],format="e",digits = 3),
                           # '\nOnly target 1/4: ',
                           # round(lme_test_t14$test$pvalues[2],digits = 4),
                           sep=''),
             color = 'Prior\nReward')#+theme(legend.position = 'none')
      if (prob_method == 'DiffPrior_Probability'){
        g <- g+labs(x = 'Probability difference from previous trial of reward')
      }
    }
  } else {
    plotting_data = data[,c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','NRWD_Run','Probability',prob_method,plot_var)]
    colnames(plotting_data) = c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','NRWD_Run','Probability','probability_metric', 'plot_var')
    
    ano_res2 = anova(lm(plot_var ~ Target + probability_metric + Target*probability_metric + (1|Subject), data = plotting_data))
    
    lme_test = cftest(lmer(plot_var ~ probability_metric + (1|Subject), data = plotting_data))
    lme_test_t14 = cftest(lmer(plot_var ~ probability_metric + (1|Subject),
                                data = rbind(filter(plotting_data,Probability==1),
                                             filter(plotting_data,Probability==0))))
    
    plotting_data2 = aggregate(plot_var ~ Subject + Target + Probability,plotting_data,mean)
    ano_res = anova(lm(plot_var ~ Probability + (1|Subject), data = plotting_data2))
    ano14 = anova(lm(plot_var ~ Probability + (1|Subject),
                            data = rbind(filter(plotting_data2,Probability==1),
                                         filter(plotting_data2,Probability==0))))
    
    
    t_test_data = filter(aggregate(plot_var ~ Subject + Probability,plotting_data,mean), Probability == 0 | Probability == 1)
    t_test = t.test(t_test_data[t_test_data$Probability == 0,'plot_var'], t_test_data[t_test_data$Probability == 1,'plot_var'], paired = TRUE)
    
    if (plot_type == 'violin'){
      #====================== Violin Plot ================
      # Violin Plots
      a = aggregate(plot_var ~ probability_metric ,plotting_data,mean)
      b = aggregate(plot_var ~ probability_metric ,plotting_data,sd)#/sqrt(length(plotting_data[,1]))
      c = cbind(a,b$plot_var)
      colnames(c) = c('probability_metric','plot_var','plot_var_sd')
      
      g <- ggplot(data=plotting_data,
                  aes(x = factor(probability_metric),
                      y = plot_var))+
        geom_violin(aes(fill = factor(probability_metric)))+
        geom_point(data=aggregate(plot_var~probability_metric,plotting_data,mean),
                   aes(x = factor(probability_metric),
                       y = plot_var),
                   size = 5)+
        geom_line(data=aggregate(plot_var~probability_metric,plotting_data,mean),
                  aes(x = factor(probability_metric),
                      y = plot_var),
                  group = 1,
                  size = 1)+
        geom_errorbar(data=c,
                      aes(x = factor(probability_metric),
                          ymin = plot_var-plot_var_sd,
                          ymax = plot_var+plot_var_sd),
                      size = 1,
                      width = 0)+
        geom_hline(yintercept = mean(filter(plotting_data,probability_metric == 0)$plot_var),linetype='dashed',size=.5)+
        labs(x = 'Probability of Reward',
             y = var_lab)+
        theme(legend.position = 'none')
      if (titles == 'TRUE'){
        g <- g+ labs(title = paste('LMER P-Value: ',
                           formatC(lme_test$test$pvalues[2],format="e",digits = 3),
                           ', Slope: ',
                           formatC(lme_test$test$coefficients[2],format="e",digits = 3),
                           '\nOnly Target 1/4: ',
                           round(lme_test_t14$test$pvalues[2],digits = 4),
                           sep=''))
      }
    } else if (plot_type == 'nv') {
      
      # Non-Violin Plot
      a1 = aggregate(plot_var ~ probability_metric + Subject,plotting_data,mean)
      a  = aggregate(plot_var ~ probability_metric ,a1,mean)
      b  = aggregate(plot_var ~ probability_metric ,a1,sd)/sqrt(max(a1$Subject))#/sqrt(length(plotting_data[,1]))
      c  = cbind(a,b$plot_var)
      colnames(c) = c('probability_metric','plot_var','plot_var_se')
      
      g <- ggplot(data=plotting_data,
                   aes(x = factor(probability_metric),
                       y = plot_var))+
        geom_point(data=aggregate(plot_var~probability_metric,plotting_data,mean),
                   aes(x = factor(probability_metric),
                       y = plot_var),
                   size = 5)+
        geom_line(data=aggregate(plot_var~probability_metric,plotting_data,mean),
                  aes(x = factor(probability_metric),
                      y = plot_var),
                  group = 1,
                  size = 1)+
        geom_errorbar(data=c,
                      aes(x = factor(probability_metric),
                          ymin = plot_var-plot_var_se,
                          ymax = plot_var+plot_var_se),
                      size = 1,
                      width = 0)+
        geom_hline(yintercept = mean(filter(plotting_data,probability_metric == 0)$plot_var),linetype='dashed',size=.5)+
        labs(x = 'Probability of Reward',
             y = var_lab)+
        theme(legend.position = 'none')
      if (titles == 'TRUE'){
        g <- g+ labs(title = paste('LMER P-Value: ',
                           formatC(lme_test$test$pvalues[2],format="e",digits = 3),
                           ', Slope: ',
                           formatC(lme_test$test$coefficients[2],format="e",digits = 3),
                           '\nOnly Target 1/4: ',
                           round(lme_test_t14$test$pvalues[2],digits = 4),
                           sep=''))
      }
      if (title_lab != 'Null'){
        g <- g+labs(title = title_lab)
      }
    }
  }
  if (prob_method == 'diff_prob'){
    g <- g+labs(x = 'Probability difference (P(t)-P(t-1))')
  }
  
  ret_list <- list('lm' = lme_test,'plot' = g)
  if (exists('lme_test_t14')){
    ret_list[['lm14']] = lme_test_t14
  }
  if (exists('ano14')){
    ret_list[['ano14']] = ano14
  }
  if (exists('t_test')){
    ret_list[['t_test']] = t_test
  }
  if (exists('t_test0')){
    ret_list[['t_test0']] = t_test0
  }
  if (exists('t_test1')){
    ret_list[['t_test1']] = t_test1
  }
  if (exists('lme_test_Prior1')){
    ret_list[['lme_test_Prior1']] = lme_test_Prior1
  }
  if (exists('lme_test_Prior0')){
    ret_list[['lme_test_Prior0']] = lme_test_Prior0
  }
  
  return(ret_list)
}

trial_plotting <- function(data,
                           plot_var,
                           var_lab,
                           variable,
                           title_lab = 'Null',
                           titles = 'Null'){
  
  
  plotting_data = data[,c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability',plot_var)]
  colnames(plotting_data) = c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability', 'plot_var')
  
  lm = cftest(lmer(plot_var ~ Trial + (1|Subject),data = plotting_data))
  
  trial_p_val <- lm$test$pvalues[2]
  trial_slope <- lm$coef[2]
  if (trial_p_val<0.05){
    yesno = 'WAS'
    if (trial_slope<0.05){
      slope = ' INCREASED'
    } else {
      slope = ' DECREASED'
    }
  } else {
    yesno = 'WAS NOT'
    slope = 'DID NOT CHANGE'
  }
  trial_slope = formatC(trial_slope, digits = 3, format='e')
  trial_p_val = formatC(trial_p_val, digits = 3, format='e')
  trial_str = paste('Over the course of the experiment, ',variable,slope,' with each subsequent trial. This was tested using an LMER of the form: ',variable,' = B*Trial + (1|Subject). We found B = ',trial_slope,' and a p-value = ',trial_p_val,', and an intercept of ',formatC(lm$coef[1], digits = 3, format='e'),sep='')
  
  g <- ggplot()+
    geom_point(data = plotting_data,
               aes(x = Trial,
                   y = plot_var,
                   color = factor(Subject)),
               alpha = 0.2,
               shape = 16)+
    geom_smooth(data = plotting_data,
               aes(x = Trial,
                   y = plot_var,
                   color = factor(Subject)))+
    labs(x = 'Trial',
         y = var_lab,
         color = 'Subject')
  
  
  
  ret_list = list('plot' = g, 'lm' = lm, 'trial_str' = trial_str)
  
}


# table_func <- function(data, variable){
#   eval(parse(text = paste('data$table_var = data$',variable,sep='')))
#   tab = matrix(,nrow=4,ncol=7)
#   for (s in c(1:7)){
#     m_count = 0
#     for (mass in c(2.44,4.830,7.13,11.69)){
#       m_count = m_count + 1
#       avg = round(mean(filter(data,speed == s, effmass == mass)$table_var),4)
#       se = round(sd(filter(data,speed == s, effmass == mass)$table_var)/sqrt(length(filter(data,speed == s, effmass == mass)$table_var)),4)
#       tab[m_count,s] = paste(avg,"±",se,sep=' ')
#     }
#   }
#   colnames(tab) = c('Speed = 1','Speed = 2','Speed = 3','Speed = 4','Speed = 5','Speed = 6','Speed = 7')
#   rownames(tab) = c('2.73 kg','4.83 kg','7.13 kg','11.69 kg')
#   return(tab)
# }

pvalue_table_func <- function(data, plot_var, prob_metric, Prior_RWD, targets = 'all'){
  
  if (Prior_RWD != 'Prior_RWD'){
    plotting_data = data[,c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','NRWD_Run','Probability',prob_metric,plot_var)]
    colnames(plotting_data) = c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','NRWD_Run','Probability','probability_metric', 'plot_var')
    
    lme_test = cftest(lmer(plot_var ~ probability_metric + (1|Subject), data = plotting_data))
    lme_test_t14 = cftest(lmer(plot_var ~ probability_metric + (1|Subject),
                                data = rbind(filter(plotting_data,Probability==1),
                                             filter(plotting_data,Probability==0))))
    
    anova_test = anova(lm(plot_var ~ probability_metric + (1|Subject), 
                          data = aggregate(plot_var~probability_metric + Subject, 
                                           data = rbind(filter(plotting_data, Probability==1),
                                                        filter(plotting_data, Probability==0)),
                                           mean)))
    
    lm_table <- rbind(c(formatC(lme_test$test$pvalues[2],format="e",digits = 3),
                        paste(formatC(lme_test$test$coefficients[2],format="e",digits = 3),'±',formatC(lme_test$test$sigma[2],format="e",digits = 3)),
                        formatC(lme_test$test$coefficients[1],format="e",digits = 3)),
                      c(formatC(lme_test_t14$test$pvalues[2],format="e",digits = 3),
                        paste(formatC(lme_test_t14$test$coefficients[2],format="e",digits = 3),'±',formatC(lme_test_t14$test$sigma[2],format="e",digits = 3)),
                        formatC(lme_test_t14$test$coefficients[1],format="e",digits = 3)),
                      c(formatC(anova_test$`Pr(>F)`[1],format='e',digits = 3),
                        paste('F val: ',formatC(anova_test$`F value`[1],format='e',digits = 3),sep=''),
                        ''))
    rownames(lm_table) <- c('All Target LMER','Target 1/4 LMER','Target 1/4 ANOVA')
    colnames(lm_table) <- c('P-Value','Slope','Intercept')
    return(lm_table)
    
  } else {
    
    plotting_data = data[,c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability',prob_metric,plot_var)]
    colnames(plotting_data) = c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability','probability_metric', 'plot_var')
    
    lme_test <- cftest(lmer(plot_var ~ probability_metric*Prior_RWD + (1|Subject), data = plotting_data))
    lme_test_t14 <- cftest(lmer(plot_var ~ probability_metric*Prior_RWD + (1|Subject), 
                                data = rbind(filter(plotting_data,probability_metric==1),
                                             filter(plotting_data,probability_metric==0))))
    
    anova_test = anova(lm(plot_var ~ probability_metric + (1|Subject), 
                          data = aggregate(plot_var~probability_metric + Subject, 
                                           data = rbind(filter(plotting_data, Probability==1),
                                                        filter(plotting_data, Probability==0)),
                                           mean)))
    
      
    lme_test_Prior0 <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), 
                                   data = filter(plotting_data,Prior_RWD==0)))
    lme_test_Prior1 <- cftest(lmer(plot_var ~ probability_metric + (1|Subject), 
                                   data = filter(plotting_data,Prior_RWD==1)))
    
    lm_table <- rbind(c(formatC(lme_test$test$pvalues[1],format="e",digits = 3),
                        paste(formatC(lme_test$test$coefficients[1],format="e",digits = 3),'±',formatC(lme_test$test$sigma[1],format="e",digits = 3))),
                      c(formatC(lme_test$test$pvalues[2],format="e",digits = 3),
                        paste(formatC(lme_test$test$coefficients[2],format="e",digits = 3),'±',formatC(lme_test$test$sigma[2],format="e",digits = 3))),
                      c(formatC(lme_test$test$pvalues[3],format="e",digits = 3),
                        paste(formatC(lme_test$test$coefficients[3],format="e",digits = 3),'±',formatC(lme_test$test$sigma[3],format="e",digits = 3))),
                      c(formatC(lme_test$test$pvalues[4],format="e",digits = 3),
                        paste(formatC(lme_test$test$coefficients[4],format="e",digits = 3),'±',formatC(lme_test$test$sigma[4],format="e",digits = 3))),
                      c('',''),
                      c(formatC(lme_test_Prior1$test$pvalues[2],format="e",digits = 3),
                        paste(formatC(lme_test_Prior1$test$coefficients[2],format="e",digits = 3),'±',formatC(lme_test_Prior1$test$sigma[2],format="e",digits = 3))),
                      c(formatC(lme_test_Prior0$test$pvalues[2],format="e",digits = 3),
                        paste(formatC(lme_test_Prior0$test$coefficients[2],format="e",digits = 3),'±',formatC(lme_test_Prior0$test$sigma[2],format="e",digits = 3))))
    rownames(lm_table) <- c('Intercept','Prob Metric','Prior RWD','Interaction','','Lm Prior == 1 Prob Effect','LM Prior == 0 Prob Effect')
    colnames(lm_table) <- c('P-Value','Slope')
    
    lm14_table <- rbind(c(formatC(lme_test_t14$test$pvalues[1],format="e",digits = 3),
                          paste(formatC(lme_test_t14$test$coefficients[1],format="e",digits = 3),'±',formatC(lme_test_t14$test$sigma[1],format="e",digits = 3))),
                        c(formatC(lme_test_t14$test$pvalues[2],format="e",digits = 3),
                          paste(formatC(lme_test_t14$test$coefficients[2],format="e",digits = 3),'±',formatC(lme_test_t14$test$sigma[2],format="e",digits = 3))),
                        c(formatC(lme_test_t14$test$pvalues[3],format="e",digits = 3),
                          paste(formatC(lme_test_t14$test$coefficients[3],format="e",digits = 3),'±',formatC(lme_test_t14$test$sigma[3],format="e",digits = 3))),
                        c(formatC(lme_test_t14$test$pvalues[4],format="e",digits = 3),
                          paste(formatC(lme_test_t14$test$coefficients[4],format="e",digits = 3),'±',formatC(lme_test_t14$test$sigma[4],format="e",digits = 3))))
    rownames(lm14_table) <- c('Intercept','Prob Metric','Prior RWD','Interaction')
    colnames(lm14_table) <- c('P-Value','Slope')
    if (targets == 'all'){
      return(lm_table)
    } else {
      return(lm14_table)
    }
  }
}


ttest_table_func <- function(data, plot_var, prob_metric, Prior_RWD, targets = 'all'){
  
  plotting_data = data[,c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability',prob_metric,plot_var)]
  colnames(plotting_data) = c('Subject','Trial','Trial_in_Block','Target','Target_num','Block','RWD','Prior_RWD','NRWD_Run','Probability','probability_metric', 'plot_var')
  
  lme_test = cftest(lmer(plot_var ~ probability_metric + (1|Subject), data = plotting_data))
  lme_test_t14 = cftest(lmer(plot_var ~ probability_metric + (1|Subject),
                              data = rbind(filter(plotting_data,Probability==1),
                                           filter(plotting_data,Probability==0))))
  
  
  anova_test = anova(lm(plot_var ~ probability_metric + (1|Subject), 
                        data = aggregate(plot_var~probability_metric + Subject, 
                                         data = rbind(filter(plotting_data, Probability==1),
                                                      filter(plotting_data, Probability==0)),
                                         mean)))
  
  df_subj = aggregate(plot_var ~ Prior_RWD + Subject, plotting_data, mean)
  df2_mean = aggregate(plot_var ~ Prior_RWD, df_subj, mean)
  df2_sd   = aggregate(plot_var ~ Prior_RWD, df_subj, sd)/sqrt(max(df_subj$Subject))
  df2 = cbind(df2_mean,df2_sd$plot_var)
  colnames(df2) <- c('Prior_RWD','plot_var','plot_var_se')
  
  lme_test = cftest(lmer(plot_var ~ Prior_RWD + (1|Subject), df_subj))
  ano14 = anova(lm(plot_var ~ Prior_RWD+(1|Subject), df_subj))
  t_test = t.test(df_subj[df_subj$Prior_RWD == 0,'plot_var'], df_subj[df_subj$Prior_RWD == 1,'plot_var'], paired = TRUE)
  t_test0 = t.test(df_subj[df_subj$Prior_RWD == 0,'plot_var'])
  t_test1 = t.test(df_subj[df_subj$Prior_RWD == 1,'plot_var'])
  
  lm_table <- rbind(c(formatC(t_test$p.value,format="e",digits = 3)),
                    c(formatC(t_test1$p.value,format="e",digits = 3)),
                    c(formatC(t_test0$p.value,format="e",digits = 3)))
  rownames(lm_table) <- c('T-test','T-Test Prior==1','T-Test Prior==0')
  colnames(lm_table) <- c('P-Value')
  return(lm_table)
}

filt_data <- non_famil_data
plots <- list()


prob_str_gen <- function(p_val, slope, variable){
  if (p_val<0.05){
    yesno = 'WAS'
  } else {
    yesno = 'WAS NOT'
  }
  p_val = formatC(p_val,format='e',digits =3)
  slope = formatC(slope,format='e',digits =3)
  str = paste(variable,' ',yesno,' significantly affected by probability of reward (p = ',p_val,', slope = ',slope,'). This was tested with an LMER with main outcome of probability and random effect of subject.',sep='')
  return(str)
}

t14_str_gen <- function(ttest_pval, aov_pval, variable){
  if (ttest_pval<0.05){
    yesno = 'WAS'
  } else {
    yesno = 'WAS NOT'
  }
  ttest_pval = formatC(ttest_pval,format='e',digits =3)
  str_ttest = paste('In a paired t test of subject averages, there ',yesno,' a significant difference between 0% and 100% reward conditions for ',variable,' (p = ',ttest_pval,'). .',sep='')
  
  if (aov_pval<0.05){
    yesno = 'WAS'
  } else {
    yesno = 'WAS NOT'
  }
  aov_pval = formatC(aov_pval,format='e',digits =3)
  str_aov = paste('In a ANOVA test of subject averages, there ',yesno,' a significant difference between 0% and 100% reward conditions for ',variable,' (p = ',aov_pval,'). .',sep='')
  return(paste(str_ttest,'\n',str_aov,sep='\n'))
}

priorbar_str_gen <- function(ttest_pval, aov_pval, variable){
  if (ttest_pval<0.05){
    yesno = 'WAS'
  } else {
    yesno = 'WAS NOT'
  }
  ttest_pval = formatC(ttest_pval,format='e',digits =3)
  str_ttest = paste('Using a paried t test, across subjects, the ',variable,' in trials following rewarded trials ',yesno,' statistically different than trials following nonrewarded tirlas (p = ',ttest_pval,')',sep='')
  # str_ttest = paste('In a paired t test of subject averages, there ',yesno,' a significant difference between 0% and 100% reward conditions for ',variable,' (p = ',ttest_pval,'). .',sep='')
  
  if (aov_pval<0.05){
    yesno = 'WAS'
  } else {
    yesno = 'WAS NOT'
  }
  aov_pval = formatC(aov_pval,format='e',digits =3)
  str_aov = paste('Using an ANOVA test, across subjects, the ',variable,' in trials following rewarded trials ',yesno,' statistically different than trials following nonrewarded tirlas (p = ',ttest_pval,')',sep='')
  return(paste(str_ttest,'\n',str_aov,sep='\n'))
}

prior_str_gen <- function(lm_pval_prob, lm_pval_prior, lm_pval_int, lme_pval_Prior0, lme_pval_Prior1, variable){
  if (lm_pval_prob<0.05){
    yesno_prob = 'WAS'
  } else {
    yesno_prob = 'WAS NOT'
  }
  if (lm_pval_prior<0.05){
    yesno_prior = 'WAS'
  } else {
    yesno_prior = 'WAS NOT'
  }
  if (lm_pval_int<0.05){
    yesno_int = 'DID'
  } else {
    yesno_int = 'DID NOT'
  }
  
  lm_pval_prob = formatC(lm_pval_prob,format='e',digits =3)
  lm_pval_prior = formatC(lm_pval_prior,format='e',digits =3)
  lm_pval_int = formatC(lm_pval_int,format='e',digits =3)
  str_lm = paste('In an interacation LMER of probability of reward and prior reward with subject as a random intercept effect, ',variable,' ',yesno_prob,' affected by probability of reward (p = ',lm_pval_prob,') and ',yesno_prior,' affected by prior reward (p = ',lm_pval_prior,'). An interaction of the two factors ',yesno_int,' affect ',variable,' (p = ',lm_pval_int,')',sep='')
  
  if (lme_pval_Prior0<0.05){
    yesno_prior0 = 'finding a significant slope'
  } else {
    yesno_prior0 = 'finding NO significant slope'
  }
  lme_pval_Prior0 = formatC(lme_pval_Prior0,format='e',digits =3)
  if (lme_pval_Prior1<0.05){
    yesno_prior1 = 'finding a significant slope'
  } else {
    yesno_prior1 = 'finding NO significant slope'
  }
  lme_pval_Prior1 = formatC(lme_pval_Prior1,format='e',digits =3)
  lme_pval_Prior0 = formatC(lme_pval_Prior0,format='e',digits =3)
  str_lm_split = paste('Dividing the data set into two groups (trials following reward and trials not following reward) resulted in ',yesno_prior1,' of probability (p = ',lme_pval_Prior1,') in trials that follow reward, but ',yesno_prior0,' (p = ',lme_pval_Prior0,') in trials that do not follow reward.',sep='')
  
  return(paste(str_lm,'\n',str_lm_split,sep='\n'))
}

priordiff_str_gen <- function(lm_pval_prob, lm_pval_prior, lm_pval_int, lme_pval_Prior0, lme_pval_Prior1, variable){
  if (lm_pval_prob<0.05){
    yesno_prob = 'WAS'
  } else {
    yesno_prob = 'WAS NOT'
  }
  if (lm_pval_prior<0.05){
    yesno_prior = 'WAS'
  } else {
    yesno_prior = 'WAS NOT'
  }
  if (lm_pval_int<0.05){
    yesno_int = 'DID'
  } else {
    yesno_int = 'DID NOT'
  }
  
  lm_pval_prob = formatC(lm_pval_prob,format='e',digits =3)
  lm_pval_prior = formatC(lm_pval_prior,format='e',digits =3)
  lm_pval_int = formatC(lm_pval_int,format='e',digits =3)
  str_lm = paste('In an interacation LMER of probability of reward and prior reward with subject as a random intercept effect, ',variable,' ',yesno_prob,' affected by probability of reward (p = ',lm_pval_prob,') and ',yesno_prior,' affected by prior reward (p = ',lm_pval_prior,'). An interaction of the two factors ',yesno_int,' affect ',variable,' (p = ',lm_pval_int,')',sep='')
  
  if (lme_pval_Prior0<0.05){
    yesno_prior0 = 'finding a significant slope'
  } else {
    yesno_prior0 = 'finding NO significant slope'
  }
  lme_pval_Prior0 = formatC(lme_pval_Prior0,format='e',digits =3)
  if (lme_pval_Prior1<0.05){
    yesno_prior1 = 'finding a significant slope'
  } else {
    yesno_prior1 = 'finding NO significant slope'
  }
  lme_pval_Prior1 = formatC(lme_pval_Prior1,format='e',digits =3)
  lme_pval_Prior0 = formatC(lme_pval_Prior0,format='e',digits =3)
  str_lm_split = paste('Dividing the data set into two groups (trials following reward and trials not following reward) resulted in ',yesno_prior1,' of probability (p = ',lme_pval_Prior1,') in trials that follow reward, but ',yesno_prior0,' (p = ',lme_pval_Prior0,') in trials that do not follow reward.',sep='')
  
  return(paste(str_lm,'\n',str_lm_split,sep='\n'))
}

priordiff_ttest_str_gen <- function(ttest, ttest1, ttest0, variable){
  if (ttest<0.05){
    yesno_ttest = 'WAS'
  } else {
    yesno_test = 'WAS NOT'
  }
  if (ttest1<0.05){
    yesno_ttest1 = 'WAS'
  } else {
    yesno_ttest1 = 'WAS NOT'
  }
  if (ttest0<0.05){
    yesno_ttest0 = 'DID'
  } else {
    yesno_ttest0 = 'DID NOT'
  }
  
  ttest = formatC(ttest,format='e',digits =3)
  ttest1 = formatC(ttest1,format='e',digits =3)
  ttest0 = formatC(ttest0,format='e',digits =3)
  
  str = paste('To further examine this effect of prior reward on ',variable,', the change in ',variable,' was determined from trial to trial. In the above graph Delta ',variable,' is the difference in ',variable,' of the current trial minus the previous trial (PV_(trial=n)-PV_(trial=n-1)). There ',yesno_ttest,' a statistical difference between trials following and not following reward (paired t-test of subject averages, p = ',ttest,'). ',variable,' ',yesno_ttest1,' significantly different following reward (t-test of subject averages vs a mean of 0, p = ',ttest1,') and ',variable,' ',yesno_ttest0,' significantly different following trials where they were not rewarded (t-test of subject averages vs a mean of 0, p = ',ttest0,').',sep='')
  
  return(str)
}

priordiffprob_str_gen <- function(lm_prob_prior, lm_prior1, lm_prior0, variable, prob_metric){
  
  lm_pval_prob = lm_prob_prior$test$pvalues[2]
  lm_pval_prior = lm_prob_prior$test$pvalues[3]
  lm_pval_int = lm_prob_prior$test$pvalues[4]
  
  lm_slope_prob = lm_prob_prior$coef[2]
  lm_slope_prior = lm_prob_prior$coef[3]
  lm_slope_int = lm_prob_prior$coef[4]
  
  if (lm_pval_prob<0.05){
    yesno_prob = 'WAS'
  } else {
    yesno_prob = 'WAS NOT'
  }
  if (lm_slope_prob > 0){
    slope_prob = 'INCREASE'
  } else {
    slope_prob = 'DECREASE'
  }
  
  
  if (lm_pval_prior<0.05){
    yesno_prior = 'DID'
  } else {
    yesno_prior = 'DID NOT'
  }
  if (lm_slope_prior > 0){
    slope_prior = 'INCREASE'
  } else {
    slope_prior = 'DECREASE'
  }
  
  
  if (lm_pval_int<0.05){
    yesno_int = 'WAS'
  } else {
    yesno_int = 'WAS NOT'
  }
  if (lm_slope_int > 0){
    slope_int = 'INCREASE'
  } else {
    slope_int = 'DECREASE'
  }
  
  lm_pval_prob = formatC(lm_pval_prob,format='e',digits =3)
  lm_pval_prior = formatC(lm_pval_prior,format='e',digits =3)
  lm_pval_int = formatC(lm_pval_int,format='e',digits =3)
  
  str_lm = paste('We then investigate the effect of the difference in probability from the previous trial to the current trial on ',variable,'. First we find that prior reward ',yesno_prior,' have an effect on ',variable,' change from previous trial (p = ',lm_pval_prior,'). This indicates that prior reward made subjects ',slope_prior,' their ',variable,'. An interaction between prior reward and probability difference ',yesno_int,' significant. We then split this linear model into two, one with prior reward and one with no prior reward.')
  
  lme_pval_prior0 = lm_prior0$test$pvalues[2]
  lme_pval_prior1 = lm_prior1$test$pvalues[2]
  
  lm_slope_prior0 = lm_prior0$coef[2]
  lm_slope_prior1 = lm_prior1$coef[2]
  
  if (lme_pval_prior0<0.05){
    yesno_prior0 = 'finding a significant slope'
  } else {
    yesno_prior0 = 'finding NO significant slope'
  }
  if (lm_slope_prior0 > 0){
    slope_prob = 'INCREASE'
  } else {
    slope_prob = 'DECREASE'
  }
  
  if (lme_pval_prior1<0.05){
    yesno_prior1 = 'finding a significant slope'
  } else {
    yesno_prior1 = 'finding NO significant slope'
  }
  if (lm_slope_prior1 > 0){
    slope_prob = 'INCREASE'
  } else {
    slope_prob = 'DECREASE'
  }
  
  lme_pval_prior1 = formatC(lme_pval_prior1,format='e',digits =3)
  lme_pval_prior0 = formatC(lme_pval_prior0,format='e',digits =3)
  lm_slope_prior1 = formatC(lm_slope_prior1,format='e',digits =3)
  lm_slope_prior0 = formatC(lm_slope_prior0,format='e',digits =3)
  
  str_lm_split = paste('Dividing the data set into two groups (trials following reward and trials not following reward) resulted in ',yesno_prior1,' of probability (p = ',lme_pval_prior1,', slope = ',lm_slope_prior1,') in trials that follow reward, and ',yesno_prior0,' (p = ',lme_pval_prior0,', slope = ',lm_slope_prior0,') in trials that do not follow reward.',sep='')
  
  return(paste(str_lm,'\n',str_lm_split,sep='\n'))
}
```
# Peak Velocity
## Effect of Probability
```{r, echo = FALSE, warning = FALSE}
chunk_var = 'PeakV'
chunk_var_lab = 'Peak Velocity'

plots[[chunk_var]][['abs']] <- Prob_plotting(data= filt_data,
                                prob_method = 'Probability',
                                plot_var = chunk_var,
                                var_lab = paste(chunk_var_lab,' (m/s)',sep=''),
                                plot_type = 'nv',
                                title_lab = 'ABS',
                                Prior_RWD = '0')
plots[[chunk_var]][['Delta']] <- Prob_plotting(data= filt_data,
                                  prob_method = 'Probability',
                                  plot_var = paste('Delta',chunk_var,sep=''),
                                  var_lab = paste(chunk_var_lab,'Peak Velocity DELTA (m/s)',sep=''),
                                  plot_type = 'nv',
                                  title_lab = 'DELTA',
                                  Prior_RWD = '0')

cur_plot = plots[[chunk_var]][['abs']]
```

`r prob_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$coef[2],chunk_var_lab)`

```{r, echo = FALSE, warning = FALSE}
kable(pvalue_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'no'),
      caption = paste(chunk_var_lab,' P-Values for effect of Probability',sep=''))

plots[[chunk_var]][['Delta']][['plot']]

```

#### Comparison of 0% and 100% Reward

`r t14_str_gen(cur_plot$t_test$p.value,cur_plot$ano14[['Pr(>F)']][1],chunk_var_lab)`

## Effect of Trial

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Trial']] = trial_plotting(filt_data,'PeakV','peakpoop','peak velocity')

```

`r plots[[chunk_var]][['Trial']][['trial_str']]`

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[chunk_var]][['Trial']][['plot']]

```

## Peak Velocity Following Reward

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Prior_RWD_bar']] <- Prob_plotting(data= filt_data,
                                                  prob_method = 'Probability',
                                                  plot_var = chunk_var,
                                                  var_lab = paste(chunk_var_lab,' (m/s)',sep=''),
                                                  plot_type = 'bar',
                                                  title_lab = 'ABS',
                                                  Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[chunk_var]][['Prior_RWD_bar']]
```

`r priorbar_str_gen(cur_plot$t_test$p.value,cur_plot$ano14[['Pr(>F)']][1],chunk_var_lab)`

```{r, echo = FALSE, warning = FALSE}
kable(ttest_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var_lab,' P-Values for effect of Probability',sep=''))

plots[[chunk_var]][['Prior_RWD_bar']][['plot']]

```

```{r, echo = FALSE, warning = FALSE}

plots[[chunk_var]][['Prior_RWD']] <- Prob_plotting(data= filt_data,
                                                 prob_method = 'Probability',
                                                 plot_var = chunk_var,
                                                 var_lab = paste(chunk_var_lab,' (m/s)',sep=''),
                                                 plot_type = 'nv',
                                                 title_lab = 'ABS',
                                                 Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[chunk_var]][['Prior_RWD']]
```

`r prior_str_gen(cur_plot$lm$test$pvalues[2],cur_plot$lm$test$pvalues[3],cur_plot$lm$test$pvalues[4],cur_plot$lme_test_Prior0$test$pvalues[2],cur_plot$lme_test_Prior1$test$pvalues[2],chunk_var_lab)`

```{r, echo = FALSE, warning = FALSE}

kable(pvalue_table_func(filt_data,
                        plot_var = chunk_var,
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = 'Peak Velocity P-Values for effect of Probability')

plots[[chunk_var]][['Prior_RWD']][['plot']]

```

### Change in Peak Velocity from previous trial due to Reward
```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']] <- Prob_plotting(data= filt_data,
                                                     prob_method = 'Probability',
                                                     plot_var = paste('DiffPrior_',chunk_var,sep=''),
                                                     var_lab = 'Peak Velocity Diff Prior (m/s)',
                                                     plot_type = 'bar',
                                                     title_lab = 'Diff',
                                                     Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']]

kable(ttest_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var,' Diff Prior P-Values for effect of Probability',sep=''))

```


`r priordiff_ttest_str_gen(cur_plot$t_test$p.value,cur_plot$t_test1$p.value,cur_plot$t_test0$p.value,chunk_var_lab)`

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['Prior_RWD_bar']][['plot']]

```


### Interaction of Prior Reward and Change in Probability of Reward
```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']] <- Prob_plotting(data= filt_data,
                                                     prob_method = 'DiffPrior_Probability',
                                                     plot_var = paste('DiffPrior_',chunk_var,sep=''),
                                                     var_lab = 'Peak Velocity Diff Prior (m/s)',
                                                     plot_type = 'nv',
                                                     title_lab = 'Diff',
                                                     Prior_RWD = 'Prior_RWD')

cur_plot <- plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']]

kable(pvalue_table_func(filt_data,
                        plot_var = paste('DiffPrior_',chunk_var,sep=''),
                        prob_metric = 'DiffPrior_Probability',
                        Prior_RWD = 'Prior_RWD'),
      caption = paste(chunk_var,' Diff Prior P-Values for effect of Diff Probability',sep=''))

```
`r priordiffprob_str_gen(cur_plot$lm, cur_plot$lme_test_Prior1, cur_plot$lme_test_Prior0, chunk_var_lab, 'probability difference')`

```{r, echo = FALSE, warning = FALSE, message = FALSE}

plots[[paste(chunk_var,'_Diff',sep='')]][['DiffPrior_RWD']][['plot']]

```








<!-- ## No Prior RWD -->
<!-- ```{r peakvelocitytables, warning = FALSE, echo = FALSE} -->

<!-- chunk_var = 'PeakV' -->

<!-- kable(pvalue_table_func(filt_data, -->
<!--                         plot_var = chunk_var, -->
<!--                         prob_metric = 'Probability', -->
<!--                         Prior_RWD = 'no'), -->
<!--       caption = 'Peak Velocity P-Values for effect of Probability') -->
<!-- ``` -->

<!-- ```{r peakvelocityplot, warning = FALSE, echo = FALSE, fig.width = 12, fig.height = 6} -->

<!-- PeakV <- list() -->
<!-- PeakV[['abs']] <- Prob_plotting(data= filt_data, -->
<!--                                 prob_method = 'Probability', -->
<!--                                 plot_var = chunk_var, -->
<!--                                 var_lab = 'Peak Velocity (m/s)', -->
<!--                                 plot_type = 'nv', -->
<!--                                 title_lab = 'ABS', -->
<!--                                 Prior_RWD = '0') -->
<!-- PeakV[['Norm']] <- Prob_plotting(data= filt_data, -->
<!--                                  prob_method = 'Probability', -->
<!--                                  plot_var = paste('Norm',chunk_var,sep=''), -->
<!--                                  var_lab = 'Peak Velocity NORM (m/s)', -->
<!--                                  plot_type = 'nv', -->
<!--                                  title_lab = 'NORM', -->
<!--                                  Prior_RWD = '0') -->
<!-- PeakV[['Delta']] <- Prob_plotting(data= filt_data, -->
<!--                                   prob_method = 'Probability', -->
<!--                                   plot_var = paste('Delta',chunk_var,sep=''), -->
<!--                                   var_lab = 'Peak Velocity DELTA (m/s)', -->
<!--                                   plot_type = 'nv', -->
<!--                                   title_lab = 'DELTA', -->
<!--                                   Prior_RWD = '0') -->

<!-- plot_grid(PeakV[['abs']],PeakV[['Norm']],PeakV[['Delta']], nrow = 1) -->

<!-- ``` -->


<!-- ## WITH Prior RWD -->
<!-- ```{r peakvelocitytablesPriorRWD, warning = FALSE, echo = FALSE} -->
<!-- kable(pvalue_table_func(filt_data, -->
<!--                         plot_var = chunk_var, -->
<!--                         prob_metric = 'Probability', -->
<!--                         Prior_RWD = 'Prior_RWD'), -->
<!--       caption = 'Peak Velocity P-Values for effect of Probability') -->
<!-- ``` -->

<!-- ```{r peakvelocityplotPriorRWD, warning = FALSE, echo = FALSE, fig.width = 12, fig.height = 6} -->

<!-- PeakV <- list() -->
<!-- PeakV[['abs']] <- Prob_plotting(data= filt_data, -->
<!--                                 prob_method = 'Probability', -->
<!--                                 plot_var = chunk_var, -->
<!--                                 var_lab = 'Peak Velocity (m/s)', -->
<!--                                 plot_type = 'nv', -->
<!--                                 title_lab = 'ABS', -->
<!--                                 Prior_RWD = 'Prior_RWD') -->
<!-- PeakV[['Norm']] <- Prob_plotting(data= filt_data, -->
<!--                                  prob_method = 'Probability', -->
<!--                                  plot_var = paste('Norm',chunk_var,sep=''), -->
<!--                                  var_lab = 'Peak Velocity NORM (m/s)', -->
<!--                                  plot_type = 'nv', -->
<!--                                  title_lab = 'NORM', -->
<!--                                  Prior_RWD = 'Prior_RWD') -->
<!-- PeakV[['Delta']] <- Prob_plotting(data= filt_data, -->
<!--                                   prob_method = 'Probability', -->
<!--                                   plot_var = paste('Delta',chunk_var,sep=''), -->
<!--                                   var_lab = 'Peak Velocity DELTA (m/s)', -->
<!--                                   plot_type = 'nv', -->
<!--                                   title_lab = 'DELTA', -->
<!--                                   Prior_RWD = 'Prior_RWD') -->

<!-- plot_grid(PeakV[['abs']]+theme(legend.position = 'none'), -->
<!--           PeakV[['Norm']]+theme(legend.position = 'none'), -->
<!--           PeakV[['Delta']]+theme(legend.position = 'none'), -->
<!--           get_legend(PeakV[['Delta']]), -->
<!--           nrow = 1, -->
<!--           rel_widths = c(5,5,5,1)) -->

<!-- ``` -->

<!-- ## Difference Probability from prev trial -->
<!-- ```{r peakvelwithpriorprobdiff, warning = FALSE, echo = FALSE, message = FALSE, fig.width = 12, fig.height = 6} -->

<!-- kable(pvalue_table_func(filt_data, -->
<!--                         plot_var = chunk_var, -->
<!--                         prob_metric = "DiffPrior_Probability", -->
<!--                         Prior_RWD = 'Prior_RWD'), -->
<!--       caption = 'Peak Velocity P-Values for effect of Probability') -->

<!-- ``` -->


<!-- ```{r peakvelwithpriorprobdiffPriorRwd, warning = FALSE, echo = FALSE, message = FALSE, fig.width = 12, fig.height = 6} -->

<!-- PeakV <- list() -->
<!-- PeakV[['abs']] <- Prob_plotting(data= filt_data, -->
<!--                                 prob_method = "DiffPrior_Probability", -->
<!--                                 plot_var = chunk_var, -->
<!--                                 var_lab = 'Peak Velocity (m/s)', -->
<!--                                 plot_type = 'nv', -->
<!--                                 title_lab = 'ABS', -->
<!--                                 Prior_RWD = 'Prior_RWD')$plot+labs(x = 'Probability Difference from Previous Trial') -->
<!-- PeakV[['Norm']] <- Prob_plotting(data= filt_data, -->
<!--                                  prob_method = "DiffPrior_Probability", -->
<!--                                  plot_var = paste('Norm',chunk_var,sep=''), -->
<!--                                  var_lab = 'Peak Velocity NORM (m/s)', -->
<!--                                  plot_type = 'nv', -->
<!--                                  title_lab = 'NORM', -->
<!--                                  Prior_RWD = 'Prior_RWD')$plot+labs(x = 'Probability Difference from Previous Trial') -->
<!-- PeakV[['Delta']] <- Prob_plotting(data= filt_data, -->
<!--                                   prob_method = "DiffPrior_Probability", -->
<!--                                   plot_var = paste('Delta',chunk_var,sep=''), -->
<!--                                   var_lab = 'Peak Velocity DELTA (m/s)', -->
<!--                                   plot_type = 'nv', -->
<!--                                   title_lab = 'DELTA', -->
<!--                                   Prior_RWD = 'Prior_RWD')$plot+labs(x = 'Probability Difference from Previous Trial') -->

<!-- plot_grid(PeakV[['abs']]+theme(legend.position = 'none'), -->
<!--           PeakV[['Norm']]+theme(legend.position = 'none'), -->
<!--           PeakV[['Delta']]+theme(legend.position = 'none'), -->
<!--           get_legend(PeakV[['Delta']]), -->
<!--           nrow = 1, -->
<!--           rel_widths = c(5,5,5,1)) -->

<!-- ``` -->


<!-- ## Bar Plot Example -->
<!-- ```{r peakvelwithpriorbar, warning = FALSE, echo = FALSE, message = FALSE, fig.width = 4, fig.height = 4} -->

<!-- Prob_plotting(data= filt_data, -->
<!--               prob_method = "Probability", -->
<!--               plot_var = chunk_var, -->
<!--               var_lab = 'Peak Velocity (m/s)', -->
<!--               plot_type = 'bar', -->
<!--               title_lab = 'ABS', -->
<!--               Prior_RWD = 'Prior_RWD')$plot -->

<!-- ``` -->

<!-- ## Peak Velocity Difference from previous trial -->

<!-- ### No Prior RWD -->
<!-- ```{r peakveldifftables, warning = FALSE, echo = FALSE} -->

<!-- chunk_var = 'PeakV' -->

<!-- kable(pvalue_table_func(filt_data, -->
<!--                         plot_var = paste('DiffPrior_',chunk_var,sep=''), -->
<!--                         prob_metric = 'Probability', -->
<!--                         Prior_RWD = 'no'), -->
<!--       caption = 'Peak Velocity Difference from previous Trial P-Values for effect of Probability') -->
<!-- ``` -->

<!-- ```{r peakveldiffplot, warning = FALSE, echo = FALSE, fig.width = 12, fig.height = 6} -->

<!-- PeakV <- list() -->
<!-- PeakV[['abs']] <- Prob_plotting(data= filt_data, -->
<!--                                 prob_method = 'Probability', -->
<!--                                 plot_var = paste('DiffPrior_',chunk_var,sep=''), -->
<!--                                 var_lab = 'Peak Velocity, diff from perv trial (m/s)', -->
<!--                                 plot_type = 'nv', -->
<!--                                 title_lab = 'ABS', -->
<!--                                 Prior_RWD = '0') -->
<!-- PeakV[['Norm']] <- Prob_plotting(data= filt_data, -->
<!--                                  prob_method = 'Probability', -->
<!--                                  plot_var = paste('DiffPrior_Norm',chunk_var,sep=''), -->
<!--                                  var_lab = 'Peak Velocity NORM, diff from perv trial (m/s)', -->
<!--                                  plot_type = 'nv', -->
<!--                                  title_lab = 'NORM', -->
<!--                                  Prior_RWD = '0') -->
<!-- PeakV[['Delta']] <- Prob_plotting(data= filt_data, -->
<!--                                   prob_method = 'Probability', -->
<!--                                   plot_var = paste('DiffPrior_Delta',chunk_var,sep=''), -->
<!--                                   var_lab = 'Peak Velocity DELTA, diff from perv trial (m/s)', -->
<!--                                   plot_type = 'nv', -->
<!--                                   title_lab = 'DELTA', -->
<!--                                   Prior_RWD = '0') -->

<!-- plot_grid(PeakV[['abs']],PeakV[['Norm']],PeakV[['Delta']], nrow = 1) -->

<!-- ``` -->


<!-- ### WITH Prior RWD -->
<!-- ```{r peakveldifftablesPriorRWD, warning = FALSE, echo = FALSE} -->
<!-- kable(pvalue_table_func(filt_data, -->
<!--                         plot_var = paste('DiffPrior_',chunk_var,sep=''), -->
<!--                         prob_metric = 'Probability', -->
<!--                         Prior_RWD = 'Prior_RWD'), -->
<!--       caption = 'Peak Velocity, diff from perv trial, P-Values for effect of Probability') -->
<!-- ``` -->

<!-- ```{r peakveldiffplotPriorRWD, warning = FALSE, echo = FALSE, fig.width = 12, fig.height = 6} -->

<!-- PeakV <- list() -->
<!-- PeakV[['abs']] <- Prob_plotting(data= filt_data, -->
<!--                                 prob_method = 'Probability', -->
<!--                                 plot_var = paste('DiffPrior_',chunk_var,sep=''), -->
<!--                                 var_lab = 'Peak Velocity, diff from perv trial (m/s)', -->
<!--                                 plot_type = 'nv', -->
<!--                                 title_lab = 'ABS', -->
<!--                                 Prior_RWD = 'Prior_RWD') -->
<!-- PeakV[['Norm']] <- Prob_plotting(data= filt_data, -->
<!--                                  prob_method = 'Probability', -->
<!--                                  plot_var = paste('DiffPrior_Norm',chunk_var,sep=''), -->
<!--                                  var_lab = 'Peak Velocity NORM, diff from perv trial (m/s)', -->
<!--                                  plot_type = 'nv', -->
<!--                                  title_lab = 'NORM', -->
<!--                                  Prior_RWD = 'Prior_RWD') -->
<!-- PeakV[['Delta']] <- Prob_plotting(data= filt_data, -->
<!--                                   prob_method = 'Probability', -->
<!--                                   plot_var = paste('DiffPrior_Delta',chunk_var,sep=''), -->
<!--                                   var_lab = 'Peak Velocity DELTA, diff from perv trial (m/s)', -->
<!--                                   plot_type = 'nv', -->
<!--                                   title_lab = 'DELTA', -->
<!--                                   Prior_RWD = 'Prior_RWD') -->

<!-- plot_grid(PeakV[['abs']]+theme(legend.position = 'none'), -->
<!--           PeakV[['Norm']]+theme(legend.position = 'none'), -->
<!--           PeakV[['Delta']]+theme(legend.position = 'none'), -->
<!--           get_legend(PeakV[['Delta']]), -->
<!--           nrow = 1, -->
<!--           rel_widths = c(5,5,5,1)) -->

<!-- ``` -->

<!-- ### Difference Probability from prev trial -->
<!-- ```{r peakveldiffwithpriorprobdiff, warning = FALSE, echo = FALSE, message = FALSE, fig.width = 12, fig.height = 6} -->

<!-- kable(pvalue_table_func(filt_data, -->
<!--                         plot_var = paste('DiffPrior_',chunk_var,sep=''), -->
<!--                         prob_metric = "DiffPrior_Probability", -->
<!--                         Prior_RWD = 'Prior_RWD'), -->
<!--       caption = 'Peak Velocity, diff from perv trial, P-Values for effect of Probability') -->

<!-- ``` -->


<!-- ```{r peakveldiffwithpriorprobdiffPriorRwd, warning = FALSE, echo = FALSE, message = FALSE, fig.width = 12, fig.height = 6} -->

<!-- PeakV <- list() -->
<!-- PeakV[['abs']] <- Prob_plotting(data= filt_data, -->
<!--                                 prob_method = "DiffPrior_Probability", -->
<!--                                 plot_var = paste('DiffPrior_',chunk_var,sep=''), -->
<!--                                 var_lab = 'Peak Velocity, diff from perv trial (m/s)', -->
<!--                                 plot_type = 'nv', -->
<!--                                 title_lab = 'ABS', -->
<!--                                 Prior_RWD = 'Prior_RWD')+labs(x = 'Probability Difference from Previous Trial') -->
<!-- PeakV[['Norm']] <- Prob_plotting(data= filt_data, -->
<!--                                  prob_method = "DiffPrior_Probability", -->
<!--                                  plot_var = paste('DiffPrior_Norm',chunk_var,sep=''), -->
<!--                                  var_lab = 'Peak Velocity NORM, diff from perv trial (m/s)', -->
<!--                                  plot_type = 'nv', -->
<!--                                  title_lab = 'NORM', -->
<!--                                  Prior_RWD = 'Prior_RWD')+labs(x = 'Probability Difference from Previous Trial') -->
<!-- PeakV[['Delta']] <- Prob_plotting(data= filt_data, -->
<!--                                   prob_method = "DiffPrior_Probability", -->
<!--                                   plot_var = paste('DiffPrior_Delta',chunk_var,sep=''), -->
<!--                                   var_lab = 'Peak Velocity DELTA, diff from perv trial (m/s)', -->
<!--                                   plot_type = 'nv', -->
<!--                                   title_lab = 'DELTA', -->
<!--                                   Prior_RWD = 'Prior_RWD')+labs(x = 'Probability Difference from Previous Trial') -->

<!-- plot_grid(PeakV[['abs']]+theme(legend.position = 'none'), -->
<!--           PeakV[['Norm']]+theme(legend.position = 'none'), -->
<!--           PeakV[['Delta']]+theme(legend.position = 'none'), -->
<!--           get_legend(PeakV[['Delta']]), -->
<!--           nrow = 1, -->
<!--           rel_widths = c(5,5,5,1)) -->

<!-- ``` -->